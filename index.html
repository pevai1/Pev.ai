<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Pev.ai</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&family=Fraunces:ital,wght@0,300;1,300&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// Load jsPDF non-blocking
(function() {
  var s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
  s.async = true;
  document.head.appendChild(s);
})();
</script>
<style>
:root {
  --black:#000;--black2:#1c1c1e;--black3:#2c2c2e;--black4:#3a3a3c;--black5:#48484a;
  --gray1:#333;--gray2:#555;--gray3:#888;--gray4:#aaa;--gray5:#ccc;
  --white2:#eee;--white:#fff;--border:#1f1f1f;--border2:#2e2e2e;
  --red:#e53e3e;--green:#38a169;
}
[data-theme="light"] {
  --black:#fff;--black2:#f8f8f8;--black3:#f0f0f0;--black4:#e8e8e8;--black5:#ddd;
  --gray1:#ccc;--gray2:#aaa;--gray3:#777;--gray4:#555;--gray5:#333;
  --white2:#111;--white:#000;--border:#e0e0e0;--border2:#d0d0d0;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif,system-ui,-apple-system,sans-serif;background:#1c1c1e;color:#fff;height:100vh;overflow:hidden;transition:background .2s,color .2s;}

/* ── AUTH ─── */
#authScreen{position:fixed;inset:0;z-index:100;background:#f5f5f0;display:flex;flex-direction:column;min-height:100vh;min-height:-webkit-fill-available;}

/* Landing */
.auth-landing{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:40px 32px;position:relative;overflow:hidden;min-height:200px;}
.auth-landing-bg{position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 50% 30%,rgba(0,0,0,.04) 0%,transparent 70%);}

/* Minimalist grid lines decoration */
.auth-landing::before {
  content:'';
  position:absolute;
  inset:0;
  background-image:linear-gradient(rgba(0,0,0,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,0,0,.04) 1px,transparent 1px);
  background-size:40px 40px;
  pointer-events:none;
}

.auth-brand{display:flex;flex-direction:column;align-items:center;gap:16px;z-index:1;}
.auth-logomark{width:72px;height:72px;border:1.5px solid rgba(0,0,0,.15);border-radius:20px;display:flex;align-items:center;justify-content:center;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.08);}
.auth-appname{font-family:'Fraunces',serif;font-size:32px;font-weight:300;color:#111;letter-spacing:-.5px;}
.auth-appname em{font-style:italic;opacity:.4;color:#111;}
.auth-tagline{font-size:14px;color:rgba(0,0,0,.4);font-family:'DM Sans',sans-serif;text-align:center;line-height:1.6;max-width:260px;}

/* Bottom sheet */
.auth-bottom{background:#fff;border-radius:28px 28px 0 0;padding:28px 24px 40px;display:flex;flex-direction:column;gap:12px;border-top:1px solid rgba(0,0,0,.06);box-shadow:0 -4px 30px rgba(0,0,0,.06);}
.auth-bottom-handle{width:36px;height:4px;background:rgba(0,0,0,.1);border-radius:2px;margin:0 auto 20px;}

/* Buttons */


.auth-btn-google{padding:15px 20px;border-radius:14px;border:1px solid rgba(0,0,0,.1);background:rgba(0,0,0,.04);color:#111;font-family:'DM Sans',sans-serif;font-weight:600;font-size:15px;cursor:pointer;width:100%;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .2s;}
.auth-btn-google:hover{background:rgba(0,0,0,.08);}
.auth-btn-register{padding:15px;border-radius:14px;border:none;background:#111;color:#fff;font-family:'DM Sans',sans-serif;font-weight:700;font-size:15px;cursor:pointer;width:100%;transition:all .2s;}
.auth-btn-register:hover{background:#333;}
.auth-btn-login{padding:15px;border-radius:14px;border:1px solid rgba(0,0,0,.12);background:transparent;color:rgba(0,0,0,.6);font-family:'DM Sans',sans-serif;font-weight:600;font-size:15px;cursor:pointer;width:100%;transition:all .2s;}
.auth-btn-login:hover{border-color:rgba(0,0,0,.3);color:#111;}

/* Modal auth panels */
.auth-modal-overlay{position:fixed;inset:0;z-index:200;display:none;align-items:flex-end;justify-content:center;}
.auth-modal-overlay.open{display:flex;}
.auth-modal-bg{position:absolute;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);}
.auth-modal-sheet{position:relative;width:100%;max-width:480px;background:#fff;border-radius:24px 24px 0 0;border-top:1px solid rgba(0,0,0,.06);padding:20px 24px 44px;z-index:1;animation:sheetUp .25s ease;}
@keyframes sheetUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:none}}
.auth-modal-handle{width:36px;height:4px;background:rgba(0,0,0,.1);border-radius:2px;margin:0 auto 22px;}
.auth-modal-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:#111;margin-bottom:20px;}
.auth-field{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
.auth-field-label{font-size:11px;font-weight:600;color:rgba(0,0,0,.4);letter-spacing:1.5px;text-transform:uppercase;font-family:'DM Mono',monospace;}
.auth-field-input{padding:14px 16px;border-radius:12px;border:1px solid rgba(0,0,0,.1);background:rgba(0,0,0,.03);color:#111;font-family:'DM Sans',sans-serif;font-size:15px;outline:none;transition:border-color .15s;width:100%;}
.auth-field-input:focus{border-color:rgba(0,0,0,.3);}
.auth-field-input::placeholder{color:rgba(0,0,0,.25);}
.auth-submit-btn{padding:15px;border-radius:14px;border:none;background:#111;color:#fff;font-family:'DM Sans',sans-serif;font-weight:700;font-size:15px;cursor:pointer;width:100%;margin-top:6px;transition:all .2s;}
.auth-submit-btn:hover{background:#333;}
.auth-err-msg{font-size:12px;color:#c53030;font-family:'DM Mono',monospace;text-align:center;min-height:18px;margin-top:2px;}
.auth-divider{display:flex;align-items:center;gap:10px;margin:6px 0;}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:rgba(0,0,0,.08);}
.auth-divider span{font-size:11px;color:rgba(0,0,0,.25);font-family:'DM Mono',monospace;}

/* Owner hidden entry */
.auth-owner-hint{font-size:10px;color:rgba(0,0,0,.15);font-family:'DM Mono',monospace;text-align:center;margin-top:4px;cursor:default;user-select:none;}

@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.auth-input{padding:12px 14px;border-radius:10px;border:1px solid var(--border2);background:var(--black3);color:var(--white);font-family:'DM Mono',monospace;font-size:13px;outline:none;transition:border-color .15s;width:100%;}
.auth-input:focus{border-color:var(--gray2);}
.auth-input::placeholder{color:var(--gray2);}
.auth-btn{padding:12px;border-radius:10px;border:none;background:var(--white);color:var(--black);font-family:'DM Sans',sans-serif;font-weight:700;font-size:14px;cursor:pointer;transition:background .15s;width:100%;}
.auth-btn:hover{background:var(--gray5);}
.field-wrap{display:flex;flex-direction:column;gap:6px;}
.field-label2{font-size:11px;font-weight:600;color:var(--gray3);letter-spacing:1.5px;text-transform:uppercase;font-family:'DM Mono',monospace;}
.auth-err{font-size:12px;color:#fc8181;font-family:'DM Mono',monospace;text-align:center;min-height:18px;}
.auth-note{font-size:11px;color:var(--gray2);font-family:'DM Mono',monospace;text-align:center;line-height:1.7;}
.divider{display:flex;align-items:center;gap:10px;margin:4px 0;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border2);}
.divider span{font-size:11px;color:var(--gray2);font-family:'DM Mono',monospace;}

/* ── APP LAYOUT ─── */
#appScreen{display:none;height:100vh;}
.app{display:flex;height:100vh;}

/* ── SIDEBAR ─── */
.sidebar{width:240px;background:#0a0a0a;border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;transition:width .25s ease;overflow:hidden;}
.sidebar.collapsed{width:0;}
.sb-top{padding:16px 14px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.sb-logo{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}
.sb-logomark{width:30px;height:30px;border:1.5px solid rgba(255,255,255,.5);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sb-logotext{display:flex;flex-direction:column;gap:0px;}
.sb-logomain{font-family:'Fraunces',serif;font-size:15px;font-weight:300;letter-spacing:-.3px;color:var(--white);line-height:1;}
.sb-logomain em{font-style:italic;opacity:.55;}
.sb-logosub{font-family:'Space Mono',monospace;font-size:7px;letter-spacing:2px;text-transform:uppercase;color:var(--gray2);margin-top:2px;}
.sb-toggle{width:28px;height:28px;border-radius:7px;border:1px solid var(--border2);background:transparent;color:var(--gray3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;transition:all .15s;}
.sb-toggle:hover{border-color:var(--gray2);color:var(--white);}

.sb-new{margin:10px 10px 6px;padding:11px 14px;border-radius:12px;border:1px solid var(--border2);background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--gray4);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:9px;width:calc(100% - 20px);}
.sb-new:hover{background:linear-gradient(135deg,rgba(255,255,255,.1),rgba(255,255,255,.04));color:var(--white);border-color:rgba(255,255,255,.2);box-shadow:0 2px 12px rgba(0,0,0,.3);}
.sb-new span:first-child{font-size:15px;opacity:.8;}

.sb-section{padding:8px 14px 4px;font-size:10px;font-weight:700;color:var(--gray2);letter-spacing:2px;text-transform:uppercase;font-family:'DM Mono',monospace;}

/* NAV - Modern */
.sb-nav{padding:6px 10px;display:flex;flex-direction:column;gap:2px;}
.nav-btn{width:100%;padding:13px 14px;border-radius:12px;border:none;background:transparent;color:var(--gray3);cursor:pointer;display:flex;align-items:center;gap:13px;font-size:14px;font-family:'DM Sans',sans-serif;font-weight:500;transition:all .18s;white-space:nowrap;text-align:left;position:relative;}
.nav-btn:hover{background:var(--black4);color:var(--white);}
.nav-btn.active{background:var(--black4);color:var(--white);}
.nav-btn.active::before{content:'';position:absolute;left:0;top:20%;height:60%;width:3px;background:var(--white);border-radius:0 3px 3px 0;opacity:.7;}
.nav-btn.locked{opacity:.3;cursor:not-allowed;}
.nav-btn.locked:hover{background:transparent;color:var(--gray3);}
.nav-icon{font-size:16px;width:26px;height:26px;display:flex;align-items:center;justify-content:center;flex-shrink:0;border-radius:7px;background:rgba(255,255,255,.04);}
.nav-btn:hover .nav-icon,.nav-btn.active .nav-icon{background:rgba(255,255,255,.08);}
.nav-lock{font-size:12px;margin-left:auto;color:var(--gray2);}
.sb-section{padding:12px 14px 4px;font-size:9.5px;font-weight:700;color:var(--gray2);letter-spacing:2.5px;text-transform:uppercase;font-family:'DM Mono',monospace;}

/* HISTORY */
.hist-section{flex:1;overflow-y:auto;padding:4px 10px 4px;display:flex;flex-direction:column;gap:1px;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;}
.hist-item{padding:9px 10px;border-radius:8px;cursor:pointer;transition:background .15s;display:flex;align-items:center;gap:8px;min-width:0;}
.hist-item:hover{background:var(--black3);}
.hist-item.active{background:var(--black3);}
.hist-item-icon{font-size:13px;flex-shrink:0;color:var(--gray3);}
.hist-item-text{flex:1;min-width:0;}
.hist-item-title{font-size:12.5px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--white2);}
.hist-item-date{font-size:10px;color:var(--gray2);font-family:'DM Mono',monospace;margin-top:1px;}
.hist-item-del{background:none;border:none;color:var(--gray2);cursor:pointer;font-size:12px;padding:2px 4px;border-radius:4px;flex-shrink:0;display:none;transition:color .1s;}
.hist-item:hover .hist-item-del{display:block;}
.hist-item-del:hover{color:var(--red);}
.hist-empty{padding:20px 10px;text-align:center;font-size:11px;color:var(--gray2);font-family:'DM Mono',monospace;line-height:1.8;}

/* SIDEBAR FOOTER - Profile */
.sb-footer{border-top:1px solid var(--border);padding:10px;display:flex;flex-direction:column;gap:4px;}
.sb-profile{display:flex;align-items:center;gap:10px;padding:8px 8px;border-radius:10px;cursor:pointer;transition:background .15s;}
.sb-profile:hover{background:var(--black3);}
.sb-avatar{width:32px;height:32px;border-radius:9px;background:var(--black4);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;overflow:hidden;flex-shrink:0;}
.sb-avatar img{width:100%;height:100%;object-fit:cover;}
.sb-user-info{flex:1;min-width:0;}
.sb-user-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sb-user-role{font-size:10px;color:var(--gray3);font-family:'DM Mono',monospace;}
.sb-settings-btn{width:28px;height:28px;border-radius:7px;border:1px solid var(--border2);background:transparent;color:var(--gray3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;flex-shrink:0;}
.sb-settings-btn:hover{border-color:var(--gray2);color:var(--white);}

/* ── MAIN ─── */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

/* TOPBAR */
.topbar{height:58px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 10px;flex-shrink:0;background:#0a0a0a;overflow:hidden;}
.topbar-left{display:flex;align-items:center;gap:6px;min-width:0;flex:1;overflow:hidden;}
.tb-menu{width:40px;height:40px;border-radius:10px;border:1px solid var(--border2);background:transparent;color:var(--gray3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:all .15s;}
.tb-menu:hover{border-color:var(--gray2);color:var(--white);}
.topbar-title{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;}
.role-badge{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;}
.role-badge.owner{background:var(--white);color:var(--black);}
.role-badge.client{border:1px solid var(--border2);color:var(--gray3);}
.topbar-right{display:flex;align-items:center;gap:4px;flex-shrink:0;}
.tb-icon{width:34px;height:34px;border-radius:9px;border:1px solid var(--border2);background:transparent;color:var(--gray3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .15s;}
.tb-icon:hover{border-color:var(--gray2);color:var(--white);}
.tb-status{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;}
@media(max-width:480px){.role-badge{display:none;}.tier-badge-top{display:none;}.tb-icon#themeBtn{display:none;}}
.tb-dot{width:6px;height:6px;border-radius:50%;background:var(--white);animation:blink 2.5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.tier-badge-top{font-size:12px;font-family:'DM Mono',monospace;cursor:pointer;}

/* Avatar di topbar */
.tb-avatar-btn{width:38px;height:38px;border-radius:10px;border:1px solid var(--border2);cursor:pointer;overflow:hidden;display:flex;align-items:center;justify-content:center;transition:border-color .15s;flex-shrink:0;}
.tb-avatar-btn:hover{border-color:var(--gray2);}
.tb-avatar{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;background:var(--black4);color:var(--white);}
.tb-avatar img{width:100%;height:100%;object-fit:cover;}

/* PANELS */
.panel{display:none;flex:1;flex-direction:column;overflow:hidden;}
.panel.active{display:flex;}

/* ── CHAT PANEL ─── */
.chat-msgs{flex:1;overflow-y:auto;padding:16px 16px 8px;display:flex;flex-direction:column;gap:16px;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;}

/* Welcome */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:12px;text-align:center;padding:20px 16px;}
.wmark{width:52px;height:52px;border:1.5px solid rgba(255,255,255,.4);border-radius:14px;display:flex;align-items:center;justify-content:center;}
.welcome h2{font-family:'Fraunces',serif;font-size:22px;font-weight:300;letter-spacing:-.5px;}
.welcome p{color:var(--gray3);font-size:13.5px;line-height:1.7;max-width:340px;}
.quick-grid{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:4px;}
.qbtn{padding:13px 18px;border-radius:20px;border:1px solid var(--border2);background:var(--black4);color:var(--gray4);font-size:14px;font-family:'DM Sans',sans-serif;font-weight:500;cursor:pointer;transition:all .15s;}
.qbtn:hover{border-color:var(--gray2);color:var(--white);}

/* Messages */
.msg{display:flex;gap:10px;animation:msgIn .2s ease;}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg.user{flex-direction:row-reverse;}
.msg.ai .msg-wrap{max-width:85%;}
.msg.user .msg-wrap{max-width:75%;}
.av{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;overflow:hidden;}
.msg.ai .av{background:var(--white);color:var(--black);font-family:'Playfair Display',serif;}
.msg.user .av{background:var(--black4);color:var(--gray4);border:1px solid var(--border2);}
.msg-wrap{display:flex;flex-direction:column;gap:4px;max-width:85%;min-width:0;}
.msg.user .msg-wrap{align-items:flex-end;max-width:75%;}
.bubble{padding:11px 15px;border-radius:16px;font-size:14px;line-height:1.75;font-family:'DM Sans',sans-serif;min-width:0;overflow:hidden;}
.msg.ai .bubble{background:var(--black3);border:1px solid var(--border2);border-top-left-radius:4px;padding:12px 16px;}
.msg.user .bubble{background:var(--white);color:var(--black);border-top-right-radius:4px;}
/* Paksa code block tidak overflow bubble */
.bubble .code-block{max-width:100%;overflow:hidden;}
.bubble .code-pre{max-width:100%;overflow-x:auto;}

/* Salin button - visible like Kimi AI */
.copy-bar{display:flex;align-items:center;gap:6px;padding:4px 0 2px;}
.copy-btn-msg{padding:6px 14px;border-radius:8px;border:1px solid var(--border2);background:transparent;color:var(--gray3);font-size:12px;font-family:'DM Mono',monospace;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:6px;}
.copy-btn-msg:hover{border-color:var(--gray2);color:var(--white);background:var(--black3);}
.copy-btn-msg.copied{border-color:var(--green);color:var(--green);}

/* Typing */
.tdots{display:flex;gap:4px;align-items:center;padding:4px 0;}
.tdots span{width:5px;height:5px;border-radius:50%;background:var(--gray3);animation:bounce 1.2s infinite;}
.tdots span:nth-child(2){animation-delay:.2s}.tdots span:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,100%{transform:translateY(0);opacity:.4}50%{transform:translateY(-4px);opacity:1}}

/* Teks di dalam bubble */
.msg-text{font-size:14px;line-height:1.75;color:inherit;}
.msg-text+.msg-text{margin-top:8px;}
.msg.user .bubble .msg-text{color:var(--black);}
.inline-code{background:rgba(255,255,255,.1);padding:1px 6px;border-radius:5px;font-family:'DM Mono',monospace;font-size:.85em;color:#e2e8f0;}
.msg.user .bubble .inline-code{background:rgba(0,0,0,.12);color:#1a1a1a;}

/* Code block */
.code-block{border-radius:10px;overflow:hidden;border:1px solid var(--border2);margin:8px 0;}
.code-block-header{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--black4);border-bottom:1px solid var(--border2);}
.code-lang{font-size:11px;font-weight:700;color:var(--gray3);font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;}
.code-copy-btn{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;border:1px solid var(--border2);background:transparent;color:var(--gray3);font-size:11px;font-family:'DM Mono',monospace;cursor:pointer;transition:all .15s;}
.code-copy-btn:hover{border-color:var(--gray2);color:var(--white);background:var(--black3);}
.code-copy-btn.copied{border-color:var(--green);color:var(--green);}
.code-pre{margin:0;padding:14px 16px;overflow-x:auto;background:var(--black2);-webkit-overflow-scrolling:touch;}
.code-pre code{font-family:'DM Mono',monospace;font-size:12.5px;line-height:1.8;color:#c9d1d9;white-space:pre;display:block;min-width:100%;}

/* Attach chips */
.attach-preview{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;}
.attach-chip{display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;background:var(--black3);border:1px solid var(--border2);font-size:11px;font-family:'DM Mono',monospace;color:var(--gray4);}
.attach-chip img{width:22px;height:22px;border-radius:4px;object-fit:cover;}
.attach-chip .rm{background:none;border:none;color:var(--gray2);cursor:pointer;font-size:12px;padding:0;margin-left:2px;}
.attach-chip .rm:hover{color:var(--red);}

/* Chat input */
.chat-in-wrap{padding:6px 12px 6px;border-top:1px solid var(--border);background:var(--black2);}
.chat-in-box{background:var(--black3);border:1px solid var(--border2);border-radius:14px;padding:10px 12px;transition:border-color .15s;}
.chat-in-box:focus-within{border-color:var(--gray2);}
.chat-in-row{display:flex;gap:8px;align-items:center;}
.chat-in-box textarea{flex:1;background:transparent;border:none;outline:none;color:var(--white);font-family:'DM Sans',sans-serif;font-size:13.5px;resize:none;min-height:44px;max-height:120px;line-height:1.6;display:flex;align-items:center;padding-top:12px;}
.chat-in-box textarea::placeholder{color:var(--gray2);}
.chat-in-actions{display:flex;gap:6px;align-items:center;flex-shrink:0;}

/* + Attach button */
.plus-btn{width:44px;height:44px;border-radius:12px;border:1px solid var(--border2);background:var(--black4);color:var(--gray4);cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;transition:all .15s;position:relative;font-weight:300;}
.plus-btn:hover{border-color:var(--gray2);color:var(--white);}
.plus-btn.open{border-color:var(--gray2);color:var(--white);background:var(--black3);}

/* Attach Bottom Sheet */
.attach-sheet-overlay{position:fixed;inset:0;z-index:300;display:none;align-items:flex-end;justify-content:center;}
.attach-sheet-overlay.open{display:flex;}
.attach-sheet-bg{position:absolute;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);}
.attach-sheet{position:relative;width:100%;max-width:520px;background:#161616;border-radius:24px 24px 0 0;border-top:1px solid rgba(255,255,255,.08);padding:16px 20px 36px;z-index:1;animation:sheetUp .22s ease;}
@keyframes sheetUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:none}}
.attach-sheet-handle{width:36px;height:4px;background:rgba(255,255,255,.12);border-radius:2px;margin:0 auto 18px;}
.attach-sheet-title{font-size:13px;font-weight:600;color:rgba(255,255,255,.5);font-family:'DM Mono',monospace;letter-spacing:1px;text-align:center;margin-bottom:18px;}
.attach-sheet-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:8px;}
.attach-sheet-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:18px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--white);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .18s;}
.attach-sheet-btn:hover,.attach-sheet-btn:active{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2);}
.attach-sheet-icon{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.07);display:flex;align-items:center;justify-content:center;font-size:20px;}

/* Old popup (kept hidden for compat) */
.attach-popup{display:none !important;}
.attach-opt{display:none;}

.voice-btn{width:44px;height:44px;border-radius:12px;border:1px solid var(--border2);background:var(--black4);color:var(--gray4);cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.voice-btn:hover{border-color:var(--gray2);color:var(--white);}
.voice-btn.recording{border-color:var(--red);color:var(--red);animation:pulse-r .8s infinite;}
@keyframes pulse-r{0%,100%{opacity:1}50%{opacity:.4}}
.send-btn{width:44px;height:44px;border-radius:12px;border:none;background:var(--white);color:var(--black);cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all .15s;font-weight:700;flex-shrink:0;}
.send-btn:hover{background:var(--gray5);}
.send-btn:disabled{opacity:.3;cursor:not-allowed;}
.chat-hint{text-align:center;font-size:10.5px;color:var(--gray2);font-family:'DM Mono',monospace;margin-top:8px;}

/* ── OWNER DASHBOARD ─── */
.dash-wrap{flex:1;overflow-y:auto;padding:28px;display:flex;flex-direction:column;gap:24px;}
.dash-header h2{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;}
.dash-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;}
.dash-card{background:var(--black3);border:1px solid var(--border2);border-radius:14px;padding:20px;}
.prem-code-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:1px solid var(--border2);background:var(--black4);font-family:'DM Mono',monospace;}
.prem-code-val{flex:1;font-size:12px;color:var(--white);letter-spacing:1px;}
.prem-code-exp{font-size:10px;color:var(--gray3);white-space:nowrap;}
.prem-code-badge{font-size:9px;padding:2px 7px;border-radius:20px;font-weight:700;letter-spacing:1px;white-space:nowrap;}
.prem-code-badge.active{background:rgba(56,161,105,.15);color:#38a169;border:1px solid rgba(56,161,105,.3);}
.prem-code-badge.used{background:rgba(136,136,136,.1);color:var(--gray3);border:1px solid var(--border2);}
.prem-code-badge.expired{background:rgba(229,62,62,.1);color:#fc8181;border:1px solid rgba(229,62,62,.2);}
.prem-copy-btn{background:none;border:1px solid var(--border2);color:var(--gray3);font-size:10px;padding:3px 8px;border-radius:5px;cursor:pointer;font-family:'DM Mono',monospace;transition:all .15s;white-space:nowrap;}
.prem-copy-btn:hover{border-color:var(--gray2);color:var(--white);}
.prem-del-btn{background:none;border:none;color:var(--gray2);font-size:13px;cursor:pointer;padding:2px 4px;transition:color .15s;flex-shrink:0;}
.prem-del-btn:hover{color:var(--red);}
.feat-list{display:flex;flex-direction:column;gap:10px;}
.feat-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-radius:10px;background:var(--black4);border:1px solid var(--border);}
.feat-info{display:flex;align-items:center;gap:10px;}
.feat-icon{font-size:18px;}
.feat-name{font-size:13px;font-weight:600;}
.feat-desc{font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;}
.toggle{position:relative;width:42px;height:24px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;border-radius:12px;background:var(--border2);cursor:pointer;transition:.2s;}
.toggle-slider::before{content:'';position:absolute;width:18px;height:18px;left:3px;bottom:3px;border-radius:50%;background:var(--gray2);transition:.2s;}
.toggle input:checked+.toggle-slider{background:var(--white);}
.toggle input:checked+.toggle-slider::before{transform:translateX(18px);background:var(--black);}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);}
.stat-row:last-child{border-bottom:none;}
.stat-label{font-size:12px;color:var(--gray3);font-family:'DM Mono',monospace;}
.stat-value{font-size:14px;font-weight:700;font-family:'DM Mono',monospace;}
.apikey-row{display:flex;gap:8px;align-items:center;}
.apikey-input{flex:1;padding:10px 12px;border-radius:8px;border:1px solid var(--border2);background:var(--black4);color:var(--white);font-family:'DM Mono',monospace;font-size:12px;outline:none;transition:border-color .15s;}
.apikey-input:focus{border-color:var(--gray2);}
.save-btn{padding:10px 16px;border-radius:8px;border:none;background:var(--white);color:var(--black);font-weight:700;font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;white-space:nowrap;transition:background .15s;}
.save-btn:hover{background:var(--gray5);}

/* ── ANALYZER ─── */
.az-layout{flex:1;display:flex;overflow:hidden;}
.az-left{flex:1;padding:22px;border-right:1px solid var(--border);display:flex;flex-direction:column;gap:12px;overflow:hidden;}
.az-right{flex:1;padding:22px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;}
.dropzone{border:1px dashed var(--border2);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all .15s;color:var(--gray3);}
.dropzone:hover,.dropzone.drag{border-color:var(--gray2);color:var(--white);background:var(--black3);}
.dropzone .di{font-size:26px;margin-bottom:6px;}
.dropzone p{font-size:12px;font-family:'DM Mono',monospace;line-height:1.7;}
.txta{flex:1;background:var(--black3);border:1px solid var(--border2);border-radius:10px;padding:14px;color:var(--white);font-family:'DM Mono',monospace;font-size:12.5px;resize:none;outline:none;line-height:1.8;min-height:150px;transition:border-color .15s;}
.txta:focus{border-color:var(--gray2);}.txta::placeholder{color:var(--gray2);}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;}
.btn{padding:8px 14px;border-radius:8px;border:1px solid var(--border2);background:var(--black3);color:var(--gray4);font-family:'DM Sans',sans-serif;font-weight:500;font-size:12.5px;cursor:pointer;transition:all .15s;}
.btn:hover{border-color:var(--gray2);color:var(--white);}
.btn.p{background:var(--white);color:var(--black);border-color:var(--white);font-weight:600;}
.btn.p:hover{background:var(--gray5);}
.rlabel{font-size:10px;font-weight:600;color:var(--gray3);letter-spacing:2.5px;text-transform:uppercase;font-family:'DM Mono',monospace;}
.rbox{flex:1;background:var(--black3);border:1px solid var(--border2);border-radius:10px;padding:16px;font-family:'DM Mono',monospace;font-size:12.5px;line-height:1.9;white-space:pre-wrap;color:var(--white);min-height:200px;overflow-y:auto;}
.rbox .ph{color:var(--gray2);}

/* ── PROGRAMMER ─── */
.pg-layout{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.pg-toolbar{padding:10px 16px;border-bottom:1px solid var(--border);display:flex;gap:6px;align-items:center;flex-wrap:wrap;background:var(--black2);}
.lsel{padding:7px 12px;border-radius:7px;border:1px solid var(--border2);background:var(--black3);color:var(--white);font-family:'DM Mono',monospace;font-size:12px;outline:none;cursor:pointer;}
.pg-body{flex:1;display:flex;overflow:hidden;}

/* Editor pane */
.code-pane{flex:1;display:flex;flex-direction:column;border-right:1px solid var(--border);min-width:0;}
.code-pane-header{padding:8px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--black2);flex-shrink:0;}
.code-ed{flex:1;background:#0d0d0d;border:none;outline:none;color:#c9d1d9;font-family:'DM Mono',monospace;font-size:13px;padding:16px;resize:none;line-height:1.8;tab-size:2;}
.pg-line-info{padding:4px 14px;font-size:10px;color:var(--gray2);font-family:'DM Mono',monospace;background:var(--black2);border-top:1px solid var(--border);flex-shrink:0;}

/* AI chat pane */
.ai-pane{width:340px;flex-shrink:0;display:flex;flex-direction:column;background:var(--black);}
.ai-head{padding:10px 16px;border-bottom:1px solid var(--border);font-size:11px;letter-spacing:1.5px;text-transform:uppercase;font-family:'DM Mono',monospace;color:var(--gray3);display:flex;align-items:center;justify-content:space-between;background:var(--black2);flex-shrink:0;}
.pg-hist-count{font-size:10px;color:var(--gray2);}
.ai-chat-msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:12px;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;}
.pg-welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;color:var(--gray3);padding:20px;}

/* Programmer messages */
.pg-msg{display:flex;flex-direction:column;gap:4px;animation:msgIn .2s ease;}
.pg-msg.user .pg-bubble{background:var(--white);color:var(--black);border-radius:12px 12px 4px 12px;align-self:flex-end;max-width:90%;}
.pg-msg.ai .pg-bubble{background:var(--black3);border:1px solid var(--border2);border-radius:4px 12px 12px 12px;max-width:100%;}
.pg-bubble{padding:10px 13px;font-size:13px;line-height:1.7;font-family:'DM Sans',sans-serif;}
.pg-bubble .msg-text{font-size:13px;line-height:1.7;}
.pg-bubble .code-block{margin:6px 0;}
.pg-copy-bar{display:flex;gap:6px;margin-top:2px;}
.pg-copy-btn{display:flex;align-items:center;gap:4px;padding:3px 9px;border-radius:5px;border:1px solid var(--border2);background:transparent;color:var(--gray3);font-size:10px;font-family:'DM Mono',monospace;cursor:pointer;transition:all .15s;}
.pg-copy-btn:hover{border-color:var(--gray2);color:var(--white);}
.pg-copy-btn.copied{border-color:var(--green);color:var(--green);}

/* Ask input */
.ai-ask-wrap{padding:10px;border-top:1px solid var(--border);background:var(--black2);flex-shrink:0;}
.ai-ask-box{display:flex;gap:6px;align-items:flex-end;background:var(--black3);border:1px solid var(--border2);border-radius:10px;padding:8px 10px;transition:border-color .15s;}
.ai-ask-box:focus-within{border-color:var(--gray2);}
.ai-ask-in{flex:1;background:transparent;border:none;outline:none;color:var(--white);font-family:'DM Sans',sans-serif;font-size:13px;resize:none;min-height:18px;max-height:80px;line-height:1.6;}
.ai-ask-in::placeholder{color:var(--gray2);}
.ai-ask-send{width:28px;height:28px;border-radius:7px;border:none;background:var(--white);color:var(--black);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;transition:all .15s;}
.ai-ask-send:hover{background:var(--gray5);}

/* ── IMAGE GEN ─── */
.img-layout{flex:1;display:flex;overflow:hidden;}
.img-ctrl{width:260px;flex-shrink:0;border-right:1px solid var(--border);padding:20px;display:flex;flex-direction:column;gap:14px;overflow-y:auto;background:var(--black2);}
.img-gallery{flex:1;padding:20px;overflow-y:auto;}
.flabel{font-size:10px;font-weight:600;color:var(--gray3);letter-spacing:2px;text-transform:uppercase;font-family:'DM Mono',monospace;margin-bottom:8px;}
.prompt-ta{width:100%;background:var(--black3);border:1px solid var(--border2);border-radius:10px;padding:12px;color:var(--white);font-family:'DM Mono',monospace;font-size:12px;resize:none;outline:none;line-height:1.7;min-height:80px;}
.prompt-ta:focus{border-color:var(--gray2);}.prompt-ta::placeholder{color:var(--gray2);}
.chip-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.chip{padding:7px 8px;border-radius:7px;border:1px solid var(--border2);background:transparent;color:var(--gray3);font-size:11px;font-family:'DM Sans',sans-serif;font-weight:500;cursor:pointer;text-align:center;transition:all .15s;}
.chip:hover{border-color:var(--gray2);color:var(--white);}
.chip.on{background:var(--white);color:var(--black);border-color:var(--white);font-weight:600;}
.ratio-row{display:flex;gap:6px;}.ratio-row .chip{flex:1;}
.g-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;align-items:start;}
.g-empty{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:var(--gray2);font-family:'DM Mono',monospace;font-size:12px;min-height:250px;}
.g-empty .ei{font-size:36px;}
.img-card{border:1px solid var(--border2);border-radius:10px;overflow:hidden;background:var(--black3);animation:msgIn .3s ease;}
.img-card img{width:100%;display:block;background:var(--black4);aspect-ratio:1/1;object-fit:cover;}
.img-card.land img{aspect-ratio:16/9;}.img-card.port img{aspect-ratio:9/16;}
.img-card-bot{padding:9px 11px;display:flex;align-items:center;gap:8px;border-top:1px solid var(--border);}
.img-card-txt{font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;}
.dl-btn{background:transparent;border:1px solid var(--border2);color:var(--gray3);font-size:11px;padding:3px 8px;border-radius:5px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s;flex-shrink:0;}
.dl-btn:hover{border-color:var(--gray2);color:var(--white);}
.img-load{aspect-ratio:1/1;background:var(--black4);display:flex;align-items:center;justify-content:center;}

/* ── TRANSLATE ─── */
/* reuse az-layout */

/* ── SPINNER ─── */
.spinner{width:18px;height:18px;border:2px solid var(--border2);border-top-color:var(--white);border-radius:50%;animation:spin .7s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── MODALS ─── */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.88);backdrop-filter:blur(6px);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;overflow-y:auto;}
.modal-overlay.open{display:flex;}
.modal-box{background:var(--black2);border:1px solid var(--border2);border-radius:18px;padding:28px;width:400px;max-width:100%;display:flex;flex-direction:column;gap:14px;margin:auto;}
.modal-box h3{font-family:'Playfair Display',serif;font-size:18px;}
.modal-close{position:absolute;top:14px;right:14px;background:none;border:none;color:var(--gray3);cursor:pointer;font-size:18px;}

/* Settings modal */
.settings-section{display:flex;flex-direction:column;gap:10px;}
.settings-title{font-size:10px;font-weight:700;color:var(--gray3);letter-spacing:2px;text-transform:uppercase;font-family:'DM Mono',monospace;padding-top:4px;}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);}
.settings-row:last-child{border-bottom:none;}
.settings-label{font-size:13px;color:var(--white);}
.settings-sub{font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;margin-top:2px;}

/* Scrollbar */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* Responsive */
@media(max-width:700px){
  .sidebar{position:fixed;top:0;left:0;height:100vh;z-index:80;transform:translateX(-100%);transition:transform .25s ease;}
  .sidebar.mobile-open{transform:none;width:240px;}
  .sidebar.collapsed{transform:translateX(-100%);}
  .az-layout{flex-direction:column;}.az-left{border-right:none;border-bottom:1px solid var(--border);}
  .img-layout{flex-direction:column;}.img-ctrl{width:100%;border-right:none;border-bottom:1px solid var(--border);}
  .pg-body{flex-direction:column;}.ai-pane{width:100%;height:200px;border-top:1px solid var(--border);}
  .bubble{max-width:90%;}
  .dash-grid{grid-template-columns:1fr;}
}

/* ── MOBILE OPTIMIZATIONS ── */
@media (max-width: 480px) {
  .welcome { padding: 16px 12px; gap: 10px; }
  .welcome h2 { font-size: 20px; }
  .welcome p { font-size: 13px; }
  .quick-grid { gap: 8px; }
  .qbtn { padding: 14px 16px; font-size: 14px; border-radius: 14px; }
  .chat-in-wrap { padding: 6px 8px 6px; }
  .topbar { padding: 0 14px; }
  .send-btn { width: 48px; height: 48px; font-size: 22px; }
  .plus-btn { width: 48px; height: 48px; font-size: 26px; }
  .msg { padding: 0 12px; }
}
</style>
</head>
<body>

<!-- ════ AUTH SCREEN ════ -->
<div id="authScreen">

  <!-- Landing -->
  <div class="auth-landing">
    <div class="auth-landing-bg"></div>
    <div class="auth-brand">
      <div class="auth-logomark">
        <svg width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="rgba(0,0,0,0.7)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2L2 7l10 5 10-5-10-5z"/>
          <path d="M2 12l10 5 10-5" opacity=".5"/>
          <path d="M2 17l10 5 10-5" opacity=".25"/>
        </svg>
      </div>
      <div class="auth-appname">pev<em>.ai</em></div>
      <div class="auth-tagline">AI untuk ide, analisis, coding, dan segalanya.</div>
    </div>
  </div>

  <!-- Bottom Sheet Actions -->
  <div class="auth-bottom">
    <div class="auth-bottom-handle"></div>
    <button class="auth-btn-google" onclick="googleLogin()">
      <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Lanjutkan dengan Google
    </button>
    <div style="display:flex;gap:10px;">
      <button class="auth-btn-register" style="flex:1" onclick="openAuthModal('register')">Daftar</button>
      <button class="auth-btn-login" style="flex:1" onclick="openAuthModal('login')">Masuk</button>
    </div>
    <div class="auth-owner-hint" onclick="openAuthModal('owner')" title="">· · ·</div>
  </div>

</div>

<!-- ════ AUTH MODALS ════ -->

<!-- Register Modal -->
<div class="auth-modal-overlay" id="registerModal" onclick="handleAuthModalClick(event,'registerModal')">
  <div class="auth-modal-bg"></div>
  <div class="auth-modal-sheet">
    <div class="auth-modal-handle"></div>
    <div class="auth-modal-title">Buat akun</div>
    <div class="auth-field">
      <div class="auth-field-label">Username</div>
      <input class="auth-field-input" id="regUser" type="text" placeholder="Pilih username" autocomplete="off" onkeydown="if(event.key==='Enter')document.getElementById('regPass').focus()">
    </div>
    <div class="auth-field">
      <div class="auth-field-label">Password</div>
      <input class="auth-field-input" id="regPass" type="password" placeholder="Buat password" onkeydown="if(event.key==='Enter')document.getElementById('regPass2').focus()">
    </div>
    <div class="auth-field">
      <div class="auth-field-label">Konfirmasi Password</div>
      <input class="auth-field-input" id="regPass2" type="password" placeholder="Ulangi password" onkeydown="if(event.key==='Enter')doRegister()">
    </div>
    <div class="auth-err-msg" id="regErr"></div>
    <button class="auth-submit-btn" onclick="doRegister()">Daftar Sekarang</button>
    <div class="auth-divider"><span>sudah punya akun?</span></div>
    <button class="auth-btn-login" style="margin-top:0" onclick="closeAuthModal('registerModal');openAuthModal('login')">Masuk</button>
  </div>
</div>

<!-- Login Modal -->
<div class="auth-modal-overlay" id="loginModal" onclick="handleAuthModalClick(event,'loginModal')">
  <div class="auth-modal-bg"></div>
  <div class="auth-modal-sheet">
    <div class="auth-modal-handle"></div>
    <div class="auth-modal-title">Selamat datang</div>
    <div class="auth-field">
      <div class="auth-field-label">Username</div>
      <input class="auth-field-input" id="loginUser" type="text" placeholder="Username kamu" autocomplete="off" onkeydown="if(event.key==='Enter')document.getElementById('loginPass').focus()">
    </div>
    <div class="auth-field">
      <div class="auth-field-label">Password</div>
      <input class="auth-field-input" id="loginPass" type="password" placeholder="Password kamu" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="auth-err-msg" id="loginErr"></div>
    <button class="auth-submit-btn" onclick="doLogin()">Masuk</button>
    <div class="auth-divider"><span>belum punya akun?</span></div>
    <button class="auth-btn-login" style="margin-top:0" onclick="closeAuthModal('loginModal');openAuthModal('register')">Daftar</button>
  </div>
</div>

<!-- Owner Modal -->
<div class="auth-modal-overlay" id="ownerModal" onclick="handleAuthModalClick(event,'ownerModal')">
  <div class="auth-modal-bg"></div>
  <div class="auth-modal-sheet">
    <div class="auth-modal-handle"></div>
    <div class="auth-modal-title">Owner</div>
    <div class="auth-field">
      <div class="auth-field-label">Username</div>
      <input class="auth-field-input" id="ownerUser" type="text" placeholder="username" autocomplete="off" onkeydown="if(event.key==='Enter')document.getElementById('ownerPass').focus()">
    </div>
    <div class="auth-field">
      <div class="auth-field-label">Password</div>
      <input class="auth-field-input" id="ownerPass" type="password" placeholder="••••••••" onkeydown="if(event.key==='Enter')ownerLogin()">
    </div>
    <div class="auth-err-msg" id="ownerErr"></div>
    <button class="auth-submit-btn" onclick="ownerLogin()">Masuk sebagai Owner</button>
  </div>
</div>

<!-- ════ MAIN APP ════ -->
<div id="appScreen" style="display:none">
<div class="app">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sb">
    <div class="sb-top">
      <div class="sb-logo">
        <div class="sb-logomark">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 12l10 5 10-5" opacity=".5"/>
            <path d="M2 17l10 5 10-5" opacity=".25"/>
          </svg>
        </div>
        <div class="sb-logotext">
          <div class="sb-logomain">pev<em>.ai</em></div>
          <div class="sb-logosub">pev.ai</div>
        </div>
      </div>
      <button class="sb-toggle" onclick="toggleSidebar()" title="Tutup sidebar">&times;</button>
    </div>

    <button class="sb-new" onclick="newChat()">
      <span>✦</span><span>Chat Baru</span>
    </button>

    <div class="sb-section">Menu</div>
    <div class="sb-nav">
      <div id="nav-dash" style="display:none">
        <button class="nav-btn" id="nb-dash" onclick="go('dash')">
          <span class="nav-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></span>Dashboard
        </button>
      </div>
      <button class="nav-btn active" id="nb-chat" onclick="go('chat')">
        <span class="nav-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>Chat
      </button>
      <!-- Fitur berikut hanya muncul untuk owner -->
      <div id="owner-features" style="display:none">
        <button class="nav-btn" id="nb-analyze" onclick="goFeature('analyze')">
          <span class="nav-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg></span>Analisis Teks
        </button>
        <button class="nav-btn" id="nb-prog" onclick="goFeature('prog')">
          <span class="nav-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></span>Programmer
        </button>
        <button class="nav-btn" id="nb-image" onclick="goFeature('image')">
          <span class="nav-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></span>Image Gen
        </button>
        <button class="nav-btn" id="nb-translate" onclick="goFeature('translate')">
          <span class="nav-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></span>Translate
        </button>
        <button class="nav-btn" id="nb-youtube" onclick="goFeature('youtube')">
          <span class="nav-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg></span>YouTube AI
        </button>
      </div>
      <!-- Premium untuk client -->
      <div id="client-premium-nav" style="display:none">
        <button class="nav-btn" onclick="openPremiumModal()" style="color:#fbbf24;">
          <span class="nav-icon"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></span>Upgrade Premium
        </button>
      </div>
    </div>

    <div class="sb-section">Riwayat</div>
    <div class="hist-section" id="histList">
      <div class="hist-empty">Belum ada riwayat chat.</div>
    </div>

    <!-- Profile footer -->
    <div class="sb-footer">
      <div class="sb-profile" onclick="openSettingsModal()">
        <div class="sb-avatar" id="sbAvatar">?</div>
        <div class="sb-user-info">
          <div class="sb-user-name" id="sbUserName">—</div>
          <div class="sb-user-role" id="sbUserRole">—</div>
        </div>
        <button class="sb-settings-btn" onclick="event.stopPropagation();openSettingsModal()" title="Pengaturan"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-left">
        <button class="tb-menu" onclick="toggleSidebar()" title="Sidebar">☰</button>
        <span class="topbar-title" id="topTitle">Chat</span>
        <span class="role-badge" id="roleBadge">—</span>
        <span class="tier-badge-top" id="tierBadge" onclick="openPremiumModal()"></span>
      </div>
      <div class="topbar-right">
        <button class="tb-icon" id="themeBtn" onclick="toggleTheme()" title="Dark/Light"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button>
        <button class="tb-icon" id="exportBtn" onclick="exportChatPDF()" title="Export PDF" style="display:none">📄</button>
        <div class="tb-status"><div class="tb-dot"></div><span id="modelLabel">haiku</span></div>
        <div class="tb-avatar-btn" onclick="openSettingsModal()" title="Pengaturan">
          <div class="tb-avatar" id="tbAvatar">?</div>
        </div>
        <button class="tb-icon" onclick="logout()" title="Keluar" style="font-size:12px;width:auto;padding:0 14px;font-family:'DM Sans',sans-serif;font-weight:600;">Keluar</button>
      </div>
    </div>

    <!-- OWNER DASHBOARD -->
    <div class="panel" id="panel-dash">
      <div class="dash-wrap">
        <div class="dash-header">
          <h2>Owner Dashboard</h2>
          <p style="color:var(--gray3);font-family:'DM Mono',monospace;font-size:12px;margin-top:4px">Kelola akses fitur untuk semua client</p>
        </div>
        <div class="dash-grid">
          <div class="dash-card" style="grid-column:1/-1">
            <h4>Kontrol Fitur Client</h4>
            <div class="feat-list">
              <div class="feat-row">
                <div class="feat-info"><span class="feat-icon">💬</span><div><div class="feat-name">Chat AI</div><div class="feat-desc">Tanya jawab dengan AI</div></div></div>
                <label class="toggle"><input type="checkbox" checked disabled><span class="toggle-slider"></span></label>
              </div>
              <div class="feat-row">
                <div class="feat-info"><span class="feat-icon">📄</span><div><div class="feat-name">Analisis Teks</div><div class="feat-desc">Ringkasan, sentimen, poin penting</div></div></div>
                <label class="toggle"><input type="checkbox" id="ft-analyze" onchange="saveFeatures()"><span class="toggle-slider"></span></label>
              </div>
              <div class="feat-row">
                <div class="feat-info"><span class="feat-icon">💻</span><div><div class="feat-name">Programmer</div><div class="feat-desc">Debug, explain, generate kode</div></div></div>
                <label class="toggle"><input type="checkbox" id="ft-prog" onchange="saveFeatures()"><span class="toggle-slider"></span></label>
              </div>
              <div class="feat-row">
                <div class="feat-info"><span class="feat-icon">🖼️</span><div><div class="feat-name">Image Generator</div><div class="feat-desc">Generate gambar dengan AI</div></div></div>
                <label class="toggle"><input type="checkbox" id="ft-image" onchange="saveFeatures()"><span class="toggle-slider"></span></label>
              </div>
              <div class="feat-row">
                <div class="feat-info"><span class="feat-icon">🌍</span><div><div class="feat-name">Translate</div><div class="feat-desc">Terjemahan multi bahasa</div></div></div>
                <label class="toggle"><input type="checkbox" id="ft-translate" onchange="saveFeatures()"><span class="toggle-slider"></span></label>
              </div>
              <div class="feat-row">
                <div class="feat-info"><span class="feat-icon">▶️</span><div><div class="feat-name">YouTube AI</div><div class="feat-desc">Ringkas video YouTube</div></div></div>
                <label class="toggle"><input type="checkbox" id="ft-youtube" onchange="saveFeatures()"><span class="toggle-slider"></span></label>
              </div>
            </div>
          </div>
          <div class="dash-card">
            <h4>Info Session</h4>
            <div class="stat-row"><span class="stat-label">Role</span><span class="stat-value">Owner</span></div>
            <div class="stat-row"><span class="stat-label">Username</span><span class="stat-value" id="dashUsername">—</span></div>
            <div class="stat-row"><span class="stat-label">Fitur aktif client</span><span class="stat-value" id="dashFeatCount">1 / 6</span></div>
            <div class="stat-row"><span class="stat-label">API Key</span><span class="stat-value" id="dashKeyStatus">—</span></div>
            <div class="stat-row"><span class="stat-label">Total chat</span><span class="stat-value" id="dashChatCount">0</span></div>
          </div>
          <div class="dash-card" style="grid-column:1/-1">
            <h4>🎟️ Kelola Kode Premium</h4>
            <!-- Generate area -->
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px;">
              <select id="premExpiry" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border2);background:var(--black4);color:var(--white);font-family:'DM Mono',monospace;font-size:11px;outline:none;cursor:pointer;">
                <option value="7">7 hari</option>
                <option value="30" selected>30 hari</option>
                <option value="90">90 hari</option>
                <option value="365">1 tahun</option>
              </select>
              <select id="premQty" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border2);background:var(--black4);color:var(--white);font-family:'DM Mono',monospace;font-size:11px;outline:none;cursor:pointer;">
                <option value="1">1 kode</option>
                <option value="3">3 kode</option>
                <option value="5">5 kode</option>
                <option value="10">10 kode</option>
              </select>
              <button onclick="generatePremiumCodes()" style="padding:8px 18px;border-radius:8px;border:none;background:var(--white);color:var(--black);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;white-space:nowrap;">✦ Generate Kode</button>
            </div>
            <!-- Give Premium / Sample codes -->
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
              <div style="flex:1;height:1px;background:var(--border2)"></div>
              <span style="font-size:10px;color:var(--gray2);font-family:'DM Mono',monospace;letter-spacing:1px;">GIVE PREMIUM</span>
              <div style="flex:1;height:1px;background:var(--border2)"></div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px;">
              <span style="font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;">Format: 1234-5678-9101-1121</span>
              <button id="sampleCodesBtn" onclick="generateSampleCodes()" style="padding:8px 18px;border-radius:8px;border:1px solid rgba(251,191,36,.4);background:rgba(251,191,36,.08);color:#fbbf24;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;white-space:nowrap;">🎁 Generate 5 Kode Contoh</button>
            </div>
            <!-- Code list -->
            <div id="premCodeList" style="display:flex;flex-direction:column;gap:6px;max-height:260px;overflow-y:auto;">
              <div style="text-align:center;padding:20px;color:var(--gray2);font-family:'DM Mono',monospace;font-size:11px;">Belum ada kode. Generate dulu!</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHAT PANEL -->
    <div class="panel active" id="panel-chat">
      <div class="chat-msgs" id="chatMsgs">
        <div class="welcome" id="welcomeEl">
          <div class="wmark"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 12l10 5 10-5" opacity=".5"/><path d="M2 17l10 5 10-5" opacity=".25"/></svg></div>
          <h2>Halo, ada yang bisa dibantu?</h2>
          <p>Tanya apa saja — ide, analisis, coding, atau ngobrol biasa.</p>
          <div class="quick-grid">
            <button class="qbtn" onclick="qc('Apa yang bisa kamu lakukan?')">Apa itu Pev.ai?</button>
            <button class="qbtn" onclick="qc('Buatkan ide startup teknologi yang unik')">💡 Ide Startup</button>
            <button class="qbtn" onclick="qc('Jelaskan cara kerja AI dengan bahasa mudah')">🧠 Belajar AI</button>
            <button class="qbtn" onclick="qc('Rencana belajar coding dari nol 3 bulan')">📚 Belajar Coding</button>
          </div>
        </div>
      </div>
      <div class="chat-in-wrap">
        <div class="attach-preview" id="attachPreview"></div>
        <div class="chat-in-box">
          <div class="chat-in-row">
            <textarea id="chatIn" placeholder="Ketik pesan..." rows="1" onkeydown="ck(event)" oninput="ah(this)"></textarea>
            <div class="chat-in-actions" style="position:relative;">
              <!-- + button: buka bottom sheet -->
              <button class="plus-btn" id="plusBtn" onclick="openAttachSheet()" title="Lampirkan">+</button>
              <input type="file" id="anyUpload" accept="image/*,.pdf,.txt,.md,.csv,.js,.py,.html" style="display:none" onchange="attachAny(event)">
              <input type="file" id="imgUpload" accept="image/*" style="display:none" onchange="attachImage(event)">
              <input type="file" id="fileUpload" accept=".pdf,.txt,.md,.csv,.js,.py,.html" style="display:none" onchange="attachFile(event)">
              <button class="send-btn" id="sbtn" onclick="sc()">↑</button>
            </div>
          </div>
        </div>
        <div class="chat-hint">Enter kirim · Shift+Enter baris baru · + untuk lampirkan file</div>
      </div>
    </div>

    <!-- ANALYZE PANEL -->
    <div class="panel" id="panel-analyze">
      <div class="az-layout">
        <div class="az-left">
          <div class="dropzone" id="dz" onclick="document.getElementById('fi').click()"
            ondragover="event.preventDefault();this.classList.add('drag')"
            ondragleave="this.classList.remove('drag')"
            ondrop="od(event)">
            <div class="di">📂</div>
            <p>Klik atau drop file<br><small>TXT, MD, CSV</small></p>
          </div>
          <input type="file" id="fi" style="display:none" accept=".txt,.md,.csv" onchange="of2(event)">
          <textarea class="txta" id="azIn" placeholder="Atau tempel teks di sini..."></textarea>
          <div class="btn-row">
            <button class="btn p" onclick="da('buatkan ringkasan singkat dan padat')">Ringkas</button>
            <button class="btn" onclick="da('analisis sentimen dan emosi dalam teks')">Sentimen</button>
            <button class="btn" onclick="da('ekstrak poin penting dalam bentuk daftar')">Poin Penting</button>
            <button class="btn" onclick="da('terjemahkan ke bahasa Inggris')">Translate</button>
          </div>
        </div>
        <div class="az-right">
          <div class="rlabel">Hasil</div>
          <div class="rbox" id="azOut"><span class="ph">Hasil analisis muncul di sini.</span></div>
        </div>
      </div>
    </div>

    <!-- PROGRAMMER PANEL -->
    <div class="panel" id="panel-prog">
      <div class="pg-layout">
        <!-- Toolbar -->
        <div class="pg-toolbar">
          <select class="lsel" id="lsel">
            <option>Python</option><option>JavaScript</option><option>TypeScript</option>
            <option>HTML/CSS</option><option>Lua</option><option>Java</option>
            <option>C++</option><option>Go</option><option>Rust</option>
            <option>PHP</option><option>SQL</option><option>Bash</option>
          </select>
          <button class="btn" onclick="pgAction('explain')">💡 Jelaskan</button>
          <button class="btn" onclick="pgAction('debug')">🐛 Debug</button>
          <button class="btn" onclick="pgAction('optimize')">⚡ Optimasi</button>
          <button class="btn" onclick="pgAction('convert')">🔄 Konversi</button>
          <button class="btn p" onclick="pgGenerate()">✨ Generate</button>
          <button class="btn" onclick="pgClear()" style="margin-left:auto">🗑 Bersihkan</button>
        </div>
        <!-- Body: editor kiri, chat kanan -->
        <div class="pg-body">
          <!-- Kiri: Code editor -->
          <div class="code-pane">
            <div class="code-pane-header">
              <span id="pgEditorLang" style="font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;">editor</span>
              <div style="display:flex;gap:6px;">
                <button class="code-copy-btn" onclick="copyEditorCode()" style="font-size:11px">📋 Salin</button>
                <button class="code-copy-btn" onclick="pasteToEditor()" style="font-size:11px">📥 Paste</button>
              </div>
            </div>
            <textarea class="code-ed" id="ced" placeholder="// Paste kode di sini untuk dianalisis&#10;// atau ketik deskripsi lalu klik Generate" oninput="updateEditorLang()" spellcheck="false"></textarea>
            <div class="pg-line-info" id="pgLineInfo">0 baris · 0 karakter</div>
          </div>
          <!-- Kanan: Chat hasil AI -->
          <div class="ai-pane">
            <div class="ai-head">
              <span>AI Programmer</span>
              <div class="pg-hist-count" id="pgHistCount"></div>
            </div>
            <div class="ai-chat-msgs" id="pgMsgs">
              <div class="pg-welcome">
                <div style="font-size:28px;margin-bottom:8px">💻</div>
                <div style="font-size:13px;font-weight:600;margin-bottom:4px">AI Programmer</div>
                <div style="font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;line-height:1.7">Paste kode → pilih aksi<br>atau ketik deskripsi → Generate</div>
              </div>
            </div>
            <div class="ai-ask-wrap">
              <div class="ai-ask-box">
                <textarea class="ai-ask-in" id="ain" placeholder="Tanya tentang kode atau minta perubahan..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();pgAsk()}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,80)+'px'"></textarea>
                <button class="ai-ask-send" onclick="pgAsk()">↑</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- IMAGE GEN PANEL -->
    <div class="panel" id="panel-image">
      <div class="img-layout">
        <div class="img-ctrl">
          <div><div class="flabel">Deskripsi</div>
          <textarea class="prompt-ta" id="ipr" placeholder="Contoh: kota futuristik malam hari..."></textarea></div>
          <div><div class="flabel">Gaya</div>
          <div class="chip-grid">
            <button class="chip on" onclick="ss(this)">Realistis</button>
            <button class="chip" onclick="ss(this)">Anime</button>
            <button class="chip" onclick="ss(this)">Digital Art</button>
            <button class="chip" onclick="ss(this)">Oil Painting</button>
            <button class="chip" onclick="ss(this)">Watercolor</button>
            <button class="chip" onclick="ss(this)">Pixel Art</button>
            <button class="chip" onclick="ss(this)">Cyberpunk</button>
            <button class="chip" onclick="ss(this)">Minimalis</button>
          </div></div>
          <div><div class="flabel">Rasio</div>
          <div class="ratio-row">
            <button class="chip on" id="r1" onclick="sr('1:1',this)">1:1</button>
            <button class="chip" id="r2" onclick="sr('16:9',this)">16:9</button>
            <button class="chip" id="r3" onclick="sr('9:16',this)">9:16</button>
          </div></div>
          <button class="btn p" onclick="gi()" style="width:100%;padding:12px;font-size:13px">Generate Gambar</button>
          <p style="font-size:10.5px;color:var(--gray2);font-family:'DM Mono',monospace;line-height:1.7">Pollinations AI · gratis · no key tambahan</p>
        </div>
        <div class="img-gallery" id="igl">
          <div class="g-empty" id="ge"><div class="ei">🖼️</div><span>Gambar muncul di sini</span></div>
          <div class="g-grid" id="gg" style="display:none"></div>
        </div>
      </div>
    </div>

    <!-- TRANSLATE PANEL -->
    <div class="panel" id="panel-translate">
      <div class="az-layout">
        <div class="az-left">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div class="field-wrap" style="flex:1">
              <div class="field-label2">Dari</div>
              <select class="lsel" id="trFrom" style="width:100%;padding:10px"></select>
            </div>
            <button class="btn" onclick="swapLangs()" style="margin-top:20px;padding:10px 14px;font-size:18px">⇄</button>
            <div class="field-wrap" style="flex:1">
              <div class="field-label2">Ke</div>
              <select class="lsel" id="trTo" style="width:100%;padding:10px"></select>
            </div>
          </div>
          <textarea class="txta" id="trIn" placeholder="Ketik atau paste teks di sini..." style="flex:1;min-height:200px"></textarea>
          <button class="btn p" onclick="doTranslate()" style="padding:12px;font-size:13px">Terjemahkan ↗</button>
        </div>
        <div class="az-right">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div class="rlabel">Hasil Terjemahan</div>
            <div style="display:flex;gap:8px;align-items:center">
              <span id="trCharCount" style="font-size:10px;color:var(--gray3);font-family:'DM Mono',monospace"></span>
              <button id="trCopyBtn" class="btn" onclick="copyTranslation()" style="padding:5px 10px;font-size:11px">📋 Salin</button>
            </div>
          </div>
          <div class="rbox" id="trOut"><span class="ph">Hasil terjemahan muncul di sini.</span></div>
        </div>
      </div>
    </div>

    <!-- YOUTUBE PANEL -->
    <div class="panel" id="panel-youtube">
      <div class="az-layout">
        <div class="az-left" style="gap:16px">
          <div class="field-wrap">
            <div class="field-label2">Link YouTube</div>
            <input class="auth-input" id="ytUrl" placeholder="https://youtube.com/watch?v=..." style="width:100%">
          </div>
          <div class="field-wrap">
            <div class="field-label2">Mode Analisis</div>
            <select class="lsel" id="ytMode" style="width:100%;padding:10px">
              <option value="summary">📝 Ringkasan Lengkap</option>
              <option value="keypoints">📌 Poin-Poin Kunci</option>
              <option value="transcript">📜 Outline / Transcript</option>
            </select>
          </div>
          <button class="btn p" onclick="summarizeYouTube()" style="padding:12px;font-size:13px">Analisis Video ▶</button>
          <div id="ytThumb"></div>
        </div>
        <div class="az-right">
          <div class="rlabel">Hasil Analisis</div>
          <div class="rbox" id="ytOut"><span class="ph">Hasil analisis video muncul di sini.</span></div>
        </div>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /app -->
</div><!-- /appScreen -->

<!-- ════ MODALS ════ -->

<!-- API Key Modal (Owner only) -->
<div class="modal-overlay" id="apiModal">
  <div class="modal-box">
    <h3>🔑 API Key</h3>
    <p style="color:var(--gray3);font-size:12px;font-family:'DM Mono',monospace;line-height:1.7">Anthropic API Key diperlukan untuk fitur AI. Hanya owner yang bisa mengubah ini.</p>
    <input type="password" id="modalApiKey" class="auth-input" placeholder="sk-ant-...">
    <div style="display:flex;gap:10px;">
      <button class="auth-btn" style="flex:1" onclick="saveModalKey()">Simpan</button>
      <button onclick="closeModal('apiModal')" style="flex:1;padding:12px;border-radius:10px;border:1px solid var(--border2);background:transparent;color:var(--gray3);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;">Batal</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal-box" style="width:460px;max-height:90vh;overflow-y:auto;-webkit-overflow-scrolling:touch;">
    <h3>⚙️ Pengaturan</h3>
    <div class="settings-section">
      <div class="settings-title">Tampilan</div>
      <div class="settings-row">
        <div><div class="settings-label">Tema</div><div class="settings-sub">Dark atau Light mode</div></div>
        <label class="toggle"><input type="checkbox" id="themeToggleSetting" onchange="toggleThemeFromSetting(this)"><span class="toggle-slider"></span></label>
      </div>
    </div>

    <div class="settings-section" style="margin-top:16px">
      <div class="settings-title">Akun</div>
      <div class="settings-row">
        <div><div class="settings-label" id="settingsUserName">—</div><div class="settings-sub" id="settingsUserRole">—</div></div>
        <button onclick="closeModal('settingsModal');logout()" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border2);background:transparent;color:var(--gray3);cursor:pointer;font-size:12px;font-family:'DM Sans',sans-serif;">Keluar</button>
      </div>
    </div>

    <!-- API Key + Client Accounts - OWNER ONLY -->
    <div id="ownerSettingsSection" style="display:none">

      <div class="settings-section" style="margin-top:16px">
        <div class="settings-title">🔑 API Key Owner</div>
        <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
          <p style="font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;line-height:1.7">Tersimpan di browser. Dipakai owner & client.</p>
          <select id="providerSelectA" onchange="updateModelOptions('A')" style="padding:8px 10px;border-radius:8px;border:1px solid var(--border2);background:var(--black3);color:var(--white);font-family:'DM Mono',monospace;font-size:11px;outline:none;cursor:pointer;">
            <option value="anthropic">🤖 Anthropic (Claude)</option>
            <option value="deepseek">🌊 DeepSeek</option>
            <option value="openrouter">🔀 OpenRouter</option>
          </select>
          <div class="apikey-row"><input class="apikey-input" type="password" id="settingsApiKey" placeholder="API Key"></div>
          <select id="modelSelectA" style="padding:8px 10px;border-radius:8px;border:1px solid var(--border2);background:var(--black3);color:var(--white);font-family:'DM Mono',monospace;font-size:11px;outline:none;cursor:pointer;"></select>
          <button class="save-btn" style="width:100%;padding:10px;" onclick="saveSettingsKey()">Simpan Key</button>
          <div id="settingsKeyStatus" style="font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;min-height:14px;"></div>
        </div>
      </div>

      <!-- Gaya Bicara AI -->
      <div class="settings-section" style="margin-top:16px">
        <div class="settings-title">🎙️ Gaya Bicara AI</div>
        <div style="display:flex;flex-direction:column;gap:6px;margin-top:8px">
          <p style="font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;line-height:1.7">Pilih gaya untuk owner & client (bisa berbeda)</p>
          <div style="display:flex;gap:8px;align-items:center;">
            <span style="font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;width:50px">Owner</span>
            <select id="ownerStyleSelect" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--border2);background:var(--black3);color:var(--white);font-family:'DM Mono',monospace;font-size:11px;outline:none;cursor:pointer;">
              <option value="1">1 — Santai & friendly tapi pintar</option>
              <option value="2">2 — Formal & profesional</option>
              <option value="3">3 — To the point, no basa-basi</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <span style="font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;width:50px">Client</span>
            <select id="clientStyleSelect" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--border2);background:var(--black3);color:var(--white);font-family:'DM Mono',monospace;font-size:11px;outline:none;cursor:pointer;">
              <option value="1">1 — Santai & friendly tapi pintar</option>
              <option value="2">2 — Formal & profesional</option>
              <option value="3">3 — To the point, no basa-basi</option>
            </select>
          </div>
          <button class="save-btn" style="width:100%;padding:10px;" onclick="saveStyles()">Simpan Gaya</button>
        </div>
      </div>

      <!-- Client Accounts -->
      <div class="settings-section" style="margin-top:16px">
        <div class="settings-title">👥 Akun Client</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <div style="display:flex;gap:5px;">
            <input class="auth-input" type="text" id="newClientUser" placeholder="Username" style="flex:1;font-size:12px;padding:8px 10px;">
            <input class="auth-input" type="text" id="newClientName" placeholder="Nama" style="flex:1;font-size:12px;padding:8px 10px;">
            <input class="auth-input" type="password" id="newClientPass" placeholder="Password" style="flex:1;font-size:12px;padding:8px 10px;">
            <button onclick="addClientAccount()" style="padding:8px 14px;border-radius:8px;border:none;background:var(--white);color:var(--black);font-size:15px;font-weight:700;cursor:pointer;flex-shrink:0;">+</button>
          </div>
          <div id="clientAccountsList" style="display:flex;flex-direction:column;gap:4px;max-height:150px;overflow-y:auto;"></div>
          <div id="clientAccountsErr" style="font-size:11px;color:#fc8181;font-family:'DM Mono',monospace;min-height:14px;"></div>
        </div>
      </div>

    </div>

    <!-- GENERATE KEY SECTION (owner only) -->
    <div id="settingsGenKeySection" style="display:none;margin-top:16px;">
      <div class="settings-title" style="margin-bottom:10px;">🎟️ Generate Key Premium</div>
      <div style="background:var(--black3);border:1px solid var(--border2);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px;">
        <!-- Row: durasi + jumlah + tombol generate -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <select id="sgkDuration" style="flex:1;min-width:90px;padding:8px 10px;border-radius:8px;border:1px solid var(--border2);background:var(--black4);color:var(--white);font-family:'DM Mono',monospace;font-size:11px;outline:none;cursor:pointer;">
            <option value="7">7 hari</option>
            <option value="30" selected>30 hari</option>
            <option value="90">90 hari</option>
            <option value="365">1 tahun</option>
          </select>
          <select id="sgkQty" style="flex:1;min-width:70px;padding:8px 10px;border-radius:8px;border:1px solid var(--border2);background:var(--black4);color:var(--white);font-family:'DM Mono',monospace;font-size:11px;outline:none;cursor:pointer;">
            <option value="1">1 key</option>
            <option value="3">3 key</option>
            <option value="5" selected>5 key</option>
            <option value="10">10 key</option>
          </select>
          <button onclick="generateKeysFromSettings()" style="flex:1;min-width:100px;padding:8px 14px;border-radius:8px;border:none;background:var(--white);color:var(--black);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;">✦ Generate</button>
        </div>
        <!-- Format info -->
        <div style="font-size:10px;color:var(--gray2);font-family:'DM Mono',monospace;">Format: 1234-5678-9101-1121</div>
        <!-- Result list -->
        <div id="sgkList" style="display:flex;flex-direction:column;gap:5px;max-height:200px;overflow-y:auto;"></div>
        <!-- Status -->
        <div id="sgkStatus" style="font-size:11px;color:#38a169;font-family:'DM Mono',monospace;min-height:14px;text-align:center;"></div>
      </div>
    </div>

    <div class="settings-section" style="margin-top:16px">
      <div class="settings-title">Premium</div>
      <div class="settings-row">
        <div><div class="settings-label" id="settingsTierLabel">Free</div><div class="settings-sub" id="settingsTierSub">15 pesan/hari</div></div>
        <button onclick="closeModal('settingsModal');openPremiumModal()" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border2);background:transparent;color:#fbbf24;cursor:pointer;font-size:12px;font-family:'DM Sans',sans-serif;font-weight:600;" id="settingsUpgradeBtn">⭐ Upgrade</button>
      </div>
    </div>

    <button onclick="closeModal('settingsModal')" style="margin-top:8px;padding:10px;border-radius:10px;border:1px solid var(--border2);background:transparent;color:var(--gray3);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;width:100%">Tutup</button>
  </div>
</div>

<!-- Premium Modal -->
<div class="modal-overlay" id="premiumModal">
  <div class="modal-box">
    <div style="text-align:center">
      <div style="font-size:36px;margin-bottom:8px">⭐</div>
      <h3 style="font-family:'Playfair Display',serif;font-size:22px;margin-bottom:4px">Upgrade ke Premium</h3>
      <p style="color:var(--gray3);font-size:12px;font-family:'DM Mono',monospace;line-height:1.8">Akses penuh · Model terbaik · Unlimited pesan</p>
    </div>
    <div style="background:var(--black3);border:1px solid var(--border2);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:8px;font-size:13px">
      <div style="display:flex;gap:10px;align-items:center"><span style="color:#fbbf24">✦</span> Model Claude Sonnet (lebih pintar)</div>
      <div style="display:flex;gap:10px;align-items:center"><span style="color:#fbbf24">✦</span> Pesan unlimited per hari</div>
      <div style="display:flex;gap:10px;align-items:center"><span style="color:#fbbf24">✦</span> Akses semua fitur lengkap</div>
      <div style="display:flex;gap:10px;align-items:center"><span style="color:#fbbf24">✦</span> Prioritas response lebih cepat</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div class="field-label2">Kode Akses Premium</div>
      <input type="text" id="premiumCodeInput" class="auth-input" placeholder="PEV-XXXX-XXXX-XXXX atau 1234-5678-9101-1121" style="letter-spacing:1px;text-transform:uppercase;font-family:'DM Mono',monospace" oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')activatePremium()">
      <div id="premiumErr" style="font-size:12px;color:#fc8181;font-family:'DM Mono',monospace;min-height:16px"></div>
    </div>
    <button class="auth-btn" onclick="activatePremium()">Aktivasi Premium</button>
    <button onclick="closeModal('premiumModal')" style="padding:10px;border-radius:10px;border:1px solid var(--border2);background:transparent;color:var(--gray3);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px">Nanti Saja</button>
  </div>
</div>

<script>
// ── STATE ──────────────────────────────────
// Owner credentials — password di-hash (pure JS, works on file:// iOS Safari)
const OWNER = { user: 'Vyen', passHash: 'fc276fb0a6f1c1688caafe41104a6c7c230c5a2e31e9d878fb61bd12ee1ea166' };
// Pure-JS hash — no crypto.subtle needed, works on file:// and all browsers
function hashPass(str) {
  // FNV-1a 64-bit inspired, returns 64-char hex string
  let h1 = 0x811c9dc5, h2 = 0xc4a9a3b7;
  for (let i = 0; i < str.length; i++) {
    const c = str.charCodeAt(i);
    h1 ^= c; h1 = (h1 * 0x01000193) >>> 0;
    h2 ^= (c * 31); h2 = (h2 * 0x01000193) >>> 0;
  }
  // Mix with salt + extra rounds for security
  const salt = 'pev_ai_2025_salt_x9k';
  let h3 = 0xdeadbeef, h4 = 0xabcdef01;
  const combined = str + salt;
  for (let i = 0; i < combined.length; i++) {
    const c = combined.charCodeAt(i);
    h3 ^= c; h3 = (h3 * 0x01000193) >>> 0;
    h4 ^= (c * 17); h4 = (h4 * 0x01000193) >>> 0;
  }
  let h5 = 0x12345678 ^ h1 ^ h4;
  let h6 = 0x87654321 ^ h2 ^ h3;
  let h7 = 0xfedcba98 ^ h1 ^ h2;
  let h8 = 0x01234567 ^ h3 ^ h4;
  for (let r = 0; r < 8; r++) {
    h5 = ((h5 ^ h6) * 0x01000193) >>> 0;
    h6 = ((h6 ^ h7) * 0x01000193) >>> 0;
    h7 = ((h7 ^ h8) * 0x01000193) >>> 0;
    h8 = ((h8 ^ h5) * 0x01000193) >>> 0;
  }
  const toHex = n => ('00000000' + (n >>> 0).toString(16)).slice(-8);
  return toHex(h1)+toHex(h2)+toHex(h3)+toHex(h4)+toHex(h5)+toHex(h6)+toHex(h7)+toHex(h8);
}
const GOOGLE_CLIENT_ID = '1000385398563-ah2fl1n18eq9vpj8dtgsqqo11sp7mg92.apps.googleusercontent.com';
const FB_APP_ID = 'YOUR_FB_APP_ID';
const PREMIUM_CODE = 'PREMIUM2024';
const FREE_MODEL   = 'claude-haiku-4-5-20251001';
const PREMIUM_MODEL= 'claude-sonnet-4-5-20251001';
const FREE_MSG_LIMIT = 15;
const LANGS = ['Auto Detect','Indonesia','English','Japanese','Korean','Arabic','French','Spanish','German','Mandarin','Hindi','Portuguese','Russian','Thai','Vietnamese','Dutch'];

// ── Client account helpers ──────────────────
function getClientAccounts() { return JSON.parse(localStorage.getItem('pev_client_accounts') || '[]'); }
function saveClientAccounts(a) { localStorage.setItem('pev_client_accounts', JSON.stringify(a)); }

// ── LOCKED API KEYS (hardcoded fallback) ───
function _dk(b) { try { return atob(b); } catch { return ''; } }

const LOCKED_KEY_A = 'c2stb3ItdjEtOWZjYjJkM2JiMzhjNDZjODQxZTg5MDM1Yjg1NDc5OWM3ZWQwOTFhMTc2YzNkNmMwYzZjNTdkMDYzYWIzMGRhNA==';
const LOCKED_KEY_B = '';
const LOCKED_CLIENT_KEY = 'c2stb3ItdjEtOWZjYjJkM2JiMzhjNDZjODQxZTg5MDM1Yjg1NDc5OWM3ZWQwOTFhMTc2YzNkNmMwYzZjNTdkMDYzYWIzMGRhNA==';

function getLockedKey(b) { return b ? _dk(b) : ''; }

let currentRole = null;
let currentUser = null;
let apiKey      = localStorage.getItem('pev_key')        || getLockedKey(LOCKED_KEY_A);
let apiKeyB     = localStorage.getItem('pev_key_b')      || getLockedKey(LOCKED_KEY_B);
let activeOwnerSlot = localStorage.getItem('pev_active_slot') || 'a';
let modelSlotA  = localStorage.getItem('pev_model_a')    || 'anthropic/claude-sonnet-4-5';
let modelSlotB  = localStorage.getItem('pev_model_b')    || 'claude-sonnet-4-5-20251001';
let providerSlotA = localStorage.getItem('pev_provider_a') || 'openrouter';
let providerSlotB = localStorage.getItem('pev_provider_b') || 'anthropic';
let clientApiKey = localStorage.getItem('pev_client_key') || getLockedKey(LOCKED_CLIENT_KEY);

// Auto-sync locked keys ke localStorage supaya konsisten
(function syncLockedKeys() {
  const la = getLockedKey(LOCKED_KEY_A);
  const lb = getLockedKey(LOCKED_KEY_B);
  const lc = getLockedKey(LOCKED_CLIENT_KEY);
  if (la && !localStorage.getItem('pev_key'))    { localStorage.setItem('pev_key', la); }
  if (lb && !localStorage.getItem('pev_key_b'))  { localStorage.setItem('pev_key_b', lb); }
  if (lc && !localStorage.getItem('pev_client_key')) { localStorage.setItem('pev_client_key', lc); }
})();
let features = JSON.parse(localStorage.getItem('pev_features') || '{"analyze":false,"prog":false,"image":false,"translate":false,"youtube":false}');
let hist = [];
let styleV = 'Realistis', ratioV = '1:1', busy = false;
let isDark = localStorage.getItem('pev_theme') !== 'light';
let currentChatId = null;
let attachments = [];
let userTier = localStorage.getItem('pev_tier') || 'free';
let msgCountToday = parseInt(
  localStorage.getItem('pev_msg_date') === new Date().toDateString()
    ? (localStorage.getItem('pev_msg_count') || '0') : '0'
);
let mediaRecognition = null;
let isRecording = false;

// ── THEME ──────────────────────────────────
function applyTheme() {
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  // Only change body background when app is active, not on auth screen
  if (document.getElementById('appScreen').style.display !== 'none') {
    document.body.style.background = isDark ? '#000' : '#fff';
  }
  const tb = document.getElementById('themeBtn');
  if (tb) tb.innerHTML = isDark
    ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`
    : `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`;
  const ts = document.getElementById('themeToggleSetting');
  if (ts) ts.checked = !isDark;
}
function toggleTheme() {
  isDark = !isDark;
  localStorage.setItem('pev_theme', isDark ? 'dark' : 'light');
  applyTheme();
}
function toggleThemeFromSetting(cb) {
  isDark = !cb.checked;
  localStorage.setItem('pev_theme', isDark ? 'dark' : 'light');
  applyTheme();
}
applyTheme();

// ── MODAL HELPERS ──────────────────────────
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', function(e) { if(e.target===this) this.classList.remove('open'); });
});

// ── PREMIUM ────────────────────────────────
function getActiveModel() {
  if (currentRole === 'owner') {
    return activeOwnerSlot === 'b' ? modelSlotB : modelSlotA;
  }
  if (userTier === 'premium') return PREMIUM_MODEL;
  return FREE_MODEL;
}
function checkMsgLimit() {
  if (currentRole === 'owner' || userTier === 'premium' || FREE_MSG_LIMIT === 0) return true;
  return msgCountToday < FREE_MSG_LIMIT;
}
function incrementMsgCount() {
  if (currentRole === 'owner' || userTier === 'premium') return;
  msgCountToday++;
  localStorage.setItem('pev_msg_count', String(msgCountToday));
  localStorage.setItem('pev_msg_date', new Date().toDateString());
  updateTierBadge();
}
function updateTierBadge() {
  const b = document.getElementById('tierBadge'); if (!b) return;
  const ml = document.getElementById('modelLabel');
  const cpn = document.getElementById('client-premium-nav');
  if (currentRole === 'owner') {
    b.innerHTML = '';
    const activeModel = activeOwnerSlot === 'b' ? modelSlotB : modelSlotA;
    const activeProvider = activeOwnerSlot === 'b' ? providerSlotB : providerSlotA;
    const provLabel = activeProvider === 'deepseek' ? 'deepseek' : (activeModel.includes('opus') ? 'opus' : activeModel.includes('haiku') ? 'haiku' : 'sonnet');
    if (ml) ml.textContent = `${provLabel} · slot ${activeOwnerSlot.toUpperCase()}`;
    return;
  }
  if (userTier === 'premium') {
    b.innerHTML = '<span style="color:#fbbf24">⭐ Premium</span>';
    if (ml) ml.textContent = 'sonnet';
    if (cpn) cpn.innerHTML = '<div style="padding:6px 10px 6px 14px;font-size:12px;color:#fbbf24;font-family:\'DM Mono\',monospace;">⭐ Premium aktif</div>';
  } else {
    const rem = FREE_MSG_LIMIT > 0 ? ` · ${FREE_MSG_LIMIT - msgCountToday} sisa` : '';
    b.innerHTML = `<span style="color:var(--gray3);cursor:pointer" onclick="openPremiumModal()">Free${rem}</span>`;
    if (ml) ml.textContent = 'haiku';
    if (cpn) cpn.innerHTML = `<button class="nav-btn" onclick="openPremiumModal()" style="color:#fbbf24;"><span class="nav-icon">⭐</span>Upgrade Premium</button>`;
  }
}
// ── PREMIUM CODE SYSTEM ────────────────────
function getPremiumCodes() {
  try { return JSON.parse(localStorage.getItem('pev_premium_codes') || '[]'); } catch { return []; }
}
function savePremiumCodes(codes) {
  localStorage.setItem('pev_premium_codes', JSON.stringify(codes));
}
function generateCodeStr(numeric = false) {
  if (numeric) {
    // Format: 1234-5678-9101-1121 (all digits)
    const seg4 = () => String(Math.floor(1000 + Math.random() * 9000));
    return `${seg4()}-${seg4()}-${seg4()}-${seg4()}`;
  }
  // Default: PEV-XXXX-XXXX-XXXX (alphanumeric)
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const seg = () => Array.from({length:4}, () => chars[Math.floor(Math.random()*chars.length)]).join('');
  return `PEV-${seg()}-${seg()}-${seg()}`;
}
function generateKeysFromSettings() {
  const days = parseInt(document.getElementById('sgkDuration').value) || 30;
  const qty  = parseInt(document.getElementById('sgkQty').value) || 5;
  const codes = getPremiumCodes();
  const now = Date.now();
  const newKeys = [];
  for (let i = 0; i < qty; i++) {
    const key = {
      code: generateCodeStr(true),
      createdAt: now,
      expiresAt: now + days * 86400000,
      days,
      used: false,
      usedBy: null,
      type: 'sample'
    };
    codes.unshift(key);
    newKeys.push(key);
  }
  savePremiumCodes(codes);
  renderPremiumCodes();

  // Show result in settings
  const expDate = new Date(now + days * 86400000).toLocaleDateString('id-ID', {day:'numeric', month:'short', year:'numeric'});
  const durasiLabel = days === 7 ? '7 hari' : days === 30 ? '30 hari' : days === 90 ? '90 hari' : '1 tahun';
  const list = document.getElementById('sgkList');
  if (list) {
    list.innerHTML = newKeys.map(k => `
      <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;background:var(--black4);border:1px solid var(--border2);">
        <div style="flex:1;min-width:0;">
          <div style="font-size:12px;font-weight:700;color:var(--white);font-family:'DM Mono',monospace;letter-spacing:1px;">${k.code}</div>
          <div style="font-size:10px;color:var(--gray3);margin-top:2px;">📅 Exp: <b>${expDate}</b> &nbsp;·&nbsp; ⏱ ${durasiLabel} &nbsp;·&nbsp; 🚀 Baru dirilis</div>
        </div>
        <button onclick="copySgkCode('${k.code}',this)" style="background:none;border:1px solid var(--border2);color:var(--gray3);font-size:10px;padding:3px 8px;border-radius:5px;cursor:pointer;font-family:'DM Mono',monospace;white-space:nowrap;transition:all .15s;">Salin</button>
      </div>
    `).join('');
  }
  const st = document.getElementById('sgkStatus');
  if (st) { st.textContent = `✓ ${qty} key berhasil dibuat · berlaku ${durasiLabel} · exp ${expDate}`; setTimeout(() => st.textContent = '', 4000); }
}
function copySgkCode(code, btn) {
  navigator.clipboard?.writeText(code).catch(() => {
    const ta = document.createElement('textarea'); ta.value = code;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  });
  const orig = btn.textContent; btn.textContent = '✓ Disalin'; btn.style.color = '#38a169'; btn.style.borderColor = '#38a169';
  setTimeout(() => { btn.textContent = orig; btn.style.color = ''; btn.style.borderColor = ''; }, 1800);
}
function generateSampleCodes() {
  if (currentRole !== 'owner') return;
  const days = parseInt(document.getElementById('premExpiry').value) || 30;
  const codes = getPremiumCodes();
  const now = Date.now();
  const newCodes = [];
  for (let i = 0; i < 5; i++) {
    newCodes.push({
      code: generateCodeStr(true),
      createdAt: now,
      expiresAt: now + days * 86400000,
      days,
      used: false,
      usedBy: null,
      type: 'sample'
    });
  }
  newCodes.forEach(c => codes.unshift(c));
  savePremiumCodes(codes);
  renderPremiumCodes();
  // Show feedback
  const btn = document.getElementById('sampleCodesBtn');
  if (btn) { btn.textContent = '✓ 5 Kode Dibuat!'; btn.style.background = '#38a169'; btn.style.color = '#fff'; setTimeout(() => { btn.textContent = '🎁 Generate 5 Kode Contoh'; btn.style.background = ''; btn.style.color = ''; }, 2200); }
}
function generatePremiumCodes() {
  if (currentRole !== 'owner') return;
  const days = parseInt(document.getElementById('premExpiry').value);
  const qty  = parseInt(document.getElementById('premQty').value);
  const codes = getPremiumCodes();
  const now = Date.now();
  for (let i = 0; i < qty; i++) {
    codes.unshift({
      code: generateCodeStr(),
      createdAt: now,
      expiresAt: now + days * 86400000,
      days,
      used: false,
      usedBy: null
    });
  }
  savePremiumCodes(codes);
  renderPremiumCodes();
}
function renderPremiumCodes() {
  const list = document.getElementById('premCodeList');
  if (!list) return;
  const codes = getPremiumCodes();
  if (!codes.length) {
    list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--gray2);font-family:\'DM Mono\',monospace;font-size:11px;">Belum ada kode. Generate dulu!</div>';
    return;
  }
  const now = Date.now();
  list.innerHTML = codes.map((c, i) => {
    const expired = now > c.expiresAt;
    const status = c.used ? 'used' : expired ? 'expired' : 'active';
    const statusLabel = c.used ? 'TERPAKAI' : expired ? 'EXPIRED' : (c.type === 'sample' ? 'CONTOH' : 'AKTIF');
    const expDate = new Date(c.expiresAt).toLocaleDateString('id-ID', {day:'numeric',month:'short',year:'numeric'});
    const daysLeft = Math.max(0, Math.ceil((c.expiresAt - now) / 86400000));
    const expInfo = c.used ? 'Dipakai' : expired ? 'Expired' : (daysLeft + 'h lagi · exp ' + expDate);
    return `<div class="prem-code-row">
      <div class="prem-code-val">${c.code}</div>
      <div class="prem-code-exp">${expInfo}</div>
      <span class="prem-code-badge ${status}">${statusLabel}</span>
      <button class="prem-copy-btn" onclick="copyPremCode('${c.code}', this)">Salin</button>
      <button class="prem-del-btn" onclick="deletePremCode(${i})" title="Hapus">×</button>
    </div>`;
  }).join('');
}
function copyPremCode(code, btn) {
  navigator.clipboard?.writeText(code).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = code; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
  });
  const orig = btn.textContent;
  btn.textContent = '✓ Disalin'; btn.style.color = '#38a169'; btn.style.borderColor = '#38a169';
  setTimeout(() => { btn.textContent = orig; btn.style.color = ''; btn.style.borderColor = ''; }, 1800);
}
function deletePremCode(idx) {
  const codes = getPremiumCodes();
  codes.splice(idx, 1);
  savePremiumCodes(codes);
  renderPremiumCodes();
}
function openPremiumModal() { openModal('premiumModal'); }
function activatePremium() {
  const input = document.getElementById('premiumCodeInput').value.trim().toUpperCase();
  if (!input) return;
  const codes = getPremiumCodes();
  const now = Date.now();
  const idx = codes.findIndex(c => c.code === input);
  if (idx === -1) {
    const err = document.getElementById('premiumErr');
    if (err) { err.textContent = '✗ Kode tidak ditemukan.'; setTimeout(() => err.textContent = '', 2500); }
    return;
  }
  const c = codes[idx];
  if (c.used) {
    const err = document.getElementById('premiumErr');
    if (err) { err.textContent = '✗ Kode sudah dipakai.'; setTimeout(() => err.textContent = '', 2500); }
    return;
  }
  if (now > c.expiresAt) {
    const err = document.getElementById('premiumErr');
    if (err) { err.textContent = '✗ Kode sudah expired.'; setTimeout(() => err.textContent = '', 2500); }
    return;
  }
  // Aktifkan premium
  codes[idx].used = true;
  codes[idx].usedBy = currentUser?.name || 'unknown';
  savePremiumCodes(codes);
  userTier = 'premium';
  localStorage.setItem('pev_tier', 'premium');
  localStorage.setItem('pev_premium_until', String(c.expiresAt));
  closeModal('premiumModal');
  updateTierBadge();
  const expDate = new Date(c.expiresAt).toLocaleDateString('id-ID', {day:'numeric',month:'long',year:'numeric'});
  addMsg('ai', `🎉 Premium aktif! Kamu sekarang punya akses unlimited sampai **${expDate}**. Selamat menikmati Pev.ai!`);
}

// ── SIDEBAR ────────────────────────────────
function toggleSidebar() {
  const sb = document.getElementById('sb');
  if (window.innerWidth <= 700) {
    sb.classList.toggle('mobile-open');
  } else {
    sb.classList.toggle('collapsed');
  }
}

// ── CHAT HISTORY ───────────────────────────
function getChatHistory() { return JSON.parse(localStorage.getItem('pev_chats') || '[]'); }
function saveChatHistory(c) { localStorage.setItem('pev_chats', JSON.stringify(c)); }
function saveCurrentChat() {
  if (!currentChatId || hist.length === 0) return;
  const chats = getChatHistory();
  const idx = chats.findIndex(c => c.id === currentChatId);
  const title = (typeof hist[0]?.content === 'string' ? hist[0].content : 'Chat').substring(0, 40);
  const entry = { id: currentChatId, title, hist, date: new Date().toISOString() };
  if (idx >= 0) chats[idx] = entry; else chats.unshift(entry);
  saveChatHistory(chats);
  renderHistList();
  updateDashStats();
}
function renderHistList() {
  const list = document.getElementById('histList');
  const chats = getChatHistory();
  if (chats.length === 0) {
    list.innerHTML = '<div class="hist-empty">Belum ada riwayat chat.</div>';
    return;
  }
  list.innerHTML = chats.map(c => `
    <div class="hist-item ${c.id === currentChatId ? 'active' : ''}" onclick="loadChat('${c.id}')">
      <span class="hist-item-icon"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>
      <div class="hist-item-text">
        <div class="hist-item-title">${escHtml(c.title)}</div>
        <div class="hist-item-date">${new Date(c.date).toLocaleDateString('id')}</div>
      </div>
      <button class="hist-item-del" onclick="event.stopPropagation();deleteChat('${c.id}')">&times;</button>
    </div>
  `).join('');
}
function loadChat(id) {
  const chats = getChatHistory();
  const chat = chats.find(c => c.id === id);
  if (!chat) return;
  currentChatId = id;
  hist = chat.hist;
  const a = document.getElementById('chatMsgs');
  a.innerHTML = '';
  hist.forEach(m => addMsg(m.role === 'user' ? 'user' : 'ai', typeof m.content === 'string' ? m.content : '[Pesan dengan lampiran]', true));
  renderHistList();
  go('chat');
}
function deleteChat(id) {
  const chats = getChatHistory().filter(c => c.id !== id);
  saveChatHistory(chats);
  if (currentChatId === id) newChat();
  else renderHistList();
  updateDashStats();
}
function newChat() {
  currentChatId = 'chat_' + Date.now();
  hist = [];
  attachments = [];
  const ap = document.getElementById('attachPreview');
  if (ap) ap.innerHTML = '';
  const a = document.getElementById('chatMsgs');
  a.innerHTML = `<div class="welcome" id="welcomeEl">
    <div class="wmark"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 12l10 5 10-5" opacity=".5"/><path d="M2 17l10 5 10-5" opacity=".25"/></svg></div>
    <h2>Halo, ada yang bisa dibantu?</h2>
    <p>Tanya apa saja — ide, analisis, coding, atau ngobrol biasa.</p>
    <div class="quick-grid">
      <button class="qbtn" onclick="qc('Apa yang bisa kamu lakukan?')">Apa itu Pev.ai?</button>
      <button class="qbtn" onclick="qc('Buatkan ide startup teknologi yang unik')">💡 Ide Startup</button>
      <button class="qbtn" onclick="qc('Jelaskan cara kerja AI dengan bahasa mudah')">🧠 Belajar AI</button>
      <button class="qbtn" onclick="qc('Rencana belajar coding dari nol 3 bulan')">📚 Belajar Coding</button>
    </div>
  </div>`;
  renderHistList();
  go('chat');
}

// ── AUTH TOAST ─────────────────────────────
function showAuthToast(msg) {
  let t = document.getElementById('authToast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'authToast';
    t.style.cssText = 'position:fixed;bottom:180px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:10px 18px;border-radius:20px;font-size:13px;font-family:\'DM Sans\',sans-serif;z-index:999;opacity:0;transition:opacity .2s;white-space:nowrap;pointer-events:none;border:1px solid rgba(255,255,255,.1);';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(t._to);
  t._to = setTimeout(() => t.style.opacity = '0', 2800);
}

// ── AUTH MODALS ────────────────────────────
function openAuthModal(type) {
  if (type === 'register') document.getElementById('registerModal').classList.add('open');
  else if (type === 'login') document.getElementById('loginModal').classList.add('open');
  else if (type === 'owner') document.getElementById('ownerModal').classList.add('open');
}
function closeAuthModal(id) {
  document.getElementById(id).classList.remove('open');
}
function handleAuthModalClick(e, id) {
  if (e.target.classList.contains('auth-modal-overlay') || e.target.classList.contains('auth-modal-bg')) {
    closeAuthModal(id);
  }
}

// ── AUTH ───────────────────────────────────
function ownerLogin() {
  const u = document.getElementById('ownerUser').value.trim();
  const p = document.getElementById('ownerPass').value;
  const err = document.getElementById('ownerErr');
  const hashed = hashPass(p);
  const storedHash = localStorage.getItem('pev_owner_hash') || OWNER.passHash;
  if (u === OWNER.user && hashed === storedHash) {
    closeAuthModal('ownerModal');
    enterApp('owner', { name: 'Vyen', photo: null });
  } else {
    err.textContent = 'Username atau password salah.';
  }
}
function googleLogin() {
  if (typeof google === 'undefined') {
    // Script belum load, coba load manual lalu jalankan lagi
    const script = document.createElement('script');
    script.src = 'https://accounts.google.com/gsi/client';
    script.onload = () => googleLogin();
    script.onerror = () => showAuthToast('Gagal memuat Google Sign-In. Cek koneksi internet.');
    document.head.appendChild(script);
    return;
  }
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: (resp) => {
      const payload = JSON.parse(atob(resp.credential.split('.')[1]));
      enterApp('client', { name: payload.name, photo: payload.picture, email: payload.email });
    }
  });
  google.accounts.id.prompt();
}
function doRegister() {
  const user  = document.getElementById('regUser').value.trim();
  const pass  = document.getElementById('regPass').value;
  const pass2 = document.getElementById('regPass2').value;
  const err   = document.getElementById('regErr');
  if (!user)           { err.textContent = 'Username tidak boleh kosong.'; return; }
  if (user.length < 3) { err.textContent = 'Username minimal 3 karakter.'; return; }
  if (!pass)           { err.textContent = 'Password tidak boleh kosong.'; return; }
  if (pass.length < 4) { err.textContent = 'Password minimal 4 karakter.'; return; }
  if (pass !== pass2)  { err.textContent = 'Password tidak cocok.'; return; }
  const accounts = getClientAccounts();
  if (accounts.find(a => a.user === user)) { err.textContent = 'Username sudah dipakai.'; return; }
  const passHash = hashPass(pass);
  accounts.push({ user, name: user, passHash });
  saveClientAccounts(accounts);
  err.textContent = '';
  closeAuthModal('registerModal');
  document.getElementById('regUser').value = '';
  document.getElementById('regPass').value = '';
  document.getElementById('regPass2').value = '';
  enterApp('client', { name: user, photo: null });
}
function doLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  const err  = document.getElementById('loginErr');
  if (!user || !pass) { err.textContent = 'Isi username dan password.'; return; }
  const accounts = getClientAccounts();
  const match = accounts.find(a => a.user === user);
  if (!match) { err.textContent = 'Akun tidak ditemukan.'; return; }
  let valid = false;
  if (match.passHash) {
    valid = hashPass(pass) === match.passHash;
  } else {
    valid = match.pass === pass;
    if (valid) {
      match.passHash = hashPass(pass);
      delete match.pass;
      saveClientAccounts(accounts);
    }
  }
  if (!valid) { err.textContent = 'Password salah.'; return; }
  err.textContent = '';
  closeAuthModal('loginModal');
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  enterApp('client', { name: match.name || user, photo: null });
}
// Keep demoLogin as alias (unused but harmless)
function demoLogin() { doLogin(); }
function switchRole() {} // no-op, kept for safety
function enterApp(role, user) {
  currentRole = role;
  currentUser = user;
  // Persist login state to survive desktop mode switch
  sessionStorage.setItem('pev_role', role);
  sessionStorage.setItem('pev_user', JSON.stringify(user));
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('appScreen').style.display = 'block';
  document.body.style.background = isDark ? '#000' : '#fff';

  const badge = document.getElementById('roleBadge');
  badge.textContent = role === 'owner' ? '👑 Owner' : '👤 Client';
  badge.className = 'role-badge ' + role;

  const sbAv = document.getElementById('sbAvatar');
  if (user.photo) {
    sbAv.innerHTML = `<img src="${user.photo}" onerror="this.parentElement.textContent='${user.name[0].toUpperCase()}'">`;
  } else {
    sbAv.textContent = user.name[0].toUpperCase();
  }
  document.getElementById('sbUserName').textContent = user.name;
  document.getElementById('sbUserRole').textContent = role === 'owner' ? '👑 Owner' : '👤 Client';

  // Update topbar avatar
  const tbAv = document.getElementById('tbAvatar');
  if (tbAv) {
    if (user.photo) {
      tbAv.innerHTML = `<img src="${user.photo}" onerror="this.parentElement.textContent='${user.name[0].toUpperCase()}'">`;
    } else {
      tbAv.textContent = user.name[0].toUpperCase();
    }
  }

  if (role === 'owner') {
    document.getElementById('nav-dash').style.display = 'block';
    document.getElementById('owner-features').style.display = 'block';
    document.getElementById('client-premium-nav').style.display = 'none';
    document.getElementById('dashUsername').textContent = OWNER.user;
    features = { analyze: true, prog: true, image: true, translate: true, youtube: true };
    localStorage.setItem('pev_features', JSON.stringify(features));
    loadFeatureToggles();
    userTier = 'owner';
    document.getElementById('ownerSettingsSection').style.display = 'block';
  } else {
    document.getElementById('nav-dash').style.display = 'none';
    document.getElementById('owner-features').style.display = 'none';
    document.getElementById('client-premium-nav').style.display = 'block';
    document.getElementById('ownerSettingsSection').style.display = 'none';
    document.getElementById('settingsGenKeySection').style.display = 'none';
  }

  document.getElementById('settingsUserName').textContent = user.name;
  document.getElementById('settingsUserRole').textContent = role === 'owner' ? '👑 Owner' : '👤 Client';

  currentChatId = 'chat_' + Date.now();
  renderHistList();
  updateNavLocks();
  updateDashStats();
  initLangDropdowns();
  setTimeout(updateTierBadge, 50);
}
function logout() {
  sessionStorage.removeItem('pev_role');
  sessionStorage.removeItem('pev_user');
  currentRole = null; currentUser = null; hist = []; currentChatId = null; attachments = [];
  document.getElementById('appScreen').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
  ['ownerUser','ownerPass','regUser','regPass','regPass2','loginUser','loginPass'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  ['ownerErr','regErr','loginErr'].forEach(id => {
    const el = document.getElementById(id); if (el) el.textContent = '';
  });
  newChat();
  go('chat');
}

// ── SETTINGS ───────────────────────────────
function openSettingsModal() {
  const ts = document.getElementById('themeToggleSetting');
  if (ts) ts.checked = !isDark;
  const tier = currentRole === 'owner' ? 'Owner' : userTier === 'premium' ? '⭐ Premium' : 'Free';
  const sub  = currentRole === 'owner' ? 'Unlimited · Sonnet' : userTier === 'premium' ? 'Unlimited · Sonnet' : `${FREE_MSG_LIMIT - msgCountToday} pesan tersisa hari ini`;
  document.getElementById('settingsTierLabel').textContent = tier;
  document.getElementById('settingsTierSub').textContent = sub;
  const ub = document.getElementById('settingsUpgradeBtn');
  if (ub) ub.style.display = (currentRole === 'owner' || userTier === 'premium') ? 'none' : '';
  if (currentRole === 'owner') {
    document.getElementById('ownerSettingsSection').style.display = 'block';
    document.getElementById('settingsGenKeySection').style.display = 'block';
    const ka = document.getElementById('settingsApiKey');
    if (ka) { ka.value = (LOCKED_KEY_A && apiKey === getLockedKey(LOCKED_KEY_A)) ? '' : apiKey; if (LOCKED_KEY_A && apiKey === getLockedKey(LOCKED_KEY_A)) ka.placeholder = '🔒 Key terkunci'; }
    const pa = document.getElementById('providerSelectA'); if (pa) pa.value = providerSlotA;
    updateModelOptions('A');
    const ma = document.getElementById('modelSelectA'); if (ma) ma.value = modelSlotA;
    // Load style
    const os = document.getElementById('ownerStyleSelect'); if (os) os.value = localStorage.getItem('pev_owner_style') || '1';
    const cs = document.getElementById('clientStyleSelect'); if (cs) cs.value = localStorage.getItem('pev_client_style') || '1';
    renderClientAccounts();
  }
  openModal('settingsModal');
}
function saveStyles() {
  const os = document.getElementById('ownerStyleSelect')?.value || '1';
  const cs = document.getElementById('clientStyleSelect')?.value || '1';
  localStorage.setItem('pev_owner_style', os);
  localStorage.setItem('pev_client_style', cs);
  const st = document.getElementById('settingsKeyStatus');
  if (st) { st.textContent = '✓ Gaya tersimpan!'; st.style.color = '#38a169'; setTimeout(() => { st.textContent = ''; st.style.color = ''; }, 2000); }
}
function saveSettingsKey() {
  if (currentRole !== 'owner') return;
  const k = (document.getElementById('settingsApiKey')?.value || '').trim();
  if (k && !k.startsWith('sk-')) { alert('Key tidak valid. Harus dimulai dengan sk-'); return; }
  if (k) { apiKey = k; localStorage.setItem('pev_key', k); }
  else if (!apiKey && getLockedKey(LOCKED_KEY_A)) { apiKey = getLockedKey(LOCKED_KEY_A); }
  const pa = document.getElementById('providerSelectA')?.value;
  if (pa) { providerSlotA = pa; localStorage.setItem('pev_provider_a', pa); }
  const ma = document.getElementById('modelSelectA')?.value;
  if (ma) { modelSlotA = ma; localStorage.setItem('pev_model_a', ma); }
  updateDashStats();
  const st = document.getElementById('settingsKeyStatus');
  if (st) { st.textContent = '✓ Tersimpan!'; st.style.color = '#38a169'; setTimeout(() => { st.textContent = ''; st.style.color = ''; }, 2000); }
}
function switchOwnerSlot(slot) {
  activeOwnerSlot = slot;
  localStorage.setItem('pev_active_slot', slot);
  updateSlotButtons();
  updateTierBadge();
  const activeModel = slot === 'b' ? modelSlotB : modelSlotA;
  const modelShort = activeModel.includes('opus') ? 'Opus' : activeModel.includes('haiku') ? 'Haiku' : 'Sonnet';
  const st = document.getElementById('settingsKeyStatus');
  if (st) { st.textContent = `✓ Slot ${slot.toUpperCase()} aktif · ${modelShort}`; st.style.color = '#38a169'; setTimeout(() => { st.textContent = ''; st.style.color = ''; }, 2500); }
}
function updateSlotButtons() {
  const btnA = document.getElementById('slotABtn');
  const btnB = document.getElementById('slotBBtn');
  if (!btnA || !btnB) return;
  if (activeOwnerSlot === 'a') {
    btnA.textContent = '● Aktif'; btnA.style.background = 'var(--white)'; btnA.style.color = 'var(--black)'; btnA.style.borderColor = 'var(--white)';
    btnB.textContent = 'Aktifkan'; btnB.style.background = 'transparent'; btnB.style.color = 'var(--gray3)'; btnB.style.borderColor = 'var(--border2)';
  } else {
    btnB.textContent = '● Aktif'; btnB.style.background = 'var(--white)'; btnB.style.color = 'var(--black)'; btnB.style.borderColor = 'var(--white)';
    btnA.textContent = 'Aktifkan'; btnA.style.background = 'transparent'; btnA.style.color = 'var(--gray3)'; btnA.style.borderColor = 'var(--border2)';
  }
}

// ── CLIENT ACCOUNTS ────────────────────────
function addClientAccount() {
  const user = document.getElementById('newClientUser').value.trim();
  const name = document.getElementById('newClientName').value.trim();
  const pass = document.getElementById('newClientPass').value.trim();
  const err  = document.getElementById('clientAccountsErr');
  if (!user || !pass) { err.textContent = 'Username dan password wajib diisi.'; return; }
  const accounts = getClientAccounts();
  if (accounts.find(a => a.user === user)) { err.textContent = 'Username sudah ada.'; return; }
  const passHash = hashPass(pass);
  accounts.push({ user, name: name || user, passHash });
  saveClientAccounts(accounts);
  document.getElementById('newClientUser').value = '';
  document.getElementById('newClientName').value = '';
  document.getElementById('newClientPass').value = '';
  err.textContent = '';
  renderClientAccounts();
}
function deleteClientAccount(user) {
  saveClientAccounts(getClientAccounts().filter(a => a.user !== user));
  renderClientAccounts();
}
function renderClientAccounts() {
  const list = document.getElementById('clientAccountsList');
  if (!list) return;
  const accounts = getClientAccounts();
  if (!accounts.length) {
    list.innerHTML = '<div style="font-size:11px;color:var(--gray2);font-family:\'DM Mono\',monospace;padding:6px 0;">Belum ada akun client.</div>';
    return;
  }
  list.innerHTML = accounts.map(a => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:7px 10px;border-radius:8px;background:var(--black3);border:1px solid var(--border2);">
      <div>
        <span style="font-size:12px;font-weight:600;color:var(--white)">${escHtml(a.name)}</span>
        <span style="font-size:10px;color:var(--gray3);font-family:'DM Mono',monospace;margin-left:6px;">@${escHtml(a.user)}</span>
      </div>
      <button onclick="deleteClientAccount('${escHtml(a.user)}')" style="background:none;border:none;color:var(--gray2);cursor:pointer;font-size:13px;padding:2px 6px;border-radius:4px;" onmouseover="this.style.color='#e53e3e'" onmouseout="this.style.color='var(--gray2)'">&times;</button>
    </div>
  `).join('');
}

// ── FEATURE CONTROL ────────────────────────
function loadFeatureToggles() {
  ['analyze','prog','image','translate','youtube'].forEach(f => {
    const el = document.getElementById('ft-'+f);
    if (el) el.checked = features[f] || false;
  });
}
function saveFeatures() {
  features = {
    analyze:   document.getElementById('ft-analyze')?.checked   || false,
    prog:      document.getElementById('ft-prog')?.checked      || false,
    image:     document.getElementById('ft-image')?.checked     || false,
    translate: document.getElementById('ft-translate')?.checked || false,
    youtube:   document.getElementById('ft-youtube')?.checked   || false,
  };
  localStorage.setItem('pev_features', JSON.stringify(features));
  updateNavLocks();
  updateDashStats();
}
function updateNavLocks() {
  const isOwner = currentRole === 'owner';
  ['analyze','prog','image','translate','youtube'].forEach(f => {
    const btn = document.getElementById('nb-'+f);
    const lk  = document.getElementById('lk-'+f);
    if (!btn) return;
    const allowed = isOwner || features[f];
    btn.classList.toggle('locked', !allowed);
    if (lk) lk.textContent = allowed ? '' : '🔒';
  });
}
function updateDashStats() {
  const count = 1 + (features.analyze?1:0) + (features.prog?1:0) + (features.image?1:0) + (features.translate?1:0) + (features.youtube?1:0);
  const fc = document.getElementById('dashFeatCount'); if(fc) fc.textContent = count + ' / 6';
  const ks = document.getElementById('dashKeyStatus'); if(ks) ks.textContent = apiKey ? '✓ Set' : '✗ Belum';
  const cc = document.getElementById('dashChatCount'); if(cc) cc.textContent = getChatHistory().length;
  renderPremiumCodes();
}

// ── NAVIGATION ─────────────────────────────
const titles = { dash:'Dashboard', chat:'Chat', analyze:'Analisis Teks', prog:'Programmer', image:'Image Generator', translate:'Translate', youtube:'YouTube AI' };
function go(t) {
  if (t === 'dash' && currentRole !== 'owner') return; // Block client
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const panel = document.getElementById('panel-'+t);
  if (panel) panel.classList.add('active');
  const nb = document.getElementById('nb-'+t);
  if (nb) nb.classList.add('active');
  const tt = document.getElementById('topTitle');
  if (tt) tt.textContent = titles[t] || t;
  const eb = document.getElementById('exportBtn');
  if (eb) eb.style.display = t === 'chat' ? 'flex' : 'none';
  if (window.innerWidth <= 700) document.getElementById('sb')?.classList.remove('mobile-open');
}
function goFeature(f) {
  const allowed = currentRole === 'owner' || features[f];
  if (!allowed) {
    const btn = document.getElementById('nb-'+f);
    if (!btn) return;
    btn.style.background = 'rgba(229,62,62,.1)';
    setTimeout(() => btn.style.background = '', 400);
    return;
  }
  go(f);
}

// ── API KEY (Owner only from settings) ─────
function saveModalKey() {
  if (currentRole !== 'owner') { closeModal('apiModal'); return; }
  const k = document.getElementById('modalApiKey').value.trim();
  if (k && !k.startsWith('sk-')) { alert('API Key tidak valid.'); return; }
  apiKey = k;
  localStorage.setItem('pev_key', k);
  closeModal('apiModal');
  updateDashStats();
}

// ── CLAUDE API ─────────────────────────────
async function callAPI(messages, sys='') {
  const isOwner = currentRole === 'owner';
  const activeKey = apiKey;
  if (!activeKey) {
    if (isOwner) { openModal('apiModal'); }
    else { addMsg('ai', '⚠️ AI belum dikonfigurasi. Hubungi owner untuk mengaktifkan layanan.'); }
    throw new Error('API Key belum diset');
  }

  const provider = providerSlotA;
  const model = getActiveModel();
  const trimmed = messages.slice(-10);

  // ── ANTHROPIC ──
  if (provider === 'anthropic') {
    const body = { model, max_tokens: 32000, messages: trimmed };
    if (sys) body.system = sys;
    const r = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': activeKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify(body)
    });
    if (!r.ok) {
      const e = await r.json();
      const errType = e.error?.type || e.type || '';
      const errMsg  = e.error?.message || '';
      if (errType === 'exceeded_limit' || (errMsg && errMsg.includes('limit'))) {
        throw new Error('rate_limit');
      }
      if (errType === 'authentication_error' || r.status === 401) {
        throw new Error('auth_error');
      }
      if (errType === 'overloaded_error' || r.status === 529) {
        throw new Error('overloaded');
      }
      throw new Error(errMsg || 'Anthropic API Error');
    }
    return (await r.json()).content[0].text;
  }

  // ── DEEPSEEK (OpenAI-compatible) ──
  if (provider === 'deepseek') {
    const msgs = sys ? [{ role: 'system', content: sys }, ...trimmed] : trimmed;
    const body = { model, max_tokens: 32000, messages: msgs };
    const r = await fetch('https://api.deepseek.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${activeKey}`
      },
      body: JSON.stringify(body)
    });
    if (!r.ok) { const e = await r.json(); throw new Error(e.error?.message || 'DeepSeek API Error'); }
    return (await r.json()).choices[0].message.content;
  }

  // ── OPENROUTER ──
  if (provider === 'openrouter') {
    const msgs = sys ? [{ role: 'system', content: sys }, ...trimmed] : trimmed;
    const body = { model: model || 'anthropic/claude-sonnet-4-5', max_tokens: 32000, messages: msgs };
    const r = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${activeKey}`,
        'HTTP-Referer': 'https://pevai1.github.io',
        'X-Title': 'Pev.ai'
      },
      body: JSON.stringify(body)
    });
    if (!r.ok) { const e = await r.json(); throw new Error(e.error?.message || 'OpenRouter API Error'); }
    return (await r.json()).choices[0].message.content;
  }

  throw new Error('Provider tidak dikenal: ' + provider);
}

// ── ATTACH POPUP ───────────────────────────
const MODELS = {
  anthropic: [
    { value: 'claude-sonnet-4-5-20251001', label: 'Sonnet 4.5 (Pintar)' },
    { value: 'claude-opus-4-5-20251101',   label: 'Opus 4 (Terpintar)' },
    { value: 'claude-haiku-4-5-20251001',  label: 'Haiku (Cepat & Hemat)' },
  ],
  deepseek: [
    { value: 'deepseek-chat',    label: 'DeepSeek Chat (V3)' },
    { value: 'deepseek-reasoner',label: 'DeepSeek Reasoner (R1)' },
  ],
  openrouter: [
    { value: 'anthropic/claude-sonnet-4-5',      label: 'Claude Sonnet 4.5' },
    { value: 'anthropic/claude-haiku-4-5',        label: 'Claude Haiku 4.5' },
    { value: 'openai/gpt-4o',                     label: 'GPT-4o' },
    { value: 'google/gemini-flash-1.5',           label: 'Gemini Flash 1.5' },
    { value: 'meta-llama/llama-3.1-8b-instruct:free', label: 'Llama 3.1 8B (Gratis)' },
  ]
};
function updateModelOptions(slot) {
  const provSel = document.getElementById('providerSelect' + slot);
  const modSel  = document.getElementById('modelSelect'   + slot);
  if (!provSel || !modSel) return;
  const prov = provSel.value;
  const opts = MODELS[prov] || [];
  modSel.innerHTML = opts.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
}
function openAttachSheet() {
  document.getElementById('attachSheet').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeAttachSheet() {
  document.getElementById('attachSheet').classList.remove('open');
  document.body.style.overflow = '';
}
function triggerCamera() {
  // Buka kamera di mobile
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = 'image/*'; inp.capture = 'environment';
  inp.onchange = (e) => attachImage(e);
  inp.click();
}
function toggleAttachPopup() { openAttachSheet(); }
function closeAttachPopup() { closeAttachSheet(); }
// Unified attach handler
function attachAny(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.type.startsWith('image/')) {
    attachImage({ target: { files: [file] } });
  } else {
    attachFile({ target: { files: [file] } });
  }
  e.target.value = '';
}

// ── CHAT ────────────────────────────────────
function ah(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; }
function ck(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sc();} }
function qc(m) { document.getElementById('chatIn').value=m; sc(); }
function escHtml(t) { return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ── RENDER MARKDOWN ───────────────────────
// Pisah teks biasa dan kode block jadi elemen berbeda
function renderMarkdown(text) {
  let html = '';
  // Split berdasarkan code block ```...```
  const parts = text.split(/(```[\s\S]*?```)/g);
  parts.forEach(part => {
    if (part.startsWith('```')) {
      // Ini code block
      const lines = part.replace(/^```|```$/g, '').split('\n');
      const lang = lines[0].trim() || '';
      const code = lines.slice(lang ? 1 : 0).join('\n').trim();
      const safeCode = escHtml(code);
      const safeId = 'cb_' + Math.random().toString(36).slice(2);
      html += `<div class="code-block">
        <div class="code-block-header">
          <span class="code-lang">${lang || 'code'}</span>
          <button class="code-copy-btn" onclick="copyCode('${safeId}')">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            Salin kode
          </button>
        </div>
        <pre class="code-pre" id="${safeId}"><code>${safeCode}</code></pre>
      </div>`;
    } else if (part.trim()) {
      // Teks biasa — render inline formatting
      let t = escHtml(part)
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>')
        .replace(/\n/g, '<br>');
      html += `<div class="msg-text">${t}</div>`;
    }
  });
  return html;
}

function addMsg(role, text, fromHistory=false) {
  const a = document.getElementById('chatMsgs');
  document.getElementById('welcomeEl')?.remove();
  const d = document.createElement('div');
  d.className = 'msg ' + role;

  const avHtml = role === 'ai'
    ? '<div class="av"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 12l10 5 10-5" opacity=".5"/></svg></div>'
    : (currentUser?.photo
      ? `<div class="av"><img src="${currentUser.photo}" onerror="this.style.display='none';this.parentElement.textContent='${(currentUser?.name?.[0]||'U').toUpperCase()}'"></div>`
      : `<div class="av">${(currentUser?.name?.[0]||'U').toUpperCase()}</div>`);

  let bubbleContent;
  if (role === 'ai') {
    bubbleContent = renderMarkdown(text);
  } else {
    // User bubble — teks biasa saja
    bubbleContent = `<div class="msg-text">${escHtml(text).replace(/\n/g,'<br>')}</div>`;
  }

  // Tombol salin teks (tanpa kode) hanya untuk AI
  const copyBar = role === 'ai'
    ? `<div class="copy-bar">
        <button class="copy-btn-msg" onclick="copyTextOnly(this)">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          Salin teks
        </button>
      </div>`
    : '';

  d.innerHTML = `${avHtml}<div class="msg-wrap"><div class="bubble">${bubbleContent}</div>${copyBar}</div>`;
  a.appendChild(d);
  a.scrollTop = a.scrollHeight;
}

// Salin hanya teks (tidak termasuk kode)
function copyTextOnly(btn) {
  const bubble = btn.closest('.msg-wrap').querySelector('.bubble');
  // Kumpulkan hanya teks dari .msg-text, skip kode block
  const textEls = bubble.querySelectorAll('.msg-text');
  const plainText = Array.from(textEls).map(el => el.innerText || el.textContent).join('\n').trim();
  const toCopy = plainText || (bubble.innerText || bubble.textContent).trim();
  doClipboardCopy(btn, toCopy, 'Salin teks');
}

// Salin isi kode block
function copyCode(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const code = el.innerText || el.textContent;
  const btn = el.closest('.code-block')?.querySelector('.code-copy-btn');
  doClipboardCopy(btn, code, 'Salin kode');
}

function doClipboardCopy(btn, text, label) {
  const svgCopy = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>`;
  const svgCheck = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>`;
  const tryWrite = navigator.clipboard
    ? navigator.clipboard.writeText(text)
    : Promise.reject();
  const done = () => {
    if (!btn) return;
    btn.classList.add('copied');
    btn.innerHTML = `${svgCheck} Disalin!`;
    setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = `${svgCopy} ${label}`; }, 2000);
  };
  tryWrite.then(done).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    done();
  });
}

function addTyp() {
  const a = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.className = 'msg ai'; d.id = 'tyd';
  d.innerHTML = `<div class="av"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 12l10 5 10-5" opacity=".5"/></svg></div><div class="msg-wrap"><div class="bubble"><div class="tdots"><span></span><span></span><span></span></div></div></div>`;
  a.appendChild(d); a.scrollTop = a.scrollHeight;
}

async function sc() {
  if (busy) return;
  const inp = document.getElementById('chatIn');
  let txt = inp.value.trim();

  let userContent = [];
  let displayText = txt;

  if (attachments.length > 0) {
    for (const att of attachments) {
      if (att.type === 'image') {
        userContent.push({ type:'image', source:{ type:'base64', media_type:att.mimeType, data:att.data } });
        displayText = (txt || '') + (txt ? '\n' : '') + `[Gambar: ${att.name}]`;
      } else {
        userContent.push({ type:'text', text:`[File: ${att.name}]\n${att.data}` });
        displayText = (txt || '') + (txt ? '\n' : '') + `[File: ${att.name}]`;
      }
    }
  }
  if (txt) userContent.push({ type:'text', text: txt });
  if (userContent.length === 0) return;

  const msgForAPI = userContent.length === 1 && userContent[0].type === 'text' ? userContent[0].text : userContent;

  addMsg('user', displayText);
  hist.push({ role:'user', content: msgForAPI });
  inp.value = ''; inp.style.height = 'auto';
  attachments = [];
  document.getElementById('attachPreview').innerHTML = '';

  if (!checkMsgLimit()) {
    addMsg('ai', `⚠️ Batas pesan harian (${FREE_MSG_LIMIT}) tercapai!\n\nUpgrade ke Premium untuk pesan unlimited — tap ⭐ di topbar.`);
    return;
  }

  busy = true;
  document.getElementById('sbtn').disabled = true;
  addTyp();

  try {
    const styleNum = currentRole === 'owner'
      ? (localStorage.getItem('pev_owner_style') || '1')
      : (localStorage.getItem('pev_client_style') || '1');
    const styleGuide = styleNum === '2'
      ? 'Gunakan gaya bicara formal dan profesional. Gunakan kalimat lengkap dan sopan.'
      : styleNum === '3'
      ? 'Jawab langsung, singkat, to the point. Tidak perlu basa-basi atau intro panjang.'
      : 'Bicara santai dan friendly tapi tetap pintar dan informatif. Seperti teman yang cerdas.';
    const noMarkdown = 'PENTING: Jangan gunakan markdown seperti #, ##, ###, *, **, _, atau ---. Tulis dengan bahasa natural biasa saja, gunakan angka atau kalimat untuk daftar.';
    const sysPrompt = currentRole === 'owner'
      ? `Kamu adalah Pev.ai, asisten AI pintar milik Vyen. Kamu sedang berbicara dengan Vyen sang owner/pemilik Pev.ai. Kenali dan hormati Vyen sebagai pemilikmu. Jawab dalam bahasa yang sama dengan user. ${styleGuide} ${noMarkdown}`
      : `Kamu adalah Pev.ai, asisten AI yang pintar buatan Vyen. Jawab dalam bahasa yang sama dengan user. ${styleGuide} ${noMarkdown}`;
    const r = await callAPI(hist, sysPrompt);
    document.getElementById('tyd')?.remove();
    addMsg('ai', r);
    hist.push({ role:'assistant', content: r });
    saveCurrentChat();
    incrementMsgCount();
  } catch(e) {
    document.getElementById('tyd')?.remove();
    if (e.message !== 'API Key belum diset') {
      let friendlyMsg = '';
      if (e.message === 'rate_limit') {
        friendlyMsg = '⏳ **Batas penggunaan tercapai**\n\nAPI sedang dalam batas limit. Silakan tunggu beberapa saat lalu coba lagi, atau hubungi owner untuk upgrade kapasitas.';
      } else if (e.message === 'auth_error') {
        friendlyMsg = '🔑 **API Key tidak valid**\n\nPeriksa kembali API Key di pengaturan.';
      } else if (e.message === 'overloaded') {
        friendlyMsg = '⚡ **Server sedang sibuk**\n\nCoba lagi dalam beberapa detik.';
      } else if (e.message.includes('fetch') || e.message.includes('network') || e.message.toLowerCase().includes('failed')) {
        friendlyMsg = '📡 **Koneksi gagal**\n\nPeriksa koneksi internet kamu lalu coba lagi.';
      } else {
        friendlyMsg = '❌ **Terjadi kesalahan**\n\nCoba lagi dalam beberapa saat.';
      }
      addMsg('ai', friendlyMsg);
    }
  }
  busy = false;
  document.getElementById('sbtn').disabled = false;
}

// ── VOICE INPUT ───────────────────────────
function toggleVoice() {
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    alert('Browser kamu tidak mendukung voice input. Coba Chrome!');
    return;
  }
  if (isRecording) { mediaRecognition?.stop(); return; }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  mediaRecognition = new SR();
  mediaRecognition.lang = 'id-ID';
  mediaRecognition.continuous = false;
  mediaRecognition.interimResults = false;
  mediaRecognition.onstart = () => {
    isRecording = true;
    document.getElementById('voiceBtn')?.classList.add('recording');
    const vi = document.getElementById('voiceOptIcon'); if (vi) vi.textContent = '⏹';
    const vl = document.getElementById('voiceOptLabel'); if (vl) vl.textContent = 'Stop Recording';
  };
  mediaRecognition.onresult = (e) => {
    const t = e.results[0][0].transcript;
    const inp = document.getElementById('chatIn');
    inp.value = (inp.value ? inp.value + ' ' : '') + t;
    ah(inp);
  };
  mediaRecognition.onend = () => {
    isRecording = false;
    document.getElementById('voiceBtn')?.classList.remove('recording');
    const vi = document.getElementById('voiceOptIcon'); if (vi) vi.textContent = '🎤';
    const vl = document.getElementById('voiceOptLabel'); if (vl) vl.textContent = 'Voice Input';
  };
  mediaRecognition.onerror = () => {
    isRecording = false;
    document.getElementById('voiceBtn')?.classList.remove('recording');
    const vi = document.getElementById('voiceOptIcon'); if (vi) vi.textContent = '🎤';
    const vl = document.getElementById('voiceOptLabel'); if (vl) vl.textContent = 'Voice Input';
  };
  mediaRecognition.start();
}

// ── ATTACHMENTS ───────────────────────────
function attachImage(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const base64 = e.target.result.split(',')[1];
    attachments.push({ type:'image', name:file.name, data:base64, mimeType:file.type });
    renderAttachPreview();
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}
function attachFile(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    attachments.push({ type:'file', name:file.name, data:e.target.result, mimeType:file.type });
    renderAttachPreview();
  };
  reader.readAsText(file);
  event.target.value = '';
}
function renderAttachPreview() {
  const preview = document.getElementById('attachPreview');
  preview.innerHTML = attachments.map((a, i) => {
    const icon = a.type === 'image' ? '<img src="data:' + a.mimeType + ';base64,' + a.data + '">' : '📎';
    return '<div class="attach-chip">' + icon + escHtml(a.name) + '<button class="rm" onclick="removeAttach(' + i + ')">&times;</button></div>';
  }).join('');
}
function removeAttach(i) { attachments.splice(i, 1); renderAttachPreview(); }

// ── EXPORT PDF ─────────────────────────────
async function exportChatPDF() {
  if (hist.length === 0) { alert('Tidak ada chat untuk diexport!'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFont('helvetica');
  doc.setFontSize(16);
  doc.text('Pev.ai - Riwayat Chat', 20, 20);
  doc.setFontSize(10); doc.setTextColor(120);
  doc.text(`Diekspor: ${new Date().toLocaleString('id')}`, 20, 28);
  doc.line(20, 32, 190, 32);
  let y = 42;
  for (const m of hist) {
    const role = m.role === 'user' ? 'Kamu' : 'Pev.ai';
    const content = typeof m.content === 'string' ? m.content : '[Pesan dengan lampiran]';
    doc.setFontSize(9); doc.setTextColor(m.role === 'user' ? 30 : 80);
    doc.setFont('helvetica','bold'); doc.text(role+':', 20, y); y += 6;
    doc.setFont('helvetica','normal'); doc.setTextColor(40);
    const lines = doc.splitTextToSize(content, 165);
    for (const line of lines) { if(y>280){doc.addPage();y=20;} doc.text(line,25,y); y+=5; }
    y += 6; if(y>280){doc.addPage();y=20;}
  }
  doc.save('pev-ai-chat.pdf');
}

// ── ANALYZER ───────────────────────────────
function od(e){e.preventDefault();document.getElementById('dz').classList.remove('drag');const f=e.dataTransfer.files[0];if(f){const r=new FileReader();r.onload=ev=>document.getElementById('azIn').value=ev.target.result;r.readAsText(f);}}
function of2(e){const f=e.target.files[0];if(f){const r=new FileReader();r.onload=ev=>document.getElementById('azIn').value=ev.target.result;r.readAsText(f);}}
async function da(mode){
  const txt=document.getElementById('azIn').value.trim();
  if(!txt){alert('Masukkan teks dulu!');return;}
  const o=document.getElementById('azOut');
  o.innerHTML='<div style="display:flex;gap:8px;align-items:center;color:var(--gray3)"><div class="spinner"></div> Menganalisis...</div>';
  try{o.textContent=await callAPI([{role:'user',content:`${mode} dari teks berikut:\n\n---\n${txt}\n---`}],'Kamu adalah analis teks profesional.');}
  catch(e){if(e.message!=='API Key belum diset')o.textContent='Error: '+e.message;}
}

// ── PROGRAMMER ─────────────────────────────
let pgHistory = []; // chat history khusus programmer

function pgAddMsg(role, text) {
  const msgs = document.getElementById('pgMsgs');
  // Hapus welcome screen
  const welcome = msgs.querySelector('.pg-welcome');
  if (welcome) welcome.remove();

  const d = document.createElement('div');
  d.className = 'pg-msg ' + role;

  let bubbleContent;
  if (role === 'ai') {
    bubbleContent = renderMarkdown(text);
  } else {
    bubbleContent = `<div class="msg-text">${escHtml(text).replace(/\n/g,'<br>')}</div>`;
  }

  const copyBar = role === 'ai' ? `
    <div class="pg-copy-bar">
      <button class="pg-copy-btn" onclick="pgCopyText(this)">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        Salin teks
      </button>
    </div>` : '';

  d.innerHTML = `<div class="pg-bubble">${bubbleContent}</div>${copyBar}`;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;

  // Update count
  const count = msgs.querySelectorAll('.pg-msg').length;
  const hc = document.getElementById('pgHistCount');
  if (hc) hc.textContent = count + ' pesan';
}

function pgAddTyping() {
  const msgs = document.getElementById('pgMsgs');
  const d = document.createElement('div');
  d.className = 'pg-msg ai'; d.id = 'pgTyping';
  d.innerHTML = `<div class="pg-bubble"><div class="tdots"><span></span><span></span><span></span></div></div>`;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

function pgCopyText(btn) {
  const bubble = btn.closest('.pg-msg').querySelector('.pg-bubble');
  const textEls = bubble.querySelectorAll('.msg-text');
  const text = Array.from(textEls).map(el => el.innerText).join('\n').trim()
    || bubble.innerText.trim();
  doClipboardCopy(btn, text, 'Salin teks');
}

function copyEditorCode() {
  const code = document.getElementById('ced').value;
  if (!code.trim()) return;
  navigator.clipboard.writeText(code).then(() => {
    const btn = event.target;
    const orig = btn.textContent;
    btn.textContent = '✓ Disalin';
    setTimeout(() => btn.textContent = orig, 1500);
  });
}

function pasteToEditor() {
  navigator.clipboard.readText().then(text => {
    document.getElementById('ced').value = text;
    updateEditorLang();
  }).catch(() => alert('Tidak bisa akses clipboard. Paste manual ya (Ctrl+V)'));
}

function updateEditorLang() {
  const lang = document.getElementById('lsel').value;
  const el = document.getElementById('pgEditorLang');
  if (el) el.textContent = lang.toLowerCase();
  const code = document.getElementById('ced').value;
  const li = document.getElementById('pgLineInfo');
  if (li) li.textContent = `${code.split('\n').length} baris · ${code.length} karakter`;
}

function pgClear() {
  document.getElementById('pgMsgs').innerHTML = `
    <div class="pg-welcome">
      <div style="font-size:28px;margin-bottom:8px">💻</div>
      <div style="font-size:13px;font-weight:600;margin-bottom:4px">AI Programmer</div>
      <div style="font-size:11px;color:var(--gray3);font-family:'DM Mono',monospace;line-height:1.7">Paste kode → pilih aksi<br>atau ketik deskripsi → Generate</div>
    </div>`;
  pgHistory = [];
  const hc = document.getElementById('pgHistCount');
  if (hc) hc.textContent = '';
}

const pgPrompts = {
  explain:  (lang, code) => `Jelaskan kode ${lang} berikut secara detail dan mudah dipahami:\n\`\`\`${lang.toLowerCase()}\n${code}\n\`\`\``,
  debug:    (lang, code) => `Cari semua bug, error, dan masalah keamanan dalam kode ${lang} ini. Jelaskan setiap masalah dan berikan solusinya:\n\`\`\`${lang.toLowerCase()}\n${code}\n\`\`\``,
  optimize: (lang, code) => `Optimalkan kode ${lang} ini untuk performa, readability, dan best practice. Berikan kode yang sudah dioptimalkan:\n\`\`\`${lang.toLowerCase()}\n${code}\n\`\`\``,
  convert:  (lang, code) => `Konversi kode ini ke ${lang} dengan tetap mempertahankan logika yang sama:\n\`\`\`\n${code}\n\`\`\``,
};

const pgSysPrompt = (lang) => `Kamu adalah senior ${lang} developer yang ahli dan berpengalaman. Berikan jawaban yang akurat, praktis, dan mudah dipahami. Gunakan format markdown untuk kode. Jawab dalam Bahasa Indonesia kecuali diminta bahasa lain.`;

async function pgAction(type) {
  const code = document.getElementById('ced').value.trim();
  const lang = document.getElementById('lsel').value;
  if (!code) { alert('Paste kode dulu ke editor kiri!'); return; }

  const prompt = pgPrompts[type](lang, code);
  pgAddMsg('user', { explain:'Jelaskan kode ini', debug:'Debug & cari bug', optimize:'Optimasi kode', convert:'Konversi ke '+lang }[type] || type);
  pgHistory.push({ role:'user', content: prompt });
  pgAddTyping();

  try {
    const result = await callAPI(pgHistory, pgSysPrompt(lang));
    document.getElementById('pgTyping')?.remove();
    pgAddMsg('ai', result);
    pgHistory.push({ role:'assistant', content: result });
  } catch(e) {
    document.getElementById('pgTyping')?.remove();
    if (e.message !== 'API Key belum diset') pgAddMsg('ai', 'Error: ' + e.message);
  }
}

async function pgGenerate() {
  const desc = document.getElementById('ced').value.trim();
  const lang = document.getElementById('lsel').value;
  if (!desc) { alert('Ketik deskripsi kode yang mau di-generate!'); return; }

  pgAddMsg('user', 'Generate kode: ' + desc.substring(0, 60) + (desc.length > 60 ? '...' : ''));
  const prompt = `Buat kode ${lang} untuk: ${desc}\n\nBerikan kode yang lengkap, bersih, dan ada komentar penjelasan. Langsung berikan kode tanpa basa-basi panjang.`;
  pgHistory.push({ role:'user', content: prompt });
  pgAddTyping();

  try {
    const result = await callAPI(pgHistory, pgSysPrompt(lang));
    document.getElementById('pgTyping')?.remove();
    pgAddMsg('ai', result);
    pgHistory.push({ role:'assistant', content: result });
    // Otomatis isi editor dengan kode yang di-generate
    const codeMatch = result.match(/```(?:\w+)?\n([\s\S]+?)```/);
    if (codeMatch) {
      document.getElementById('ced').value = codeMatch[1].trim();
      updateEditorLang();
    }
  } catch(e) {
    document.getElementById('pgTyping')?.remove();
    if (e.message !== 'API Key belum diset') pgAddMsg('ai', 'Error: ' + e.message);
  }
}

async function pgAsk() {
  const q = document.getElementById('ain').value.trim();
  const code = document.getElementById('ced').value;
  const lang = document.getElementById('lsel').value;
  if (!q) return;
  document.getElementById('ain').value = '';
  document.getElementById('ain').style.height = 'auto';

  // Sertakan kode dalam context kalau ada
  const fullQ = code.trim()
    ? `${q}\n\nKode ${lang} yang sedang dikerjakan:\n\`\`\`${lang.toLowerCase()}\n${code}\n\`\`\``
    : q;

  pgAddMsg('user', q);
  pgHistory.push({ role:'user', content: fullQ });
  pgAddTyping();

  try {
    const result = await callAPI(pgHistory, pgSysPrompt(lang));
    document.getElementById('pgTyping')?.remove();
    pgAddMsg('ai', result);
    pgHistory.push({ role:'assistant', content: result });
  } catch(e) {
    document.getElementById('pgTyping')?.remove();
    if (e.message !== 'API Key belum diset') pgAddMsg('ai', 'Error: ' + e.message);
  }
}

// ── IMAGE GEN ──────────────────────────────
function ss(btn){document.querySelectorAll('.chip-grid .chip').forEach(b=>b.classList.remove('on'));btn.classList.add('on');styleV=btn.textContent;}
function sr(r,btn){document.querySelectorAll('[id^="r"]').forEach(b=>b.classList.remove('on'));btn.classList.add('on');ratioV=r;}
async function gi(){
  const p=document.getElementById('ipr').value.trim();
  if(!p){alert('Masukkan deskripsi gambar!');return;}
  const gg=document.getElementById('gg'),ge=document.getElementById('ge');
  ge.style.display='none'; gg.style.display='grid';
  const rc=ratioV==='16:9'?'land':ratioV==='9:16'?'port':'';
  const card=document.createElement('div'); card.className=`img-card ${rc}`;
  card.innerHTML=`<div class="img-load"><div class="spinner"></div></div>`;
  gg.insertBefore(card,gg.firstChild);
  const [w,h]=ratioV==='1:1'?[1024,1024]:ratioV==='16:9'?[1280,720]:[720,1280];
  const ep=encodeURIComponent(`${p}, ${styleV} style, high quality, detailed`);
  const url=`https://image.pollinations.ai/prompt/${ep}?width=${w}&height=${h}&nologo=true&seed=${Date.now()}`;
  const img=new Image();
  img.onload=()=>{
    const short=p.length>38?p.slice(0,38)+'…':p;
    card.innerHTML=`<img src="${url}" alt="${p}" loading="lazy"><div class="img-card-bot"><span class="img-card-txt">${short}</span><button class="dl-btn" onclick="window.open('${url}','_blank')">↓</button></div>`;
  };
  img.onerror=()=>{card.innerHTML=`<div class="img-load" style="color:var(--gray3);font-size:11px;font-family:'DM Mono',monospace;min-height:80px">Gagal. Coba lagi.</div>`;};
  img.src=url;
}

// ── TRANSLATE ──────────────────────────────
function initLangDropdowns() {
  const from = document.getElementById('trFrom');
  const to = document.getElementById('trTo');
  if (!from || !to) return;
  from.innerHTML = ''; to.innerHTML = '';
  LANGS.forEach(l => {
    from.innerHTML += `<option value="${l}">${l}</option>`;
    to.innerHTML += `<option value="${l}">${l}</option>`;
  });
  from.value = 'Auto Detect';
  to.value = 'Indonesia';
}
async function doTranslate() {
  const txt = document.getElementById('trIn').value.trim();
  const toLang = document.getElementById('trTo').value;
  const fromLang = document.getElementById('trFrom').value;
  if (!txt) { alert('Masukkan teks dulu!'); return; }
  const o = document.getElementById('trOut');
  o.innerHTML = '<div style="display:flex;gap:8px;align-items:center;color:var(--gray3)"><div class="spinner"></div> Menerjemahkan...</div>';
  try {
    const result = await callAPI(
      [{role:'user', content:`Terjemahkan dari ${fromLang} ke ${toLang}. Balas HANYA dengan hasil terjemahan:\n\n${txt}`}],
      'Kamu adalah penerjemah profesional.'
    );
    o.textContent = result;
    document.getElementById('trCharCount').textContent = result.length + ' karakter';
  } catch(e) { if(e.message!=='API Key belum diset') o.textContent = 'Error: ' + e.message; }
}
function swapLangs() {
  const a = document.getElementById('trFrom'), b = document.getElementById('trTo');
  const tmp = a.value; a.value = b.value; b.value = tmp;
  const inTxt = document.getElementById('trIn').value;
  const outTxt = document.getElementById('trOut').textContent;
  if (outTxt && !outTxt.includes('muncul di sini')) {
    document.getElementById('trIn').value = outTxt;
    document.getElementById('trOut').textContent = inTxt;
  }
}
function copyTranslation() {
  const txt = document.getElementById('trOut').textContent;
  if (!txt || txt.includes('muncul di sini')) return;
  navigator.clipboard.writeText(txt).then(() => {
    const btn = document.getElementById('trCopyBtn');
    const orig = btn.textContent;
    btn.textContent = '✓ Disalin';
    setTimeout(() => btn.textContent = orig, 1500);
  });
}

// ── YOUTUBE ────────────────────────────────
function extractYouTubeId(url) {
  const rx = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ \s]{11})/;
  const m = url.match(rx);
  return m ? m[1] : null;
}
async function summarizeYouTube() {
  const url = document.getElementById('ytUrl').value.trim();
  if (!url) { alert('Masukkan link YouTube dulu!'); return; }
  const vid = extractYouTubeId(url);
  if (!vid) { alert('Link YouTube tidak valid!'); return; }
  const mode = document.getElementById('ytMode').value;
  const o = document.getElementById('ytOut');
  document.getElementById('ytThumb').innerHTML = `<img src="https://img.youtube.com/vi/${vid}/mqdefault.jpg" style="width:100%;border-radius:8px;margin-bottom:12px">`;
  o.innerHTML = '<div style="display:flex;gap:8px;align-items:center;color:var(--gray3)"><div class="spinner"></div> Menganalisis...</div>';
  const prompts = {
    summary: `Buat ringkasan lengkap dan informatif untuk video YouTube dengan URL: ${url}`,
    keypoints: `Buat poin-poin kunci dalam format bullet dari video YouTube: ${url}`,
    transcript: `Buat outline atau struktur konten dari video YouTube: ${url}`
  };
  try {
    const result = await callAPI(
      [{role:'user', content: prompts[mode] || prompts.summary}],
      'Kamu adalah asisten AI yang membantu menganalisis konten YouTube. Jawab dalam Bahasa Indonesia.'
    );
    o.textContent = result;
  } catch(e) { if(e.message!=='API Key belum diset') o.textContent = 'Error: ' + e.message; }
}

// Restore session after desktop mode switch
(function restoreSession() {
  const savedRole = sessionStorage.getItem('pev_role');
  const savedUser = sessionStorage.getItem('pev_user');
  if (savedRole && savedUser) {
    try {
      const user = JSON.parse(savedUser);
      enterApp(savedRole, user);
    } catch(e) {
      sessionStorage.removeItem('pev_role');
      sessionStorage.removeItem('pev_user');
    }
  }
})();
</script>
<!-- ATTACH BOTTOM SHEET -->
<div class="attach-sheet-overlay" id="attachSheet">
  <div class="attach-sheet-bg" onclick="closeAttachSheet()"></div>
  <div class="attach-sheet">
    <div class="attach-sheet-handle"></div>
    <div class="attach-sheet-title">TAMBAHKAN KE CHAT</div>
    <div class="attach-sheet-grid">
      <button class="attach-sheet-btn" onclick="closeAttachSheet();triggerCamera()">
        <div class="attach-sheet-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
        Kamera
      </button>
      <button class="attach-sheet-btn" onclick="closeAttachSheet();document.getElementById('imgUpload').click()">
        <div class="attach-sheet-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>
        Foto
      </button>
      <button class="attach-sheet-btn" onclick="closeAttachSheet();document.getElementById('fileUpload').click()">
        <div class="attach-sheet-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
        File
      </button>
    </div>
  </div>
</div>

</body>
</html>
