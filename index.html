<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>DigiMart ‚Äî Marketplace Digital</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Mulish:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- ‚ïê‚ïê‚ïê SUPABASE SDK ‚ïê‚ïê‚ïê -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Heroicons via inline SVG helpers -->
<script>
const SUPABASE_URL = 'https://telnfgpqyeruqiarbgue.supabase.co';
const SUPABASE_KEY = 'sb_publishable_i2NkK7O5bFT3QG2dd6griQ_9ac-9gd8';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ‚ïê‚ïê‚ïê PASSWORD HASHING (SHA-256) ‚ïê‚ïê‚ïê
async function hashPassword(password) {
  const msgBuffer = new TextEncoder().encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}
</script>
<style>
:root {
  --bg: #0a0a0f;
  --surface: #13131a;
  --surface2: #1c1c27;
  --border: #2a2a3a;
  --accent: #6c63ff;
  --accent2: #ff6584;
  --gold: #ffd700;
  --green: #00d4aa;
  --text: #f0f0ff;
  --muted: #7070a0;
  --radius: 14px;
  --font-head: 'Syne', 'Arial Black', 'Trebuchet MS', sans-serif;
  --font-body: 'Mulish', 'Segoe UI', Arial, sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
.page{display:none;min-height:100vh;animation:fadeIn 0.3s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px;}

/* ===== NAVBAR ===== */
.navbar{
  background:rgba(10,10,15,0.95);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;top:0;z-index:200;
}
.logo{font-family:var(--font-head);font-size:22px;font-weight:800;cursor:pointer;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav-right{display:flex;align-items:center;gap:10px;}
.nav-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);
  padding:7px 14px;border-radius:30px;font-size:13px;font-weight:600;cursor:pointer;
  font-family:var(--font-body);transition:all 0.2s;}
.nav-btn:hover{background:var(--accent);border-color:var(--accent);}
.nav-btn.primary{background:var(--accent);border-color:var(--accent);}
.nav-btn.primary:hover{background:#5a52ee;}
.nav-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;cursor:pointer;border:2px solid var(--border);}
.role-badge{padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:0.5px;}
.role-owner{background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;}
.role-coowner{background:linear-gradient(135deg,#c0c0c0,#808080);color:#000;}
.role-admin{background:linear-gradient(135deg,#6c63ff,#4a44cc);color:#fff;}
.role-preadmin{background:linear-gradient(135deg,#00d4aa,#009977);color:#000;}
.role-customer{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}

/* ===== HERO ===== */
.hero{
  background:linear-gradient(160deg,#0d0d1a 0%,#12102a 50%,#0a0f1a 100%);
  padding:50px 20px 40px;
  text-align:center;
  position:relative;
  overflow:hidden;
}
.hero::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 50% 0%,rgba(108,99,255,0.15) 0%,transparent 70%);
}
.hero-tag{display:inline-flex;align-items:center;gap:6px;
  background:rgba(108,99,255,0.15);border:1px solid rgba(108,99,255,0.3);
  color:var(--accent);padding:5px 14px;border-radius:20px;font-size:12px;font-weight:600;margin-bottom:16px;}
.hero h1{
  font-family:var(--font-head);
  font-size:22px;
  font-weight:800;
  margin-bottom:10px;
  line-height:1.4;
  color:#ffffff;
  position:relative;
  z-index:1;
  letter-spacing:-0.3px;
}
.hero h1 .h1-white{ color:#ffffff; }
.hero h1 .h1-purple{ color:var(--accent); }
.hero p{font-size:14px;color:var(--muted);max-width:320px;margin:0 auto 24px;}
.hero-stats{display:flex;justify-content:center;gap:24px;}
.hero-stat{text-align:center;}
.hero-stat .num{font-family:var(--font-head);font-size:20px;font-weight:800;color:var(--accent);}
.hero-stat .lbl{font-size:11px;color:var(--muted);}

/* ===== SEARCH ===== */
.search-wrap{padding:16px 20px;background:var(--surface);border-bottom:1px solid var(--border);}
.search-box{display:flex;gap:10px;align-items:center;
  background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:10px 16px;}
.search-box input{flex:1;background:none;border:none;color:var(--text);font-size:14px;font-family:var(--font-body);outline:none;}
.search-box input::placeholder{color:var(--muted);}

/* ===== CATEGORIES ===== */
.cats{padding:14px 16px;display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;}
.cats::-webkit-scrollbar{display:none;}
.cat-btn{padding:7px 16px;border-radius:20px;font-size:12px;font-weight:600;
  background:var(--surface2);border:1px solid var(--border);color:var(--muted);cursor:pointer;
  white-space:nowrap;transition:all 0.2s;font-family:var(--font-body);}
.cat-btn.active,.cat-btn:hover{background:var(--accent);border-color:var(--accent);color:#fff;}

/* ===== PRODUK GRID ===== */
.section{padding:16px;}
.section-title{font-family:var(--font-head);font-size:16px;font-weight:700;margin-bottom:14px;
  display:flex;justify-content:space-between;align-items:center;}
.produk-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.produk-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;
  cursor:pointer;
  transition:all 0.2s;
}
.produk-card:hover{border-color:var(--accent);transform:translateY(-2px);}
.produk-card:active{transform:scale(0.97);}
.produk-img{
  background:linear-gradient(135deg,var(--surface2),var(--bg));
  height:110px;display:flex;align-items:center;justify-content:center;font-size:44px;
  position:relative;border-bottom:1px solid var(--border);
}
.produk-cat-badge{position:absolute;top:8px;left:8px;
  background:rgba(108,99,255,0.8);color:#fff;font-size:10px;font-weight:600;
  padding:2px 8px;border-radius:10px;}
.produk-body{padding:10px;}
.produk-nama{font-weight:700;font-size:13px;margin-bottom:4px;line-height:1.3;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.produk-seller{font-size:11px;color:var(--muted);margin-bottom:6px;
  display:flex;align-items:center;gap:4px;}
.produk-rating{display:flex;align-items:center;gap:3px;font-size:11px;margin-bottom:6px;}
.produk-rating .star{color:var(--gold);}
.produk-harga{font-family:var(--font-head);font-size:13px;font-weight:700;color:var(--accent);line-height:1.4;word-break:break-word;}
.produk-meta{display:flex;justify-content:space-between;align-items:flex-end;margin-top:4px;gap:4px;}
.produk-terjual{font-size:10px;color:var(--muted);}

/* ===== DETAIL PRODUK ===== */
.detail-header{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 16px;
  display:flex;align-items:center;gap:12px;}
.back-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);
  width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:16px;flex-shrink:0;}
.detail-img{background:linear-gradient(135deg,var(--surface),var(--surface2));
  height:220px;display:flex;align-items:center;justify-content:center;font-size:80px;
  border-bottom:1px solid var(--border);}
.detail-info{padding:16px;}
.detail-nama{font-family:var(--font-head);font-size:20px;font-weight:700;margin-bottom:6px;line-height:1.3;word-break:break-word;}
.detail-harga{font-family:var(--font-head);font-size:22px;font-weight:800;color:var(--accent);margin-bottom:12px;word-break:break-word;line-height:1.4;}
.detail-stats{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
.detail-stat{text-align:center;background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;padding:8px 14px;flex:1;min-width:70px;}
.detail-stat .ds-val{font-weight:700;font-size:14px;color:var(--text);}
.detail-stat .ds-lbl{font-size:10px;color:var(--muted);margin-top:2px;}

/* ===== TABS ===== */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:16px;overflow-x:auto;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{padding:11px 16px;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer;
  white-space:nowrap;border-bottom:2px solid transparent;transition:all 0.2s;font-family:var(--font-body);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab-content{display:none;padding:0 16px 16px;}
.tab-content.active{display:block;}

/* ===== SELLER CARD ===== */
.seller-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:14px;}
.seller-top{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.seller-avatar{width:48px;height:48px;border-radius:12px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;flex-shrink:0;}
.seller-name{font-weight:700;font-size:15px;margin-bottom:3px;}
.seller-online{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px;}
.online-dot{width:6px;height:6px;border-radius:50%;background:#00d4aa;}
.seller-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.seller-stat{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 10px;}
.seller-stat .sv{font-weight:700;font-size:14px;}
.seller-stat .sl{font-size:10px;color:var(--muted);margin-top:1px;}

/* ===== RATING ===== */
.rating-summary{display:flex;align-items:center;gap:16px;margin-bottom:16px;
  background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;}
.rating-big{text-align:center;}
.rating-big .num{font-family:var(--font-head);font-size:40px;font-weight:800;color:var(--gold);}
.rating-big .stars{font-size:16px;margin-bottom:2px;}
.rating-big .cnt{font-size:11px;color:var(--muted);}
.rating-bars{flex:1;}
.rating-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
.rating-bar-row span{font-size:11px;color:var(--muted);width:8px;}
.rating-bar-bg{flex:1;background:var(--border);border-radius:4px;height:6px;}
.rating-bar-fill{height:6px;border-radius:4px;background:var(--gold);}
.review-item{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;}
.review-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;}
.review-user{font-weight:600;font-size:13px;}
.review-date{font-size:11px;color:var(--muted);}
.review-stars{font-size:12px;margin-bottom:4px;}
.review-text{font-size:13px;color:rgba(240,240,255,0.8);line-height:1.5;}

/* ===== BUY BTN ===== */
.buy-bar{position:sticky;bottom:0;background:rgba(10,10,15,0.97);
  backdrop-filter:blur(20px);border-top:1px solid var(--border);
  padding:16px 16px calc(16px + env(safe-area-inset-bottom));display:flex;gap:10px;margin-top:auto;}
.btn-buy{flex:1;background:linear-gradient(135deg,var(--accent),#5a52ee);
  color:#fff;border:none;padding:16px;border-radius:14px;
  font-size:15px;font-weight:700;cursor:pointer;font-family:var(--font-body);}
.btn-buy:hover{opacity:0.9;}
.btn-chat{background:var(--surface2);border:1px solid var(--border);color:var(--text);
  padding:16px 18px;border-radius:14px;cursor:pointer;font-size:20px;}

/* ===== AUTH ===== */
.auth-page{min-height:100vh;background:var(--bg);
  display:flex;align-items:center;justify-content:center;padding:20px;}
.auth-box{background:var(--surface);border:1px solid var(--border);
  border-radius:20px;padding:32px 24px;width:100%;max-width:380px;}
.auth-logo{text-align:center;margin-bottom:24px;}
.auth-logo .logo{font-size:28px;}
.auth-logo h2{font-family:var(--font-head);font-size:20px;margin:8px 0 4px;}
.auth-logo p{font-size:13px;color:var(--muted);}
.form-group{margin-bottom:14px;}
.form-label{font-size:12px;font-weight:600;color:var(--muted);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;}
.form-input{width:100%;padding:11px 14px;background:var(--surface2);
  border:1px solid var(--border);border-radius:10px;color:var(--text);
  font-size:14px;font-family:var(--font-body);transition:border 0.2s;outline:none;}
.form-input:focus{border-color:var(--accent);}
.form-input::placeholder{color:var(--muted);}
.btn-full{width:100%;padding:13px;border-radius:10px;font-size:14px;font-weight:700;
  cursor:pointer;font-family:var(--font-body);border:none;transition:all 0.2s;}
.btn-accent{background:linear-gradient(135deg,var(--accent),#5a52ee);color:#fff;}
.btn-accent:hover{opacity:0.9;}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text);margin-top:8px;}
.btn-outline:hover{border-color:var(--accent);color:var(--accent);}
.auth-switch{text-align:center;margin-top:16px;font-size:13px;color:var(--muted);}
.auth-switch span{color:var(--accent);cursor:pointer;font-weight:600;}
.alert{padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:14px;}
.alert-err{background:rgba(255,101,132,0.15);border:1px solid rgba(255,101,132,0.3);color:var(--accent2);}
.alert-ok{background:rgba(0,212,170,0.15);border:1px solid rgba(0,212,170,0.3);color:var(--green);}

/* ===== DASHBOARD ===== */
.dash-header{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 20px;}
.dash-header h1{font-family:var(--font-head);font-size:20px;font-weight:700;}
.dash-header p{font-size:13px;color:var(--muted);margin-top:2px;}
.dash-tabs{display:flex;gap:6px;padding:14px 16px;overflow-x:auto;scrollbar-width:none;}
.dash-tabs::-webkit-scrollbar{display:none;}
.dash-tab{padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;
  background:var(--surface2);border:1px solid var(--border);color:var(--muted);
  cursor:pointer;white-space:nowrap;transition:all 0.2s;font-family:var(--font-body);}
.dash-tab.active{background:var(--accent);border-color:var(--accent);color:#fff;}
.dash-section{display:none;padding:0 16px 30px;}
.dash-section.active{display:block;}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.stat-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;}
.stat-card.accent{background:linear-gradient(135deg,rgba(108,99,255,0.2),rgba(108,99,255,0.05));border-color:rgba(108,99,255,0.3);}
.stat-card .slbl{font-size:11px;color:var(--muted);margin-bottom:4px;}
.stat-card .sval{font-family:var(--font-head);font-size:22px;font-weight:700;}
.stat-card.accent .sval{color:var(--accent);}
.card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:12px;}
.card h3{font-size:13px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;}
.list-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.list-item:last-child{border-bottom:none;}
.list-icon{width:38px;height:38px;border-radius:10px;background:var(--surface);
  display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.list-info{flex:1;}
.list-title{font-weight:600;font-size:13px;}
.list-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.list-right{text-align:right;}
.list-val{font-weight:700;font-size:13px;color:var(--accent);}
.list-badge{font-size:10px;padding:2px 8px;border-radius:10px;display:inline-block;margin-top:2px;}
.badge-pending{background:rgba(255,200,0,0.15);color:#ffc800;border:1px solid rgba(255,200,0,0.3);}
.badge-approved{background:rgba(0,212,170,0.15);color:var(--green);border:1px solid rgba(0,212,170,0.3);}
.badge-rejected{background:rgba(255,101,132,0.15);color:var(--accent2);border:1px solid rgba(255,101,132,0.3);}
.badge-active{background:rgba(108,99,255,0.15);color:var(--accent);border:1px solid rgba(108,99,255,0.3);}

/* ===== FORM PRODUK ===== */
.form-select{width:100%;padding:11px 14px;background:var(--surface2);
  border:1px solid var(--border);border-radius:10px;color:var(--text);
  font-size:14px;font-family:var(--font-body);outline:none;}
.form-select:focus{border-color:var(--accent);}
.form-textarea{height:80px;resize:none;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

/* ===== USER MANAGEMENT ===== */
.user-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.user-item:last-child{border-bottom:none;}
.user-av{width:38px;height:38px;border-radius:10px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;flex-shrink:0;}
.user-info{flex:1;}
.user-name{font-weight:600;font-size:13px;}
.user-role{font-size:11px;color:var(--muted);margin-top:2px;}
.action-btns{display:flex;gap:6px;}
.action-btn{padding:5px 10px;border-radius:8px;font-size:11px;font-weight:600;
  cursor:pointer;border:none;font-family:var(--font-body);transition:all 0.2s;}
.btn-approve{background:rgba(0,212,170,0.15);color:var(--green);border:1px solid rgba(0,212,170,0.3);}
.btn-reject{background:rgba(255,101,132,0.15);color:var(--accent2);border:1px solid rgba(255,101,132,0.3);}
.btn-promote{background:rgba(108,99,255,0.15);color:var(--accent);border:1px solid rgba(108,99,255,0.3);}
.btn-demote{background:rgba(255,200,0,0.15);color:#ffc800;border:1px solid rgba(255,200,0,0.3);}
.btn-delete{background:rgba(255,101,132,0.15);color:var(--accent2);border:1px solid rgba(255,101,132,0.3);}

/* ===== TOAST ===== */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);padding:12px 24px;border-radius:30px;
  font-size:13px;font-weight:600;z-index:9999;
  transition:transform 0.3s;white-space:nowrap;
  box-shadow:0 8px 32px rgba(0,0,0,0.4);}
.toast.show{transform:translateX(-50%) translateY(0);}

/* ===== MODAL ===== */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);
  z-index:500;align-items:flex-end;justify-content:center;}
.modal-overlay.active{display:flex;animation:fadeIn 0.2s ease;}
.modal{background:var(--surface);border:1px solid var(--border);
  border-radius:20px 20px 0 0;padding:24px 20px;width:100%;max-width:500px;
  max-height:80vh;overflow-y:auto;}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px;}
.modal h3{font-family:var(--font-head);font-size:18px;font-weight:700;margin-bottom:16px;}

/* ===== EMPTY STATE ===== */
.empty{text-align:center;padding:50px 20px;}
.empty .eicon{font-size:50px;margin-bottom:12px;opacity:0.5;}
.empty p{color:var(--muted);font-size:14px;}


/* ===== SIDEBAR DRAWER ===== */
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:300;display:none;backdrop-filter:blur(4px);}
.drawer-overlay.active{display:block;animation:fadeIn 0.2s ease;}
.drawer{position:fixed;top:0;left:-320px;width:300px;height:100vh;background:var(--surface);
  border-right:1px solid var(--border);z-index:400;transition:left 0.3s ease;overflow-y:auto;
  display:flex;flex-direction:column;}
.drawer.open{left:0;}
.drawer-header{padding:24px 20px 16px;border-bottom:1px solid var(--border);}
.drawer-logo{font-family:var(--font-head);font-size:20px;font-weight:800;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px;}
.drawer-user{display:flex;align-items:center;gap:12px;}
.drawer-avatar{width:46px;height:46px;border-radius:12px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.drawer-username{font-weight:700;font-size:15px;}
.drawer-title-badge{font-size:11px;padding:2px 8px;border-radius:10px;
  background:linear-gradient(135deg,var(--gold),#ff8c00);color:#000;font-weight:700;
  display:inline-block;margin-top:3px;}
.drawer-section{padding:12px 16px;}
.drawer-section-title{font-size:10px;font-weight:700;color:var(--muted);
  text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.drawer-item{display:flex;align-items:center;gap:12px;padding:11px 12px;
  border-radius:10px;cursor:pointer;transition:all 0.2s;margin-bottom:2px;}
.drawer-item:hover,.drawer-item:active{background:var(--surface2);}
.drawer-item .di-icon{font-size:18px;width:24px;text-align:center;display:flex;align-items:center;justify-content:center;}
.drawer-item .di-icon svg{width:20px;height:20px;stroke:var(--muted);}
.drawer-item:hover .di-icon svg{stroke:var(--accent);}
.drawer-item .di-label{font-size:14px;font-weight:500;}
.drawer-item .di-badge{margin-left:auto;background:var(--accent2);color:#fff;
  padding:2px 7px;border-radius:10px;font-size:10px;font-weight:700;}
.drawer-divider{height:1px;background:var(--border);margin:4px 16px;}
.hamburger{background:none;border:none;color:var(--text);font-size:22px;cursor:pointer;
  padding:4px 6px;display:flex;align-items:center;justify-content:center;}

/* ===== STATS CHART ===== */
.chart-wrap{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px;}
.chart-title{font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:14px;}
.bar-chart{display:flex;align-items:flex-end;gap:8px;height:120px;}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;}
.bar-fill{width:100%;border-radius:6px 6px 0 0;min-height:4px;transition:height 0.5s ease;}
.bar-label{font-size:9px;color:var(--muted);text-align:center;line-height:1.2;}
.bar-val{font-size:10px;font-weight:700;color:var(--text);}
.donut-wrap{display:flex;align-items:center;gap:16px;}
.donut-legend{flex:1;}
.donut-legend-item{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.donut-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.donut-lbl{font-size:12px;color:var(--muted);}
.donut-val{font-size:12px;font-weight:700;margin-left:auto;}

/* ===== GIFT TITLE ===== */
.title-presets{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
.title-preset{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;
  border:1px solid var(--border);background:var(--surface2);color:var(--text);transition:all 0.2s;}
.title-preset:hover{border-color:var(--gold);color:var(--gold);}
.title-preset.selected{background:linear-gradient(135deg,var(--gold),#ff8c00);color:#000;border-color:transparent;}

/* ===== STARS INPUT ===== */
.stars-input{display:flex;gap:6px;font-size:28px;cursor:pointer;margin:8px 0;}
.stars-input span{opacity:0.3;transition:opacity 0.1s;}
.stars-input span.active{opacity:1;}


/* ===== BOTTOM NAV ===== */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:300;
  background:rgba(13,13,26,0.98);border-top:1px solid var(--border);
  border-radius:20px 20px 0 0;
  backdrop-filter:blur(20px);
  display:flex;align-items:center;justify-content:space-around;
  padding:12px 0 calc(14px + env(safe-area-inset-bottom));
  box-shadow:0 -4px 24px rgba(0,0,0,0.4);}
.bn-item{display:flex;flex-direction:column;align-items:center;gap:4px;
  cursor:pointer;padding:4px 20px;border-radius:12px;transition:all 0.2s;flex:1;}
.bn-item:active{background:var(--surface2);}
.bn-icon{font-size:22px;position:relative;display:flex;align-items:center;justify-content:center;}
.bn-icon svg{width:24px;height:24px;stroke:var(--muted);transition:stroke 0.2s;}
.bn-item.active .bn-icon svg{stroke:var(--accent);}
.bn-label{font-size:10px;font-weight:600;color:var(--muted);}
.bn-item.active .bn-label{color:var(--accent);}
.bn-badge{position:absolute;top:-4px;right:-6px;width:8px;height:8px;
  background:var(--accent2);border-radius:50%;border:2px solid var(--bg);display:none;}
.page-pad{padding-bottom:80px;}

/* ===== CHAT ===== */
.chat-list-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);cursor:pointer;}
.chat-list-item:hover{opacity:0.8;}
.chat-av{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;position:relative;}
.chat-unread-dot{position:absolute;top:-3px;right:-3px;width:10px;height:10px;border-radius:50%;background:var(--accent2);border:2px solid var(--surface);}
.chat-list-info{flex:1;min-width:0;}
.chat-list-name{font-weight:700;font-size:14px;margin-bottom:2px;}
.chat-list-preview{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.chat-list-time{font-size:11px;color:var(--muted);flex-shrink:0;}

/* Chat Room */
.chat-room-header{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 16px;
  display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:10;}
.chat-room-body{padding:16px;display:flex;flex-direction:column;gap:10px;min-height:calc(100vh - 220px);padding-bottom:80px;}
.chat-bubble{max-width:80%;padding:10px 14px;border-radius:16px;font-size:13px;line-height:1.5;position:relative;}
.chat-bubble.sent{background:linear-gradient(135deg,var(--accent),#5a52ee);color:#fff;align-self:flex-end;border-bottom-right-radius:4px;}
.chat-bubble.recv{background:var(--surface2);border:1px solid var(--border);color:var(--text);align-self:flex-start;border-bottom-left-radius:4px;}
.chat-bubble .cb-time{font-size:10px;opacity:0.7;margin-top:4px;text-align:right;}
.chat-bubble.recv .cb-time{text-align:left;}
.chat-input-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,15,0.97);
  border-top:1px solid var(--border);padding:12px 16px 20px;display:flex;gap:10px;
  backdrop-filter:blur(20px);z-index:500;}
.chat-input-bar input{flex:1;background:var(--surface2);border:1px solid var(--border);
  color:var(--text);padding:10px 14px;border-radius:20px;font-family:var(--font-body);font-size:14px;outline:none;}
.chat-input-bar input::placeholder{color:var(--muted);}
.chat-send-btn{width:42px;height:42px;border-radius:50%;background:var(--accent);border:none;
  color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.chat-product-ref{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;
  display:flex;align-items:center;gap:10px;margin-bottom:12px;cursor:pointer;}
.chat-date-divider{text-align:center;font-size:11px;color:var(--muted);margin:8px 0;
  display:flex;align-items:center;gap:10px;}
.chat-date-divider::before,.chat-date-divider::after{content:'';flex:1;height:1px;background:var(--border);}


/* ===== ORDER STATUS ===== */
.order-tabs{display:flex;overflow-x:auto;scrollbar-width:none;gap:0;border-bottom:1px solid var(--border);margin-bottom:14px;}
.order-tabs::-webkit-scrollbar{display:none;}
.order-tab{padding:10px 14px;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;
  white-space:nowrap;border-bottom:2px solid transparent;transition:all 0.2s;flex-shrink:0;}
.order-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.order-status-badge{padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;}
.status-menunggu-bayar{background:rgba(255,200,0,0.15);color:#ffc800;border:1px solid rgba(255,200,0,0.3);}
.status-menunggu-kirim{background:rgba(108,99,255,0.15);color:var(--accent);border:1px solid rgba(108,99,255,0.3);}
.status-dikirim{background:rgba(0,212,170,0.15);color:var(--green);border:1px solid rgba(0,212,170,0.3);}
.status-selesai{background:rgba(0,212,170,0.1);color:var(--green);border:1px solid rgba(0,212,170,0.2);}
.status-dibatalkan{background:rgba(255,101,132,0.15);color:var(--accent2);border:1px solid rgba(255,101,132,0.3);}

/* ===== CHECKOUT ===== */
.checkout-step{display:none;}
.checkout-step.active{display:block;}
.step-indicator{display:flex;align-items:center;justify-content:center;gap:0;margin-bottom:24px;}
.step-dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;border:2px solid var(--border);background:var(--surface2);color:var(--muted);flex-shrink:0;}
.step-dot.done{background:var(--accent);border-color:var(--accent);color:#fff;}
.step-dot.active{background:transparent;border-color:var(--accent);color:var(--accent);}
.step-line{flex:1;height:2px;background:var(--border);max-width:50px;}
.step-line.done{background:var(--accent);}
.payment-method{background:var(--surface2);border:2px solid var(--border);border-radius:12px;padding:14px;
  cursor:pointer;transition:all 0.2s;margin-bottom:10px;display:flex;align-items:center;gap:12px;}
.payment-method.selected{border-color:var(--accent);background:rgba(108,99,255,0.1);}
.payment-method:hover{border-color:var(--accent);}
.pm-icon{font-size:28px;flex-shrink:0;}
.pm-info{flex:1;}
.pm-name{font-weight:700;font-size:14px;}
.pm-desc{font-size:12px;color:var(--muted);}
.pm-check{width:20px;height:20px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;
  display:flex;align-items:center;justify-content:center;}
.payment-method.selected .pm-check{background:var(--accent);border-color:var(--accent);}
.order-success-wrap{text-align:center;padding:30px 0;}
.order-success-icon{font-size:70px;margin-bottom:16px;animation:successPop 0.5s ease;}
@keyframes successPop{0%{transform:scale(0)}70%{transform:scale(1.2)}100%{transform:scale(1)}}
.order-code{background:var(--surface2);border:1px dashed var(--accent);border-radius:12px;
  padding:16px;margin:16px 0;font-family:var(--font-head);font-size:22px;font-weight:800;
  color:var(--accent);letter-spacing:2px;}
.invoice-row{display:flex;justify-content:space-between;font-size:13px;padding:6px 0;border-bottom:1px solid var(--border);}
.invoice-row:last-child{border-bottom:none;}
.invoice-row.total{font-weight:700;font-size:15px;color:var(--text);}
</style>
</head>
<body>

<!-- ===== PAGE: BERANDA ===== -->
<div class="page active" id="page-home">
  <nav class="navbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <button class="hamburger" onclick="openDrawer()">‚ò∞</button>
      <div class="logo" onclick="showPage('page-home')">DigiMart</div>
    </div>
    <div class="nav-right" id="nav-right">
      <button class="nav-btn" onclick="showPage('page-login')">Masuk</button>
      <button class="nav-btn primary" onclick="showPage('page-register')">Daftar</button>
    </div>
  </nav>
  <div class="hero">
    <div class="hero-tag">‚ö° Marketplace Digital #1</div>
    <h1>
      <span class="h1-white">Jual &amp; Beli Produk Digital </span><span class="h1-purple">dengan Aman</span>
    </h1>
    <p>Game, voucher, jasa desain, dan masih banyak lagi</p>
    <div class="hero-stats">
      <div class="hero-stat"><div class="num" id="stat-produk">0</div><div class="lbl">Produk</div></div>
      <div class="hero-stat"><div class="num" id="stat-seller">0</div><div class="lbl">Seller</div></div>
      <div class="hero-stat"><div class="num" id="stat-transaksi">0</div><div class="lbl">Transaksi</div></div>
    </div>
  </div>
  <div class="search-wrap">
    <div class="search-box">
      <span style="color:var(--muted);">üîç</span>
      <input type="text" id="search-input" placeholder="Cari produk..." oninput="renderProdukGrid()">
    </div>
  </div>
  <div class="cats" id="cats">
    <button class="cat-btn active" onclick="filterKategori('semua',this)">Semua</button>
    <button class="cat-btn" onclick="filterKategori('game',this)">üéÆ Game</button>
    <button class="cat-btn" onclick="filterKategori('voucher',this)">üé´ Voucher</button>
    <button class="cat-btn" onclick="filterKategori('jasa',this)">üõ†Ô∏è Jasa</button>

  </div>
  <div class="section page-pad">
    <div class="section-title">
      <span>Produk Terbaru</span>
      <span style="font-size:12px;color:var(--muted);" id="produk-count"></span>
    </div>
    <div class="produk-grid" id="produk-grid"></div>
    <div class="empty" id="produk-empty" style="display:none;">
      <div class="eicon">üîç</div>
      <p>Produk tidak ditemukan</p>
    </div>
  </div>
</div>

<!-- ===== PAGE: DETAIL PRODUK ===== -->
<div class="page" id="page-detail">
  <div class="detail-header">
    <div class="back-btn" onclick="showPage('page-home')">‚Üê</div>
    <div style="font-weight:600;font-size:14px;" id="detail-breadcrumb">Detail Produk</div>
  </div>
  <div class="detail-img" id="detail-img">üéÆ</div>
  <div class="detail-info">
    <div id="detail-cat-badge" class="produk-cat-badge" style="display:inline-block;margin-bottom:8px;"></div>
    <div class="detail-nama" id="detail-nama"></div>
    <div class="detail-harga" id="detail-harga"></div>
    <div class="detail-stats">
      <div class="detail-stat"><div class="ds-val" id="ds-rating">-</div><div class="ds-lbl">‚≠ê Rating</div></div>
      <div class="detail-stat"><div class="ds-val" id="ds-terjual">0</div><div class="ds-lbl">Terjual</div></div>
      <div class="detail-stat"><div class="ds-val" id="ds-stok">0</div><div class="ds-lbl">Stok</div></div>
    </div>
  </div>
  <div style="padding:0 16px;">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('info-penjual',this)">Info Penjual</div>
      <div class="tab" onclick="switchTab('deskripsi',this)">Deskripsi</div>
      <div class="tab" onclick="switchTab('panduan',this)">Panduan</div>
      <div class="tab" onclick="switchTab('ulasan',this)">Ulasan</div>
    </div>
    <div class="tab-content active" id="tab-info-penjual"></div>
    <div class="tab-content" id="tab-deskripsi"></div>
    <div class="tab-content" id="tab-panduan"></div>
    <div class="tab-content" id="tab-ulasan"></div>
  </div>
  <div style="height:20px;"></div>
</div>

<!-- ===== PAGE: LOGIN ===== -->
<div class="page" id="page-login">
  <div class="auth-page">
    <div class="auth-box">
      <div class="auth-logo">
        <div class="logo">DigiMart</div>
        <h2>Selamat Datang</h2>
        <p>Masuk ke akun kamu</p>
      </div>
      <div class="alert alert-err" id="login-err" style="display:none;"></div>
      <div class="form-group">
        <label class="form-label">Username</label>
        <input class="form-input" id="l-user" type="text" placeholder="username kamu">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" id="l-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn-full btn-accent" onclick="doLogin()">Masuk ‚Üí</button>
      <button class="btn-full btn-outline" onclick="showPage('page-home')">Kembali</button>
      <div class="auth-switch">Belum punya akun? <span onclick="showPage('page-register')">Daftar sekarang</span></div>
    </div>
  </div>
</div>

<!-- ===== PAGE: REGISTER ===== -->
<div class="page" id="page-register">
  <div class="auth-page">
    <div class="auth-box">
      <div class="auth-logo">
        <div class="logo">DigiMart</div>
        <h2>Buat Akun</h2>
        <p>Daftar sebagai seller atau buyer</p>
      </div>
      <div class="alert alert-err" id="reg-err" style="display:none;"></div>
      <div class="form-group">
        <label class="form-label">Username</label>
        <input class="form-input" id="r-user" type="text" placeholder="min. 4 karakter">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="r-email" type="email" placeholder="email@kamu.com">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" id="r-pass" type="password" placeholder="min. 6 karakter">
      </div>
      <div class="form-group">
        <label class="form-label">Daftar sebagai</label>
        <select class="form-select" id="r-tipe">
          <option value="customer">üë§ Customer (Pembeli)</option>
          <option value="preadmin">üî∞ Seller (butuh approval)</option>
        </select>
      </div>
      <button class="btn-full btn-accent" onclick="doRegister()">Daftar ‚Üí</button>
      <button class="btn-full btn-outline" onclick="showPage('page-login')">Sudah punya akun?</button>
    </div>
  </div>
</div>

<!-- ===== PAGE: CHAT LIST ===== -->
<div class="page" id="page-chat">
  <nav class="navbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="back-btn" onclick="showPage('page-home')">‚Üê</div>
      <div style="font-family:var(--font-head);font-weight:700;font-size:16px;">üí¨ Pesan</div>
    </div>
    <div style="font-size:12px;color:var(--muted);" id="chat-list-count"></div>
  </nav>
  <div style="padding:16px;" id="chat-list-content">
    <div class="empty"><div class="eicon">üí¨</div><p>Belum ada percakapan</p></div>
  </div>
</div>

<!-- ===== PAGE: CHAT ROOM ===== -->
<div class="page" id="page-chatroom">
  <div class="chat-room-header">
    <div class="back-btn" onclick="showPage('page-chat');renderChatList()">‚Üê</div>
    <div class="chat-av" id="chatroom-av">üë§</div>
    <div style="flex:1;">
      <div style="font-weight:700;font-size:14px;" id="chatroom-name">Seller</div>
      <div style="font-size:11px;color:var(--green);">‚óè Online</div>
    </div>
    <div id="chatroom-product-badge" style="font-size:12px;color:var(--muted);"></div>
  </div>
  <div class="chat-room-body" id="chat-messages"></div>
  <div class="chat-input-bar">
    <input type="text" id="chat-msg-input" placeholder="Ketik pesan..." onkeydown="if(event.key==='Enter')sendChatMsg()">
    <button class="chat-send-btn" onclick="sendChatMsg()">‚û§</button>
  </div>
</div>

<!-- ===== PAGE: CHECKOUT ===== -->
<div class="page" id="page-checkout">
  <nav class="navbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="back-btn" onclick="showPage('page-detail')">‚Üê</div>
      <div style="font-family:var(--font-head);font-weight:700;font-size:16px;">üõí Checkout</div>
    </div>
  </nav>
  <div style="padding:20px 16px 100px;">
    <div class="step-indicator">
      <div class="step-dot active" id="step-dot-1">1</div>
      <div class="step-line" id="step-line-1"></div>
      <div class="step-dot" id="step-dot-2">2</div>
      <div class="step-line" id="step-line-2"></div>
      <div class="step-dot" id="step-dot-3">3</div>
    </div>
    <div class="checkout-step active" id="checkout-step-1">
      <div style="font-family:var(--font-head);font-size:18px;font-weight:700;margin-bottom:16px;">üì¶ Ringkasan Pesanan</div>
      <div id="checkout-summary"></div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:13px;font-weight:600;">Jumlah Pembelian</span>
          <div style="display:flex;align-items:center;gap:14px;">
            <button onclick="checkoutChangeQty(-1)" style="width:32px;height:32px;border-radius:50%;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:18px;cursor:pointer;">‚àí</button>
            <span id="co-qty" style="font-family:var(--font-head);font-size:18px;font-weight:700;min-width:24px;text-align:center;">1</span>
            <button onclick="checkoutChangeQty(1)" style="width:32px;height:32px;border-radius:50%;background:var(--accent);border:none;color:#fff;font-size:18px;cursor:pointer;">+</button>
          </div>
        </div>
      </div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:20px;" id="checkout-invoice"></div>
      <button class="btn-full btn-accent" style="margin-top:0;" onclick="goCheckoutStep(2)">Lanjut ke Pembayaran ‚Üí</button>
    </div>
    <div class="checkout-step" id="checkout-step-2">
      <div style="font-family:var(--font-head);font-size:18px;font-weight:700;margin-bottom:16px;">üí≥ Pilih Metode Bayar</div>
      <div class="payment-method selected" id="pm-transfer" onclick="selectPayment('transfer')">
        <div class="pm-icon">üè¶</div>
        <div class="pm-info"><div class="pm-name">Transfer Bank</div><div class="pm-desc">BCA ¬∑ BNI ¬∑ Mandiri ¬∑ BRI</div></div>
        <div class="pm-check">‚úì</div>
      </div>
      <div class="payment-method" id="pm-qris" onclick="selectPayment('qris')">
        <div class="pm-icon">üì±</div>
        <div class="pm-info"><div class="pm-name">QRIS</div><div class="pm-desc">GoPay ¬∑ OVO ¬∑ Dana ¬∑ ShopeePay</div></div>
        <div class="pm-check"></div>
      </div>
      <div class="payment-method" id="pm-voucher" onclick="selectPayment('voucher')">
        <div class="pm-icon">üíµ</div>
        <div class="pm-info"><div class="pm-name">Bayar via Voucher</div><div class="pm-desc">Masukkan kode voucher DigiMart</div></div>
        <div class="pm-check"></div>
      </div>
      <div id="payment-detail-wrap" style="margin-top:16px;"></div>
      <div style="display:flex;gap:10px;margin-top:20px;">
        <button class="btn-full btn-outline" style="margin-top:0;" onclick="goCheckoutStep(1)">‚Üê Kembali</button>
        <button class="btn-full btn-accent" style="margin-top:0;" onclick="goCheckoutStep(3)">Konfirmasi ‚Üí</button>
      </div>
    </div>
    <div class="checkout-step" id="checkout-step-3">
      <div id="checkout-step3-content"></div>
    </div>
  </div>
</div>

<!-- ===== PAGE: DASHBOARD ===== -->
<div class="page" id="page-dashboard">
  <nav class="navbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <button class="hamburger" onclick="openDrawer()">‚ò∞</button>
      <div class="logo" onclick="showPage('page-home')">DigiMart</div>
    </div>
    <div class="nav-right">
      <div id="dash-role-badge"></div>
      <div class="nav-avatar" id="dash-avatar"></div>
    </div>
  </nav>
  <div class="dash-header">
    <h1 id="dash-title">Dashboard</h1>
    <p id="dash-subtitle"></p>
  </div>
  <div class="dash-tabs" id="dash-tabs"></div>
  <div id="dash-content"></div>
</div>

<!-- ===== MODAL: BELI ===== -->
<div class="modal-overlay" id="modal-beli" onclick="if(event.target===this)closeModal('modal-beli')">
  <div class="modal">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h3 style="margin:0;">Konfirmasi Pembelian</h3>
      <button onclick="closeModal('modal-beli')" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:14px;">‚úï</button>
    </div>
    <div id="modal-beli-content"></div>
    <div style="margin-top:16px;display:flex;gap:10px;">
      <button class="btn-full btn-outline" style="margin-top:0;" onclick="closeModal('modal-beli')">Batal</button>
      <button class="btn-full btn-accent" style="margin-top:0;" onclick="confirmBeli()">Konfirmasi Beli</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: REVIEW ===== -->
<div class="modal-overlay" id="modal-review" onclick="if(event.target===this)closeModal('modal-review')">
  <div class="modal">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h3 style="margin:0;">Tulis Ulasan</h3>
      <button onclick="closeModal('modal-review')" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:14px;">‚úï</button>
    </div>
    <div id="modal-review-content">
      <p style="font-size:13px;color:var(--muted);margin-bottom:12px;">Berikan rating untuk produk ini:</p>
      <div class="stars-input" id="stars-input">
        <span onclick="setRating(1)">‚≠ê</span>
        <span onclick="setRating(2)">‚≠ê</span>
        <span onclick="setRating(3)">‚≠ê</span>
        <span onclick="setRating(4)">‚≠ê</span>
        <span onclick="setRating(5)">‚≠ê</span>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <textarea class="form-input form-textarea" id="review-text" placeholder="Ceritakan pengalaman kamu..."></textarea>
      </div>
    </div>
    <div style="margin-top:8px;display:flex;gap:10px;">
      <button class="btn-full btn-outline" style="margin-top:0;" onclick="closeModal('modal-review')">Batal</button>
      <div id="review-warning" style="display:none;background:rgba(255,101,132,0.1);border:1px solid rgba(255,101,132,0.3);border-radius:8px;padding:10px;font-size:12px;color:#ff6584;margin-bottom:8px;">
        ‚ö†Ô∏è Kamu hanya bisa review produk yang sudah kamu beli dan selesai
      </div>
      <button class="btn-full btn-accent" style="margin-top:0;" onclick="submitReview()">Kirim Ulasan</button>
    </div>
  </div>
</div>


<!-- ===== DRAWER ===== -->
<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div class="drawer-logo">DigiMart</div>
    <div class="drawer-user" id="drawer-user-info">
      <div class="drawer-avatar" id="drawer-avatar">üë§</div>
      <div>
        <div class="drawer-username" id="drawer-username">Tamu</div>
        <div id="drawer-role-wrap"></div>
        <div id="drawer-title-wrap"></div>
      </div>
    </div>
  </div>

  <!-- Kembali ke Beranda -->
  <div class="drawer-section">
    <div class="drawer-item" onclick="closeDrawer();showPage('page-home');">
      <span class="di-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg></span><span class="di-label">Kembali ke Beranda</span>
    </div>
  </div>
  <div class="drawer-divider"></div>

  <!-- Menu untuk semua user -->
  <div class="drawer-section">
    <div class="drawer-section-title">Umum</div>
    <div class="drawer-item" onclick="openDrawerPage('profil')">
      <span class="di-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></span><span class="di-label">Profil Akun</span>
    </div>
    <div class="drawer-item" onclick="openDrawerPage('support')">
      <span class="di-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/></svg></span><span class="di-label">Support</span>
    </div>
    <div class="drawer-item" onclick="openDrawerPage('peraturan')">
      <span class="di-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg></span><span class="di-label">Peraturan</span>
    </div>
  </div>

  <!-- Menu untuk seller -->
  <div class="drawer-divider"></div>
  <div class="drawer-section" id="drawer-seller-menu" style="display:none;">
    <div class="drawer-section-title">Seller</div>
    <div class="drawer-item" onclick="closeDrawer();showPage('page-dashboard');">
      <span class="di-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></span><span class="di-label">Dashboard</span>
    </div>
  </div>

  <!-- Menu hanya owner & co-owner -->
  <div class="drawer-divider" id="drawer-owner-divider" style="display:none;"></div>
  <div class="drawer-section" id="drawer-owner-menu" style="display:none;">
    <div class="drawer-section-title">Management</div>
    <div class="drawer-item" onclick="openDrawerPage('kelola-user')">
      <span class="di-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg></span><span class="di-label">Kelola User & Role</span>
    </div>
    <div class="drawer-item" onclick="openDrawerPage('gift-title')">
      <span class="di-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/></svg></span><span class="di-label">Gift Title</span>
    </div>
    <div class="drawer-item" onclick="openDrawerPage('statistik')">
      <span class="di-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg></span><span class="di-label">Statistik Lengkap</span>
    </div>
  </div>

  <div style="flex:1;"></div>
  <div class="drawer-divider"></div>
  <div class="drawer-section">
    <div class="drawer-item" id="drawer-auth-btn" onclick="drawerAuthAction()">
      <span class="di-icon" id="drawer-auth-icon">üö™</span>
      <span class="di-label" id="drawer-auth-label">Masuk</span>
    </div>
  </div>
</div>

<!-- ===== DRAWER PAGES ===== -->
<div class="modal-overlay" id="modal-drawer-page" onclick="handleDrawerOverlayClick(event)">
  <div class="modal" style="border-radius:20px 20px 0 0;max-height:90vh;position:relative;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
      <div class="modal-handle" style="margin:0;"></div>
      <button onclick="closeModal('modal-drawer-page')" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;">‚úï</button>
    </div>
    <div id="drawer-page-content"></div>
  </div>
</div>


<!-- ===== BOTTOM NAVBAR ===== -->
<div class="bottom-nav" id="bottom-nav" style="display:none;">
  <div class="bn-item active" id="bn-home" onclick="bottomNav('home')">
    <div class="bn-icon">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
      </svg>
    </div>
    <div class="bn-label">Beranda</div>
  </div>
  <div class="bn-item" id="bn-chat" onclick="bottomNav('chat')">
    <div class="bn-icon" style="position:relative;">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
      </svg>
      <span class="bn-badge" id="bn-chat-badge"></span>
    </div>
    <div class="bn-label">Chat</div>
  </div>
  <div class="bn-item" id="bn-profile" onclick="bottomNav('profile')">
    <div class="bn-icon">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
      </svg>
    </div>
    <div class="bn-label">Profil & Order</div>
  </div>
</div>

<!-- Toast -->
<div id="bukti-modal" onclick="if(event.target===this)closeBuktiModal()">
  <img id="bukti-modal-img" src="">
  <button id="bukti-modal-close" onclick="closeBuktiModal()">‚úï Tutup</button>
</div>
<div class="toast" id="toast"></div>

<script>
// =================== SUPABASE DATABASE ===================
// Semua data tersimpan di Supabase cloud

// Cache lokal untuk performa
let _cache = {
  users: null, produk: null, pesanan: null, reviews: null, chats: null
};

async function fetchUsers() {
  const { data } = await db.from('dm_users').select('*');
  _cache.users = (data || []).map(u => ({...u, customTitle: u.custom_title}));
  return _cache.users;
}
async function fetchProduk() {
  const { data, error } = await db.from('dm_produk').select('*');
  if (error) console.error('fetchProduk error:', error);
  _cache.produk = data || [];
  return _cache.produk;
}
async function fetchPesanan() {
  const { data } = await db.from('dm_pesanan').select('*').order('created_at', {ascending:false});
  _cache.pesanan = data || [];
  return _cache.pesanan;
}
async function fetchReviews() {
  const { data } = await db.from('dm_reviews').select('*').order('created_at', {ascending:false});
  _cache.reviews = data || [];
  return _cache.reviews;
}
async function fetchChats() {
  const { data } = await db.from('dm_chats').select('*').order('last_at', {ascending:false});
  _cache.chats = data || [];
  return _cache.chats;
}

// Sync helpers - get from cache or fetch
function getUsers() { return _cache.users || []; }
function getUser(id) { return (_cache.users || []).find(u => u.id == id) || null; }
function getProduk() { return _cache.produk || []; }
function getProdukById(id) { return (_cache.produk || []).find(p => p.id == id) || null; }
function getPesanan() { return _cache.pesanan || []; }
function getReviews() { return _cache.reviews || []; }
function getChats() { return _cache.chats || []; }

// Session di localStorage (hanya session, data di cloud)
const SESSION = {
  get: () => { try { return JSON.parse(localStorage.getItem('dm_session')); } catch { return null; } },
  set: (v) => localStorage.setItem('dm_session', JSON.stringify(v)),
  clear: () => localStorage.removeItem('dm_session'),
};

async function initData() {
  showLoading(true);
  await Promise.all([fetchUsers(), fetchProduk(), fetchPesanan(), fetchReviews(), fetchChats()]);
  showLoading(false);
}

function showLoading(show) {
  let el = document.getElementById('global-loading');
  if (!el) {
    el = document.createElement('div');
    el.id = 'global-loading';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(10,10,15,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;';
    el.innerHTML = '<div style="width:40px;height:40px;border:3px solid #6c63ff;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite;"></div><div style="color:#fff;font-size:14px;">Memuat data...</div>';
    document.head.insertAdjacentHTML('beforeend','<style>@keyframes spin{to{transform:rotate(360deg)}}</style>');
    document.body.appendChild(el);
  }
  el.style.display = show ? 'flex' : 'none';
}

// Placeholder agar kode lama tidak crash sebelum diganti
function DB_STUB() {}

// Init default data - TIDAK DIGUNAKAN LAGI (data ada di Supabase)
function initData_OLD() {
  // Data sekarang di Supabase, bukan localStorage
  // Lihat digimart-schema.sql untuk seed data
}

// =================== STATE ===================
let currentUser = SESSION.get();
let currentProdukId = null;
let currentRating = 0;
let currentOrderId = null;
let currentQty = 1;
let filterKat = 'semua';

// =================== HELPERS ===================
function formatRp(n) { return 'Rp ' + Number(n).toLocaleString('id-ID'); }
function formatNum(n) { return n >= 1000000 ? (n/1000000).toFixed(1)+'jt' : n >= 1000 ? (n/1000).toFixed(1)+'rb' : n; }

function genKode() { return 'TRX-' + Math.random().toString(36).substr(2,8).toUpperCase(); }

function roleLabel(role) {
  const map = {owner:'üëë Owner',coowner:'üíé Co-Owner',admin:'üõ°Ô∏è Admin',preadmin:'üî∞ Pre-Admin',customer:'üë§ Customer'};
  return map[role] || role;
}
function roleBadgeClass(role) {
  const map = {owner:'role-owner',coowner:'role-coowner',admin:'role-admin',preadmin:'role-preadmin',customer:'role-customer'};
  return map[role] || 'role-customer';
}
function canManageUsers(role) { return ['owner','coowner'].includes(role); }
function canAddProduk(role) {
  if (role === 'owner' || role === 'coowner') return Infinity;
  if (role === 'admin') return 10;
  if (role === 'preadmin') return 3;
  return 0;
}
function canOrder(role) {
  if (role === 'owner' || role === 'coowner' || role === 'customer') return Infinity;
  if (role === 'admin' || role === 'preadmin') return 3;
  return 0;
}

// =================== NAVIGATION ===================
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
  if (id === 'page-home') { renderNavbar(); renderProdukGrid(); renderHeroStats(); }
  if (id === 'page-dashboard') renderDashboard();
  // Show/hide bottom nav ‚Äî disembunyikan di chatroom karena ada input bar
  const showBotNav = currentUser && ['page-home','page-chat','page-detail'].includes(id);
  const botNav = document.getElementById('bottom-nav');
  if (botNav) botNav.style.display = showBotNav ? 'flex' : 'none';
  // Update active state
  if (id === 'page-home') setBottomNavActive('home');
  else if (id === 'page-chat' || id === 'page-chatroom') setBottomNavActive('chat');
}

function setBottomNavActive(tab) {
  ['home','chat','profile'].forEach(t => {
    const el = document.getElementById('bn-' + t);
    if (el) el.classList.toggle('active', t === tab);
  });
}

function bottomNav(tab) {
  if (!currentUser) { showPage('page-login'); return; }
  if (tab === 'home') { showPage('page-home'); }
  else if (tab === 'chat') { renderChatList(); showPage('page-chat'); setBottomNavActive('chat'); }
  else if (tab === 'profile') { openProfileOrder(); }
}

function showToast(msg, duration=2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// =================== NAVBAR ===================
function renderNavbar() {
  const nr = document.getElementById('nav-right');
  if (currentUser) {
    const showDashBtn = currentUser.role !== 'customer';
    nr.innerHTML = `
      <span class="role-badge ${roleBadgeClass(currentUser.role)}">${roleLabel(currentUser.role)}</span>
      ${showDashBtn ? `<button class="nav-btn" onclick="showPage('page-dashboard')">Dashboard</button>` : ''}
      <div class="nav-avatar" title="${currentUser.username}">${currentUser.avatar || currentUser.username[0].toUpperCase()}</div>
    `;
  } else {
    nr.innerHTML = `
      <button class="nav-btn" onclick="showPage('page-login')">Masuk</button>
      <button class="nav-btn primary" onclick="showPage('page-register')">Daftar</button>
    `;
  }
  // Show bottom nav if logged in
  const botNav = document.getElementById('bottom-nav');
  if (botNav) botNav.style.display = currentUser ? 'flex' : 'none';
}

// =================== HERO STATS ===================
function renderHeroStats() {
  const produk = getProduk().filter(p => p.status === 'aktif' || p.status === 'active' || (p.status !== 'nonaktif' && p.status !== 'inactive'));
  const sellers = getUsers().filter(u => ['admin','preadmin'].includes(u.role) && u.status === 'active');
  const pesanan = getPesanan();
  document.getElementById('stat-produk').textContent = produk.length;
  document.getElementById('stat-seller').textContent = sellers.length;
  document.getElementById('stat-transaksi').textContent = formatNum(pesanan.length);
}

// =================== PRODUK GRID ===================
function filterKategori(kat, btn) {
  filterKat = kat;
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderProdukGrid();
}

function renderProdukGrid() {
  let produk = getProduk().filter(p => p.status === 'aktif' || p.status === 'active' || (p.status !== 'nonaktif' && p.status !== 'inactive'));
  const q = document.getElementById('search-input')?.value.toLowerCase() || '';
  if (q) produk = produk.filter(p => p.nama.toLowerCase().includes(q) || p.deskripsi.toLowerCase().includes(q));
  if (filterKat !== 'semua') produk = produk.filter(p => p.kategori === filterKat);

  const grid = document.getElementById('produk-grid');
  const empty = document.getElementById('produk-empty');
  document.getElementById('produk-count').textContent = produk.length + ' produk';

  if (produk.length === 0) { grid.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  const catEmoji = {game:'üéÆ',voucher:'üé´',jasa:'üõ†Ô∏è',software:'üíª',lainnya:'üì¶'};

  grid.innerHTML = produk.map(p => {
    const reviews = getReviews().filter(r => r.produk_id === p.id);
    const avgRating = reviews.length ? (reviews.reduce((s,r) => s+r.rating,0)/reviews.length).toFixed(1) : null;
    const seller = getUser(p.seller_id);
    return `
    <div class="produk-card" onclick="showDetail(${p.id})">
      <div class="produk-img">
        ${p.foto ? `<img src="${p.foto}" style="width:100%;height:100%;object-fit:cover;border-radius:0;">` : (p.emoji || catEmoji[p.kategori] || 'üì¶')}
        <span class="produk-cat-badge">${p.kategori}</span>
      </div>
      <div class="produk-body">
        <div class="produk-nama">${p.nama}</div>
        <div class="produk-seller">üë§ ${seller?.username || 'Unknown'}</div>
        <div class="produk-rating">
          <span class="star">‚≠ê</span>
          <span>${avgRating || '-'}</span>
          <span style="color:var(--muted);">(${reviews.length})</span>
        </div>
        <div class="produk-meta">
          <div>
            <div class="produk-harga">${formatRp(p.harga)}</div>
            <div class="produk-terjual">${formatNum(p.terjual)} terjual</div>
          </div>
          <div style="font-size:10px;color:var(--muted);">Stok ${formatNum(p.stok)}</div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// =================== DETAIL PRODUK ===================
function showDetail(id) {
  currentProdukId = id;
  const p = getProdukById(id);
  if (!p) return;
  const seller = getUser(p.seller_id);
  const reviews = getReviews().filter(r => r.produk_id === id);
  const avgRating = reviews.length ? (reviews.reduce((s,r) => s+r.rating,0)/reviews.length).toFixed(1) : '-';
  const sellerProduk = getProduk().filter(x => x.seller_id === p.seller_id);
  const sellerTerjual = sellerProduk.reduce((s,x) => s+x.terjual, 0);
  const sellerRatings = getReviews().filter(r => sellerProduk.some(x => x.id === r.produk_id));
  const sellerAvg = sellerRatings.length ? (sellerRatings.reduce((s,r)=>s+r.rating,0)/sellerRatings.length).toFixed(1) : '-';

  const detailImgEl = document.getElementById('detail-img');
  if (p.foto) {
    detailImgEl.innerHTML = `<img src="${p.foto}" style="width:100%;height:100%;object-fit:cover;">`;
  } else {
    detailImgEl.innerHTML = p.emoji || 'üì¶';
  }
  document.getElementById('detail-breadcrumb').textContent = p.nama;
  document.getElementById('detail-cat-badge').textContent = p.kategori;
  document.getElementById('detail-nama').textContent = p.nama;
  document.getElementById('detail-harga').textContent = formatRp(p.harga);
  document.getElementById('ds-rating').textContent = avgRating;
  document.getElementById('ds-terjual').textContent = formatNum(p.terjual);
  document.getElementById('ds-stok').textContent = formatNum(p.stok);

  // Tab: Info Penjual
  document.getElementById('tab-info-penjual').innerHTML = `
    <div class="seller-card">
      <div class="seller-top">
        <div class="seller-avatar">${seller?.avatar || seller?.username[0].toUpperCase() || '?'}</div>
        <div>
          <div class="seller-name">${seller?.username || 'Unknown'}</div>
          <div style="margin:3px 0;"><span class="role-badge ${roleBadgeClass(seller?.role)}">${roleLabel(seller?.role)}</span></div>
          <div class="seller-online"><span class="online-dot"></span> Online 2 jam lalu</div>
        </div>
        <div style="margin-left:auto;text-align:right;">
          <div style="font-size:20px;font-weight:800;color:var(--gold);">${sellerAvg}</div>
          <div style="font-size:10px;color:var(--muted);">Rating</div>
        </div>
      </div>
      <div class="seller-grid">
        <div class="seller-stat"><div class="sv">${formatNum(sellerTerjual)}</div><div class="sl">Total Terjual</div></div>
        <div class="seller-stat"><div class="sv">${sellerProduk.length}</div><div class="sl">Produk</div></div>
        <div class="seller-stat"><div class="sv">${sellerRatings.length}</div><div class="sl">Ulasan</div></div>
        <div class="seller-stat"><div class="sv">‚ö° 1j 25m</div><div class="sl">Waktu Respon</div></div>
      </div>
    </div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Min. Beli: 1 ¬∑ Pengiriman: Instan</p>
    <div style="display:flex;gap:10px;margin-bottom:8px;">
      <button class="btn-chat" onclick="handleChat()" style="flex-shrink:0;">üí¨</button>
      <button class="btn-buy" onclick="handleBuy()" style="flex:1;">üõí Beli Sekarang</button>
    </div>
  `;

  // Tab: Deskripsi
  document.getElementById('tab-deskripsi').innerHTML = `
    <p style="font-size:14px;line-height:1.8;color:rgba(240,240,255,0.85);">${p.deskripsi}</p>
  `;

  // Tab: Panduan
  document.getElementById('tab-panduan').innerHTML = `
    <div style="font-size:14px;line-height:2;color:rgba(240,240,255,0.85);">
      ${(p.panduan || 'Panduan belum tersedia.').replace(/\n/g,'<br>')}
    </div>
  `;

  // Tab: Ulasan
  renderUlasan(id, reviews, avgRating);

  // Reset tabs
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector('#page-detail .tab').classList.add('active');
  document.getElementById('tab-info-penjual').classList.add('active');

  showPage('page-detail');
}

function renderUlasan(produkId, reviews, avgRating) {
  const dist = [5,4,3,2,1].map(s => reviews.filter(r => r.rating === s).length);
  const total = reviews.length;
  document.getElementById('tab-ulasan').innerHTML = `
    ${total > 0 ? `
    <div class="rating-summary">
      <div class="rating-big">
        <div class="num">${avgRating}</div>
        <div class="stars">${'‚≠ê'.repeat(Math.round(parseFloat(avgRating)))}</div>
        <div class="cnt">${total} ulasan</div>
      </div>
      <div class="rating-bars">
        ${[5,4,3,2,1].map((s,i) => `
          <div class="rating-bar-row">
            <span>${s}</span>
            <div class="rating-bar-bg">
              <div class="rating-bar-fill" style="width:${total?Math.round(dist[i]/total*100):0}%"></div>
            </div>
            <span style="font-size:10px;color:var(--muted);width:20px;">${dist[i]}</span>
          </div>`).join('')}
      </div>
    </div>` : ''}
    ${currentUser && currentUser.role !== 'preadmin' ? `
    <button class="btn-full btn-outline" style="margin-bottom:14px;" onclick="openReviewModal(${produkId})">
      ‚úçÔ∏è Tulis Ulasan
    </button>` : ''}
    ${reviews.length === 0 ? '<div class="empty"><div class="eicon">üí¨</div><p>Belum ada ulasan</p></div>' :
      reviews.map(r => `
        <div class="review-item">
          <div class="review-header">
            <div class="review-user">üë§ ${r.username}</div>
            <div class="review-date">${new Date(r.created_at).toLocaleDateString('id-ID')}</div>
          </div>
          <div class="review-stars">${'‚≠ê'.repeat(r.rating)}${'‚òÜ'.repeat(5-r.rating)}</div>
          <div class="review-text">${r.teks}</div>
        </div>`).join('')
    }
  `;
}

function switchTab(id, btn) {
  document.querySelectorAll('#page-detail .tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('#page-detail .tab-content').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + id).classList.add('active');
}

// =================== AUTH ===================
async function doLogin() {
  const username = document.getElementById('l-user').value.trim();
  const password = document.getElementById('l-pass').value;
  const errEl = document.getElementById('login-err');
  errEl.style.display = 'none';
  showLoading(true);
  const hashed = await hashPassword(password);
  // Coba hash dulu, fallback plain text untuk akun lama
  let { data, error } = await db.from('dm_users')
    .select('*').eq('username', username).eq('password', hashed).single();
  if (error || !data) {
    const res2 = await db.from('dm_users')
      .select('*').eq('username', username).eq('password', password).single();
    if (!res2.error && res2.data) {
      data = res2.data; error = null;
      // Auto-upgrade password ke hashed
      await db.from('dm_users').update({ password: hashed }).eq('id', data.id);
    }
  }
  showLoading(false);
  if (error || !data) { errEl.textContent = '‚ùå Username atau password salah'; errEl.style.display='block'; return; }
  if (data.status === 'pending') { errEl.textContent = '‚è≥ Akun kamu belum disetujui admin'; errEl.style.display='block'; return; }
  if (data.status === 'rejected') { errEl.textContent = '‚ùå Akun kamu ditolak'; errEl.style.display='block'; return; }
  const user = {...data, customTitle: data.custom_title};
  currentUser = user;
  SESSION.set(user);
  // Refresh cache
  await fetchUsers();
  showToast('‚úÖ Selamat datang, ' + user.username + '!');
  showPage('page-home');
}

async function doRegister() {
  const username = document.getElementById('r-user').value.trim();
  const email = document.getElementById('r-email').value.trim();
  const password = document.getElementById('r-pass').value;
  const tipe = document.getElementById('r-tipe').value;
  const errEl = document.getElementById('reg-err');

  if (username.length < 4) { errEl.textContent = '‚ùå Username minimal 4 karakter'; errEl.style.display='block'; return; }
  if (password.length < 6) { errEl.textContent = '‚ùå Password minimal 6 karakter'; errEl.style.display='block'; return; }

  errEl.style.display = 'none';
  showLoading(true);
  const { data: existing } = await db.from('dm_users').select('id').eq('username', username).single();
  if (existing) { showLoading(false); errEl.textContent = '‚ùå Username sudah digunakan'; errEl.style.display='block'; return; }

  const hashedPass = await hashPassword(password);
  const newUser = {
    username, email, password: hashedPass, role: tipe,
    status: tipe === 'preadmin' ? 'pending' : 'active',
    joined: Date.now(),
    avatar: tipe === 'preadmin' ? 'üî∞' : 'üë§'
  };
  const { data, error } = await db.from('dm_users').insert(newUser).select().single();
  showLoading(false);

  if (error) { errEl.textContent = '‚ùå Gagal membuat akun: ' + error.message; errEl.style.display='block'; return; }

  await fetchUsers();
  const user = {...data, customTitle: data.custom_title};

  if (tipe === 'preadmin') {
    showToast('‚úÖ Akun dibuat! Menunggu persetujuan admin.');
    showPage('page-login');
  } else {
    currentUser = user;
    SESSION.set(user);
    showToast('‚úÖ Akun berhasil dibuat!');
    showPage('page-home');
  }
}

function doLogout() {
  currentUser = null;
  SESSION.clear();
  showToast('üëã Berhasil keluar');
  showPage('page-home');
}

// =================== BUY ===================
function handleBuy() {
  if (!currentUser) { showToast('‚ö†Ô∏è Login dulu untuk membeli!'); showPage('page-login'); return; }
  const p = getProdukById(currentProdukId);
  if (!p || p.stok === 0) { showToast('‚ùå Stok habis!'); return; }

  // Go to checkout page
  currentQty = 1;
  selectedPayment = 'transfer';
  openCheckout();
}

function renderModalBeli() {
  const p = getProdukById(currentProdukId);
  const seller = getUser(p.seller_id);
  const total = p.harga * currentQty;
  document.getElementById('modal-beli-content').innerHTML = `
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:14px;">
      <div style="font-size:28px;text-align:center;margin-bottom:10px;">${p.emoji}</div>
      <div style="font-weight:700;font-size:15px;margin-bottom:3px;">${p.nama}</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:12px;">Seller: ${seller?.username} ¬∑ Stok: ${p.stok}</div>
      
      <!-- QTY SELECTOR -->
      <div style="display:flex;align-items:center;justify-content:space-between;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:12px;">
        <span style="font-size:13px;color:var(--muted);">Jumlah</span>
        <div style="display:flex;align-items:center;gap:14px;">
          <button onclick="changeQty(-1)" style="width:32px;height:32px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚àí</button>
          <span id="qty-display" style="font-family:var(--font-head);font-size:18px;font-weight:700;min-width:24px;text-align:center;">${currentQty}</span>
          <button onclick="changeQty(1)" style="width:32px;height:32px;border-radius:50%;background:var(--accent);border:none;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;">+</button>
        </div>
      </div>

      <!-- PRICE BREAKDOWN -->
      <div style="border-top:1px solid var(--border);padding-top:10px;">
        <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--muted);margin-bottom:4px;">
          <span>Harga satuan</span><span>${formatRp(p.harga)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--muted);margin-bottom:8px;">
          <span>Jumlah</span><span>√ó ${currentQty}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-weight:700;font-size:14px;">Total</span>
          <span id="total-display" style="font-family:var(--font-head);font-size:20px;font-weight:800;color:var(--accent);">${formatRp(total)}</span>
        </div>
      </div>
    </div>
    <p style="font-size:12px;color:var(--muted);">‚ö†Ô∏è Ini adalah simulasi. Pembayaran akan diintegrasikan nanti.</p>
  `;
}

function changeQty(delta) {
  const p = getProdukById(currentProdukId);
  if (!p) return;
  currentQty = Math.max(1, Math.min(currentQty + delta, p.stok));
  // Update display without re-rendering whole modal
  document.getElementById('qty-display').textContent = currentQty;
  document.getElementById('total-display').textContent = formatRp(p.harga * currentQty);
  // Update breakdown
  renderModalBeli();
}

async function confirmBeli() {
  const p = getProdukById(currentProdukId);
  if (!p) return;
  const qty = currentQty || 1;
  if (qty > p.stok) { showToast('‚ùå Stok tidak mencukupi!'); return; }

  showLoading(true);
  const kode = genKode();
  const { error: orderErr } = await db.from('dm_pesanan').insert({
    produk_id: p.id, buyer_id: currentUser.id, seller_id: p.seller_id,
    harga: p.harga * qty, qty, status: 'menunggu-bayar',
    created_at: Date.now(), kode
  });
  if (!orderErr) {
    await db.from('dm_produk').update({
      terjual: p.terjual + qty, stok: Math.max(0, p.stok - qty)
    }).eq('id', p.id);
    await Promise.all([fetchPesanan(), fetchProduk()]);
  }
  showLoading(false);
  closeModal('modal-beli');
  currentQty = 1;
  showToast('‚úÖ ' + qty + 'x ' + p.nama + ' berhasil dibeli!');
  showDetail(currentProdukId);
}

function handleChat() {
  if (!currentUser) { showToast('‚ö†Ô∏è Login dulu!'); showPage('page-login'); return; }
  const p = getProdukById(currentProdukId);
  if (!p) return;
  // Buyer can't chat themselves if they are the seller
  if (currentUser.id === p.seller_id) { showToast('‚ö†Ô∏è Ini produk kamu sendiri!'); return; }
  openChatRoom(p.seller_id, p.id);
}

// =================== REVIEW ===================
function openReviewModal(produkId) {
  if (!currentUser) { showToast('‚ö†Ô∏è Login dulu!'); return; }
  currentProdukId = produkId;
  currentRating = 0;
  document.getElementById('review-text').value = '';
  setRating(0);
  openModal('modal-review');
}

function setRating(n) {
  currentRating = n;
  document.querySelectorAll('.stars-input span').forEach((s,i) => {
    s.classList.toggle('active', i < n);
  });
}

async function submitReview() {
  if (!currentRating) { showToast('‚ö†Ô∏è Pilih rating dulu!'); return; }
  const teks = document.getElementById('review-text').value.trim();
  if (!teks) { showToast('‚ö†Ô∏è Tulis ulasan dulu!'); return; }

  showLoading(true);

  // Bug Fix 1: Cek apakah user sudah pernah beli produk ini (status selesai)
  const pesananSelesai = getPesanan().filter(o => 
    o.buyer_id == currentUser.id && 
    o.produk_id == currentProdukId && 
    o.status === 'selesai'
  );
  if (pesananSelesai.length === 0) {
    showLoading(false);
    closeModal('modal-review');
    showToast('‚ö†Ô∏è Kamu harus membeli & menyelesaikan pesanan dulu!');
    return;
  }

  // Bug Fix 2: Cek apakah user sudah pernah review produk ini
  const sudahReview = getReviews().find(r => 
    r.user_id == currentUser.id && r.produk_id == currentProdukId
  );
  if (sudahReview) {
    showLoading(false);
    closeModal('modal-review');
    showToast('‚ö†Ô∏è Kamu sudah pernah memberikan ulasan untuk produk ini!');
    return;
  }

  await db.from('dm_reviews').insert({
    produk_id: currentProdukId, user_id: currentUser.id,
    username: currentUser.username, rating: currentRating, teks,
    created_at: Date.now(), order_id: currentOrderId || null
  });
  await fetchReviews();
  showLoading(false);
  closeModal('modal-review');
  showToast('‚úÖ Ulasan berhasil dikirim!');
  showDetail(currentProdukId);
}

// =================== DASHBOARD ===================
function renderDashboard() {
  if (!currentUser) { showPage('page-login'); return; }
  const u = currentUser;

  // Customer tidak bisa akses dashboard
  if (u.role === 'customer') {
    showToast('‚õî Customer tidak memiliki akses dashboard!');
    showPage('page-home');
    return;
  }

  document.getElementById('dash-title').textContent = 'Dashboard ' + roleLabel(u.role);
  document.getElementById('dash-subtitle').textContent = 'Halo, ' + u.username + '! üëã';
  document.getElementById('dash-avatar').textContent = u.avatar || u.username[0].toUpperCase();
  document.getElementById('dash-role-badge').innerHTML = `<span class="role-badge ${roleBadgeClass(u.role)}">${roleLabel(u.role)}</span>`;

  // Build tabs based on role
  let tabs = [];
  tabs.push({id:'produk', label:'üç™ Produk Saya'});
  tabs.push({id:'pesanan', label:'üì¶ Pesanan'});
  tabs.push({id:'monitor-chat', label:'üí¨ Chat'});
  // Kelola User, Approval, Monitor Chat, Laporan hanya untuk owner & coowner
  if (['owner','coowner'].includes(u.role)) {
    tabs.push({id:'users', label:'üë• Kelola User'});
    tabs.push({id:'approval', label:'‚è≥ Approval'});
    tabs.push({id:'laporan', label:'üìà Laporan'});
  }
  tabs.push({id:'akun', label:'‚öôÔ∏è Akun'});

  document.getElementById('dash-tabs').innerHTML = tabs.map((t,i) =>
    `<button class="dash-tab ${i===0?'active':''}" onclick="switchDashTab('${t.id}',this)">${t.label}</button>`
  ).join('');

  renderDashSection(tabs[0]?.id);

  const content = document.getElementById('dash-content');
  content.innerHTML = tabs.map(t =>
    `<div class="dash-section ${tabs[0].id===t.id?'active':''}" id="dsec-${t.id}"></div>`
  ).join('');

  tabs.forEach(t => renderDashSection(t.id));
}

function switchDashTab(id, btn) {
  document.querySelectorAll('.dash-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.dash-section').forEach(s => s.classList.remove('active'));
  btn.classList.add('active');
  const sec = document.getElementById('dsec-' + id);
  if (sec) { sec.classList.add('active'); renderDashSection(id); }
}

function switchPesananTab(status, btn) {
  document.querySelectorAll('#dash-pesanan-tabs .order-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const listEl = document.getElementById('dash-pesanan-list');
  if (listEl && window._renderPesananList) {
    listEl.innerHTML = window._renderPesananList(status);
  }
}

async function updateStatusPesanan(orderId, newStatus) {
  const pesanan = getPesanan();
  const o = pesanan.find(o => o.id === orderId);
  if (!o) return;

  const u = currentUser;
  const isSellerOrOwner = ['owner','coowner'].includes(u.role) || o.seller_id == u.id;
  if (!isSellerOrOwner) { showToast('‚õî Kamu tidak punya akses!'); return; }

  showLoading(true);
  await db.from('dm_pesanan').update({status: newStatus}).eq('id', orderId);
  await fetchPesanan();
  showLoading(false);

  const statusMsg = {
    'menunggu-kirim': '‚úÖ Pembayaran dikonfirmasi!',
    'dikirim': 'üöö Pesanan ditandai terkirim!',
    'selesai': '‚úÖ Pesanan selesai!'
  }[newStatus] || 'Status diperbarui!';

  showToast(statusMsg);
  renderDashSection('pesanan');
}

function renderDashSection(id) {
  const el = document.getElementById('dsec-' + id);
  if (!el) return;
  const u = currentUser;

  if (id === 'produk') {
    const myProduk = getProduk().filter(p => p.seller_id == u.id);
    const limit = canAddProduk(u.role);
    const canSell = limit > 0;
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin:14px 0 10px;">
        <span style="font-size:13px;color:var(--muted);">
          ${canSell ? `${myProduk.length}/${limit === Infinity ? '‚àû' : limit} produk` : 'Kamu adalah pembeli'}
        </span>
        ${canSell ? (myProduk.length < limit ? `<button class="nav-btn primary" onclick="openAddProduk()">+ Tambah</button>` : `<span style="font-size:12px;color:var(--accent2);">Limit tercapai</span>`) : ''}
      </div>
      ${!canSell ? '<div class="empty"><div class="eicon">üõí</div><p>Kamu terdaftar sebagai pembeli.<br>Tidak bisa menambah produk.</p></div>' :
      myProduk.length === 0 ? '<div class="empty"><div class="eicon">üì¶</div><p>Belum ada produk. Yuk tambah!</p></div>' :
        myProduk.map(p => `
          <div class="card" style="cursor:pointer;">
            <div style="display:flex;align-items:center;gap:10px;">
              <div style="width:44px;height:44px;border-radius:10px;overflow:hidden;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0;">
                ${p.foto ? `<img src="${p.foto}" style="width:100%;height:100%;object-fit:cover;">` : (p.emoji || 'üì¶')}
              </div>
              <div style="flex:1;">
                <div style="font-weight:600;font-size:13px;">${p.nama}</div>
                <div style="font-size:12px;color:var(--accent);font-weight:700;">${formatRp(p.harga)}</div>
                <div style="font-size:11px;color:var(--muted);">Stok: ${p.stok} ¬∑ Terjual: ${formatNum(p.terjual)}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:4px;">
                <button class="action-btn btn-promote" onclick="editProduk(${p.id})">‚úèÔ∏è</button>
                <button class="action-btn btn-reject" onclick="hapusProduk(${p.id})">üóëÔ∏è</button>
              </div>
            </div>
          </div>`).join('')
      }
      <div id="form-produk-wrap" style="display:none;">
        <div class="card">
          <h3>TAMBAH PRODUK</h3>
          <div class="form-group"><label class="form-label">Nama Produk</label><input class="form-input" id="fp-nama" placeholder="Nama produk"></div>
          <div class="form-group"><label class="form-label">Kategori</label>
            <select class="form-select" id="fp-kat">
              <option value="game">üéÆ Game</option>
              <option value="voucher">üé´ Voucher</option>
              <option value="jasa">üõ†Ô∏è Jasa</option>
              <option value="software">üíª Software</option>
              <option value="lainnya">üì¶ Lainnya</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Harga (Rp)</label><input class="form-input" id="fp-harga" type="number" placeholder="15000"></div>
            <div class="form-group"><label class="form-label">Stok</label><input class="form-input" id="fp-stok" type="number" placeholder="100"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Foto Produk</label>
            <div id="fp-img-preview" style="width:100%;height:140px;border:2px dashed var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:8px;background:var(--surface2);cursor:pointer;overflow:hidden;" onclick="document.getElementById('fp-img-input').click()">
              <div id="fp-img-placeholder" style="text-align:center;color:var(--muted);">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width:40px;height:40px;margin:0 auto 6px;display:block;color:var(--accent);"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                <div style="font-size:12px;">Tap untuk upload foto</div>
                <div style="font-size:10px;margin-top:2px;">JPG, PNG max 2MB</div>
              </div>
              <img id="fp-img-result" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:10px;">
            </div>
            <input type="file" id="fp-img-input" accept="image/*" style="display:none;" onchange="previewFotoProduk(this)">
            <input type="hidden" id="fp-img-base64">
          </div>
          <div class="form-group"><label class="form-label">Emoji Produk (opsional, jika tidak ada foto)</label><input class="form-input" id="fp-emoji" placeholder="üéÆ"></div>
          <div class="form-group"><label class="form-label">Deskripsi</label><textarea class="form-input form-textarea" id="fp-desc" placeholder="Deskripsi produk..."></textarea></div>
          <div class="form-group"><label class="form-label">Panduan Aktivasi</label><textarea class="form-input form-textarea" id="fp-panduan" placeholder="Langkah 1...\nLangkah 2..."></textarea></div>
          <input type="hidden" id="fp-id">
          <button class="btn-full btn-accent" onclick="saveProduk()">Simpan Produk</button>
          <button class="btn-full btn-outline" onclick="document.getElementById('form-produk-wrap').style.display='none'">Batal</button>
        </div>
      </div>
    `;
  }

  if (id === 'pesanan') {
    // Semua role seller lihat pesanan sesuai toko mereka, owner/coowner lihat semua
    const semuaPesanan = ['owner','coowner'].includes(u.role)
      ? getPesanan()
      : getPesanan().filter(o => o.seller_id == u.id);

    const statusTabs = [
      {key:'semua', label:'Semua'},
      {key:'menunggu-bayar', label:'‚è≥ Menunggu Bayar'},
      {key:'menunggu-kirim', label:'üì¶ Menunggu Dikirim'},
      {key:'dikirim', label:'üöö Dikirim'},
      {key:'selesai', label:'‚úÖ Selesai'},
    ];

    function renderPesananList(filterStatus) {
      const filtered = filterStatus === 'semua' ? semuaPesanan : semuaPesanan.filter(o => o.status === filterStatus);
      if (filtered.length === 0) return '<div class="empty"><div class="eicon">üì¶</div><p>Tidak ada pesanan</p></div>';
      return filtered.slice(0,30).map(o => {
        const p = getProdukById(o.produk_id);
        const buyer = getUser(o.buyer_id);
        const seller = getUser(o.seller_id);
        const badgeClass = {
          'menunggu-bayar':'badge-pending',
          'menunggu-kirim':'badge-active',
          'dikirim':'badge-approved',
          'selesai':'badge-approved',
          'dibatalkan':'badge-rejected'
        }[o.status] || 'badge-pending';
        const statusLabel = {
          'menunggu-bayar':'‚è≥ Menunggu Bayar',
          'menunggu-konfirmasi':'üîç Menunggu Konfirmasi Owner',
          'menunggu-kirim':'üì¶ Menunggu Kirim',
          'dikirim':'üöö Dikirim',
          'selesai':'‚úÖ Selesai',
          'dibatalkan':'‚ùå Dibatalkan'
        }[o.status] || o.status;

        // Hanya seller pemilik produk atau owner/coowner yang bisa update status
        const isSellerOrOwner = ['owner','coowner'].includes(u.role) || o.seller_id == u.id;

        let actionBtn = '';
        const isOwnerCoowner = ['owner','coowner'].includes(u.role);
        if (isSellerOrOwner) {
          if (o.status === 'menunggu-konfirmasi' && isOwnerCoowner) {
            const buktiSrc = o.bukti_transfer || '';
            const buktiHtml = buktiSrc ? `<div style="margin-bottom:8px;"><img src="${buktiSrc}" style="width:100%;border-radius:8px;max-height:150px;object-fit:contain;background:#111;" id="bukti-img-${o.id}"></div><div style="display:flex;gap:6px;margin-bottom:6px;"><a href="${buktiSrc}" download="bukti-transfer-${o.kode || o.id}.jpg" style="flex:1;text-align:center;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px;border-radius:8px;font-size:11px;text-decoration:none;font-weight:600;">‚¨áÔ∏è Download Bukti</a><button onclick="showBuktiModal('${buktiSrc}')" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px;border-radius:8px;font-size:11px;cursor:pointer;font-weight:600;">üîç Perbesar</button></div>` : '<div style="font-size:11px;color:#ff6584;margin-bottom:6px;">‚ö†Ô∏è Buyer belum upload bukti transfer</div>';
            actionBtn = buktiHtml + `<div style="display:flex;gap:6px;"><button class="action-btn btn-approve" style="margin-top:0;flex:1;" onclick="updateStatusPesanan(${o.id},'menunggu-kirim')">‚úÖ Konfirmasi</button><button class="action-btn btn-reject" style="margin-top:0;flex:1;" onclick="updateStatusPesanan(${o.id},'dibatalkan')">‚ùå Tolak</button></div>`;
          } else if (o.status === 'menunggu-bayar') {
            actionBtn = `<button class="action-btn btn-approve" style="margin-top:8px;width:100%;opacity:0.5;cursor:not-allowed;" disabled>‚è≥ Menunggu Bukti Bayar</button>`;
          } else if (o.status === 'menunggu-kirim') {
            actionBtn = `<button class="action-btn btn-approve" style="margin-top:8px;width:100%;background:rgba(0,212,170,0.2);color:var(--green);border-color:rgba(0,212,170,0.4);" onclick="updateStatusPesanan(${o.id},'dikirim')">üöö Tandai Terkirim</button>`;
          } else if (o.status === 'dikirim') {
            actionBtn = `<button class="action-btn btn-approve" style="margin-top:8px;width:100%;background:rgba(108,99,255,0.2);color:var(--accent);border-color:rgba(108,99,255,0.4);" onclick="updateStatusPesanan(${o.id},'selesai')">‚úÖ Selesaikan Pesanan</button>`;
          }
        }

        return `
        <div class="card">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="font-size:28px;">${p?.emoji || 'üì¶'}</div>
            <div style="flex:1;">
              <div style="font-weight:600;font-size:13px;">${p?.nama || 'Produk dihapus'}</div>
              <div style="font-size:11px;color:var(--muted);">Pembeli: ${buyer?.username || '-'}</div>
              ${['owner','coowner'].includes(u.role) ? `<div style="font-size:11px;color:var(--muted);">Toko: ${seller?.username || '-'}</div>` : ''}
              <div style="font-size:11px;color:var(--muted);">${new Date(o.created_at).toLocaleDateString('id-ID')}</div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:700;font-size:13px;color:var(--accent);">${formatRp(o.harga)}</div>
              <span class="list-badge ${badgeClass}" style="font-size:9px;">${statusLabel}</span>
            </div>
          </div>
          ${actionBtn}
        </div>`;
      }).join('');
    }

    el.innerHTML = `
      <div style="font-size:12px;color:var(--muted);margin:14px 0 10px;">
        ${semuaPesanan.length} pesanan masuk
      </div>
      <div class="order-tabs" id="dash-pesanan-tabs">
        ${statusTabs.map((s,i) => `
          <div class="order-tab ${i===0?'active':''}" onclick="switchPesananTab('${s.key}',this)">${s.label}</div>
        `).join('')}
      </div>
      <div id="dash-pesanan-list">${renderPesananList('semua')}</div>
    `;

    window._renderPesananList = renderPesananList;
  }

  if (id === 'users' && canManageUsers(u.role)) {
    const users = getUsers().filter(x => x.id !== u.id && x.status === 'active');
    el.innerHTML = `
      <div style="margin:14px 0 10px;font-size:13px;color:var(--muted);">${users.length} pengguna aktif</div>
      <div class="card">
        ${users.map(usr => `
          <div class="user-item">
            <div class="user-av">${usr.avatar || usr.username[0].toUpperCase()}</div>
            <div class="user-info">
              <div class="user-name">${usr.username}</div>
              <div class="user-role"><span class="role-badge ${roleBadgeClass(usr.role)}">${roleLabel(usr.role)}</span></div>
            </div>
            <div class="action-btns">
              ${usr.role !== 'owner' && (u.role === 'owner' || usr.role !== 'coowner') ? `
                <button class="action-btn btn-promote" onclick="promoteUser(${usr.id})" title="Naikan role">‚ñ≤</button>
                <button class="action-btn btn-demote" onclick="demoteUser(${usr.id})" title="Turunkan role">‚ñº</button>
              ` : ''}
              ${u.role === 'owner' && usr.role !== 'owner' ? `<button class="action-btn btn-delete" onclick="deleteUser(${usr.id})">üóëÔ∏è</button>` : ''}
            </div>
          </div>`).join('')}
      </div>
    `;
  }

  if (id === 'approval' && canManageUsers(u.role)) {
    const pending = getUsers().filter(x => x.status === 'pending');
    el.innerHTML = `
      <div style="margin:14px 0 10px;font-size:13px;color:var(--muted);">${pending.length} menunggu persetujuan</div>
      ${pending.length === 0 ? '<div class="empty"><div class="eicon">‚úÖ</div><p>Tidak ada yang menunggu</p></div>' :
        pending.map(usr => `
          <div class="card">
            <div class="user-item" style="border:none;padding:0;">
              <div class="user-av">${usr.avatar}</div>
              <div class="user-info">
                <div class="user-name">${usr.username}</div>
                <div style="font-size:11px;color:var(--muted);">${usr.email}</div>
                <div style="font-size:11px;color:var(--muted);">Daftar: ${new Date(usr.joined).toLocaleDateString('id-ID')}</div>
              </div>
              <div class="action-btns" style="flex-direction:column;">
                <button class="action-btn btn-approve" onclick="approveUser(${usr.id})">‚úÖ Setuju</button>
                <button class="action-btn btn-reject" onclick="rejectUser(${usr.id})">‚ùå Tolak</button>
              </div>
            </div>
          </div>`).join('')}
    `;
  }

  if (id === 'monitor-chat') {
    const allChats = getChats();

    // Seller hanya lihat chat yang melibatkan mereka
    // Owner/coowner lihat semua chat
    // Owner/coowner: lihat semua chat. Admin/preadmin: lihat chat mereka sendiri
    const visibleChats = ['owner','coowner'].includes(u.role)
      ? allChats
      : allChats.filter(c => c.uid1 == u.id || c.uid2 == u.id);

    function renderChatCard(chat) {
      const u1 = getUser(chat.uid1), u2 = getUser(chat.uid2);
      const lastMsg = chat.messages?.length ? chat.messages[chat.messages.length-1] : null;
      const produk = chat.produk_id ? getProdukById(chat.produk_id) : null;

      // Tentukan siapa partner chat dari sudut pandang user yg login
      const isUid1 = chat.uid1 === u.id;
      const partnerId = isUid1 ? chat.uid2 : chat.uid1;
      const partner = isUid1 ? u2 : u1;

      // Owner/coowner: tampilkan kedua pihak
      // Seller biasa: tampilkan buyer
      const nameDisplay = ['owner','coowner'].includes(u.role)
        ? `${u1?.username||'?'} ‚Üî ${u2?.username||'?'}`
        : `${partner?.username||'?'}`;

      function roleTag(user) {
        if (!user) return '';
        const labels = {owner:'üëë Owner', coowner:'üíé Co-Owner', admin:'üõ°Ô∏è Admin', preadmin:'üî∞ Pre-Admin', customer:'üë§ Buyer'};
        const colors = {owner:'#ffd700', coowner:'#c0c0c0', admin:'#6c63ff', preadmin:'#00d4aa', customer:'#ff6584'};
        return `<span style="font-size:9px;padding:1px 5px;border-radius:6px;background:${colors[user.role]}22;color:${colors[user.role]};border:1px solid ${colors[user.role]}44;font-weight:700;">${labels[user.role]||user.role}</span>`;
      }

      const nameWithTags = ['owner','coowner'].includes(u.role)
        ? `<span style="font-weight:700;font-size:13px;">${u1?.username||'?'}</span> ${roleTag(u1)} <span style="color:var(--muted);">‚Üî</span> <span style="font-weight:700;font-size:13px;">${u2?.username||'?'}</span> ${roleTag(u2)}`
        : `<span style="font-weight:700;font-size:13px;">${partner?.username||'?'}</span> ${roleTag(partner)}`;

      return `<div class="card" style="cursor:pointer;margin-bottom:8px;" onclick="openChatRoom(${partnerId}, ${chat.produk_id||'null'})">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">${partner?.avatar||'üë§'}</div>
          <div style="flex:1;min-width:0;">
            <div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;margin-bottom:2px;">${nameWithTags}</div>
            ${produk ? `<div style="font-size:11px;color:var(--accent);margin-bottom:2px;">${produk.emoji} ${produk.nama}</div>` : ''}
            <div style="font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${lastMsg ? lastMsg.text.substring(0,50) : 'Belum ada pesan'}</div>
          </div>
          <div style="font-size:11px;color:var(--muted);flex-shrink:0;">${chat.messages?.length||0} pesan</div>
        </div>
      </div>`;
    }

    el.innerHTML = `
      <div style="margin-top:14px;margin-bottom:10px;font-size:13px;color:var(--muted);">${visibleChats.length} percakapan</div>
      ${visibleChats.length === 0
        ? '<div class="empty"><div class="eicon">üí¨</div><p>Belum ada percakapan</p></div>'
        : visibleChats.sort((a,b)=>(b.last_at||0)-(a.last_at||0)).map(renderChatCard).join('')
      }`;
  }

  if (id === 'laporan' && ['owner','coowner'].includes(u.role)) {
    const pesanan = getPesanan();
    const totalRev = pesanan.reduce((s,o) => s + o.harga, 0);
    const produk = getProduk();
    const users = getUsers();
    el.innerHTML = `
      <div style="margin-top:14px;"></div>
      <div class="stat-grid">
        <div class="stat-card accent"><div class="slbl">üí∞ Total Revenue</div><div class="sval">${formatRp(totalRev)}</div></div>
        <div class="stat-card"><div class="slbl">üì¶ Total Transaksi</div><div class="sval">${pesanan.length}</div></div>
        <div class="stat-card"><div class="slbl">üõçÔ∏è Total Produk</div><div class="sval">${produk.length}</div></div>
        <div class="stat-card"><div class="slbl">üë• Total User</div><div class="sval">${users.length}</div></div>
      </div>
      <div class="card">
        <h3>PRODUK TERLARIS</h3>
        ${produk.sort((a,b)=>b.terjual-a.terjual).slice(0,5).map((p,i) => `
          <div class="list-item">
            <div class="list-icon">${p.emoji}</div>
            <div class="list-info"><div class="list-title">${p.nama}</div><div class="list-sub">Stok: ${p.stok}</div></div>
            <div class="list-right"><div class="list-val">${formatNum(p.terjual)} terjual</div><div style="font-size:11px;color:var(--muted);">${formatRp(p.harga)}</div></div>
          </div>`).join('')}
      </div>
    `;
  }

  if (id === 'akun') {
    el.innerHTML = `
      <div style="margin-top:14px;"></div>
      <div class="card" style="text-align:center;padding:24px;">
        <div style="font-size:50px;margin-bottom:12px;">${u.avatar || 'üë§'}</div>
        <div style="font-family:var(--font-head);font-size:20px;font-weight:700;">${u.username}</div>
        <div style="font-size:13px;color:var(--muted);margin:4px 0 12px;">${u.email}</div>
        <span class="role-badge ${roleBadgeClass(u.role)}" style="font-size:13px;padding:5px 16px;">${roleLabel(u.role)}</span>
        <div style="margin-top:16px;font-size:12px;color:var(--muted);">
          Bergabung: ${new Date(u.joined).toLocaleDateString('id-ID')}
        </div>
      </div>
      <button class="btn-full btn-outline" style="margin-top:0;" onclick="doLogout()">üö™ Keluar</button>
    `;
  }
}

// =================== PRODUK ACTIONS ===================
function previewFotoProduk(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 2 * 1024 * 1024) { showToast('‚ö†Ô∏è Foto maksimal 2MB!'); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result;
    document.getElementById('fp-img-base64').value = base64;
    document.getElementById('fp-img-result').src = base64;
    document.getElementById('fp-img-result').style.display = 'block';
    document.getElementById('fp-img-placeholder').style.display = 'none';
  };
  reader.readAsDataURL(file);
}

function openAddProduk() {
  document.getElementById('fp-id').value = '';
  document.getElementById('fp-nama').value = '';
  document.getElementById('fp-harga').value = '';
  document.getElementById('fp-stok').value = '';
  document.getElementById('fp-emoji').value = '';
  document.getElementById('fp-desc').value = '';
  document.getElementById('fp-panduan').value = '';
  document.getElementById('fp-img-base64').value = '';
  document.getElementById('fp-img-result').style.display = 'none';
  document.getElementById('fp-img-placeholder').style.display = 'block';
  document.getElementById('form-produk-wrap').style.display = 'block';
  document.getElementById('form-produk-wrap').scrollIntoView({behavior:'smooth'});
}

function editProduk(id) {
  const p = getProdukById(id);
  if (!p) return;
  openAddProduk();
  document.getElementById('fp-id').value = p.id;
  document.getElementById('fp-nama').value = p.nama;
  document.getElementById('fp-kat').value = p.kategori;
  document.getElementById('fp-harga').value = p.harga;
  document.getElementById('fp-stok').value = p.stok;
  document.getElementById('fp-emoji').value = p.emoji || '';
  document.getElementById('fp-desc').value = p.deskripsi;
  document.getElementById('fp-panduan').value = p.panduan || '';
  if (p.foto) {
    document.getElementById('fp-img-base64').value = p.foto;
    document.getElementById('fp-img-result').src = p.foto;
    document.getElementById('fp-img-result').style.display = 'block';
    document.getElementById('fp-img-placeholder').style.display = 'none';
  }
}

async function saveProduk() {
  const id = document.getElementById('fp-id').value;
  const nama = document.getElementById('fp-nama').value.trim();
  const harga = parseInt(document.getElementById('fp-harga').value);
  const stok = parseInt(document.getElementById('fp-stok').value);
  const emoji = document.getElementById('fp-emoji').value.trim() || 'üì¶';
  const kategori = document.getElementById('fp-kat').value;
  const deskripsi = document.getElementById('fp-desc').value.trim();
  const panduan = document.getElementById('fp-panduan').value.trim();
  const imgBase64 = document.getElementById('fp-img-base64').value || null;

  if (!nama || !harga || !stok) { showToast('‚ö†Ô∏è Lengkapi data produk!'); return; }

  showLoading(true);
  if (id) {
    const updateData = {nama, harga, stok, emoji, kategori, deskripsi, panduan};
    if (imgBase64) updateData.foto = imgBase64;
    await db.from('dm_produk').update(updateData).eq('id', id);
    showToast('‚úÖ Produk diperbarui!');
  } else {
    const myProduk = getProduk().filter(p => p.seller_id == currentUser.id);
    const limit = canAddProduk(currentUser.role);
    if (myProduk.length >= limit) { showLoading(false); showToast('‚ö†Ô∏è Limit produk tercapai!'); return; }
    await db.from('dm_produk').insert({nama, harga, stok, emoji, kategori, deskripsi, panduan, foto: imgBase64, seller_id: currentUser.id, terjual:0, status:'aktif'});
    showToast('‚úÖ Produk ditambahkan!');
  }
  await fetchProduk();
  showLoading(false);
  document.getElementById('form-produk-wrap').style.display = 'none';
  renderDashSection('produk');
  renderProdukGrid();
}

async function hapusProduk(id) {
  if (!confirm('Hapus produk ini?')) return;
  showLoading(true);
  await db.from('dm_produk').update({status:'nonaktif'}).eq('id', id);
  await fetchProduk();
  showLoading(false);
  showToast('üóëÔ∏è Produk dihapus');
  renderDashSection('produk');
  renderProdukGrid();
}

// =================== USER ACTIONS ===================
const roleOrder = ['customer','preadmin','admin','coowner','owner'];

async function promoteUser(id) {
  const user = getUsers().find(u => u.id === id);
  if (!user) return;
  const curIdx = roleOrder.indexOf(user.role);
  const maxRole = currentUser.role === 'owner' ? 'coowner' : 'admin';
  const maxIdx = roleOrder.indexOf(maxRole);
  if (curIdx < maxIdx) {
    const newRole = roleOrder[curIdx + 1];
    const newAvatar = {owner:'üëë',coowner:'üíé',admin:'üõ°Ô∏è',preadmin:'üî∞',customer:'üë§'}[newRole];
    showLoading(true);
    await db.from('dm_users').update({role: newRole, avatar: newAvatar}).eq('id', id);
    await fetchUsers();
    showLoading(false);
    showToast('‚úÖ Role ' + user.username + ' dinaikkan!');
    renderDashSection('users');
  } else showToast('‚ö†Ô∏è Tidak bisa dinaikkan lebih tinggi');
}

async function demoteUser(id) {
  const user = getUsers().find(u => u.id === id);
  if (!user) return;
  const curIdx = roleOrder.indexOf(user.role);
  if (curIdx > 0) {
    const newRole = roleOrder[curIdx - 1];
    const newAvatar = {owner:'üëë',coowner:'üíé',admin:'üõ°Ô∏è',preadmin:'üî∞',customer:'üë§'}[newRole];
    showLoading(true);
    await db.from('dm_users').update({role: newRole, avatar: newAvatar}).eq('id', id);
    await fetchUsers();
    showLoading(false);
    showToast('‚ö†Ô∏è Role ' + user.username + ' diturunkan');
    renderDashSection('users');
  }
}

async function approveUser(id) {
  showLoading(true);
  await db.from('dm_users').update({status:'active'}).eq('id', id);
  await fetchUsers();
  showLoading(false);
  showToast('‚úÖ Seller disetujui!');
  renderDashSection('approval');
}

async function rejectUser(id) {
  showLoading(true);
  await db.from('dm_users').update({status:'rejected'}).eq('id', id);
  await fetchUsers();
  showLoading(false);
  showToast('‚ùå Seller ditolak');
  renderDashSection('approval');
}

async function deleteUser(id) {
  if (!confirm('Hapus user ini secara permanen?')) return;
  showLoading(true);
  await db.from('dm_users').delete().eq('id', id);
  await fetchUsers();
  showLoading(false);
  showToast('üóëÔ∏è User dihapus');
  renderDashSection('users');
}


// =================== DRAWER ===================
function openDrawer() {
  renderDrawer();
  document.getElementById('drawer').classList.add('open');
  document.getElementById('drawer-overlay').classList.add('active');
}
function closeDrawer() {
  document.getElementById('drawer').classList.remove('open');
  document.getElementById('drawer-overlay').classList.remove('active');
}

function renderDrawer() {
  const u = currentUser;
  if (u) {
    document.getElementById('drawer-avatar').textContent = u.avatar || u.username[0].toUpperCase();
    document.getElementById('drawer-username').textContent = u.username;
    document.getElementById('drawer-role-wrap').innerHTML = `<span class="role-badge ${roleBadgeClass(u.role)}" style="font-size:10px;">${roleLabel(u.role)}</span>`;
    // Title dekoratif
    const titleWrap = document.getElementById('drawer-title-wrap');
    if (u.customTitle) {
      titleWrap.innerHTML = `<span class="drawer-title-badge">${u.customTitle}</span>`;
    } else titleWrap.innerHTML = '';
    // Seller menu
    if (['owner','coowner','admin','preadmin'].includes(u.role)) {
      document.getElementById('drawer-seller-menu').style.display = 'block';
    }
    // Owner/co-owner menu
    if (['owner','coowner'].includes(u.role)) {
      document.getElementById('drawer-owner-menu').style.display = 'block';
      document.getElementById('drawer-owner-divider').style.display = 'block';
    }
    document.getElementById('drawer-auth-icon').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>';
    document.getElementById('drawer-auth-label').textContent = 'Keluar';
  } else {
    document.getElementById('drawer-avatar').textContent = 'üë§';
    document.getElementById('drawer-username').textContent = 'Tamu';
    document.getElementById('drawer-role-wrap').innerHTML = '';
    document.getElementById('drawer-title-wrap').innerHTML = '';
    document.getElementById('drawer-seller-menu').style.display = 'none';
    document.getElementById('drawer-owner-menu').style.display = 'none';
    document.getElementById('drawer-owner-divider').style.display = 'none';
    document.getElementById('drawer-auth-icon').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>';
    document.getElementById('drawer-auth-label').textContent = 'Masuk / Daftar';
  }
}

function drawerAuthAction() {
  closeDrawer();
  if (currentUser) { doLogout(); }
  else { showPage('page-login'); }
}

// =================== DRAWER PAGES ===================
function openDrawerPage(page) {
  closeDrawer();
  const el = document.getElementById('drawer-page-content');
  const u = currentUser;

  if (page === 'profil') {
    if (!u) { showPage('page-login'); return; }
    const myProduk = getProduk().filter(p => p.seller_id == u.id);
    const myPesanan = getPesanan().filter(o => o.buyer_id == u.id);
    const myReviews = getReviews().filter(r => r.user_id == u.id);
    const totalSales = getPesanan().filter(o => o.seller_id == u.id).reduce((s,o) => s+o.harga, 0);
    el.innerHTML = `
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:56px;margin-bottom:10px;">${u.avatar}</div>
        <div style="font-family:var(--font-head);font-size:22px;font-weight:700;">${u.username}</div>
        ${u.customTitle ? `<div class="drawer-title-badge" style="margin:6px auto;display:inline-block;">${u.customTitle}</div>` : ''}
        <div style="margin:8px 0;"><span class="role-badge ${roleBadgeClass(u.role)}">${roleLabel(u.role)}</span></div>
        <div style="font-size:12px;color:var(--muted);">${u.email}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px;">Bergabung: ${new Date(u.joined).toLocaleDateString('id-ID')}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
        <div class="stat-card"><div class="slbl">üì¶ Produk Saya</div><div class="sval">${myProduk.length}</div></div>
        <div class="stat-card"><div class="slbl">üõí Pembelian</div><div class="sval">${myPesanan.length}</div></div>
        <div class="stat-card"><div class="slbl">‚≠ê Ulasan</div><div class="sval">${myReviews.length}</div></div>
        <div class="stat-card accent"><div class="slbl">üí∞ Total Penjualan</div><div class="sval" style="font-size:14px;">${formatRp(totalSales)}</div></div>
      </div>
      <button class="btn-full btn-outline" style="margin-top:0;" onclick="doLogout();closeModal('modal-drawer-page')">üö™ Keluar</button>
    `;
  }

  else if (page === 'support') {
    el.innerHTML = `
      <h3 style="margin-bottom:16px;">üéß Support</h3>
      <div class="card" style="margin-bottom:10px;">
        <div style="font-size:13px;line-height:2;">
          <div>üì± <strong>WhatsApp:</strong> +62 812-3456-7890</div>
          <div>üìß <strong>Email:</strong> support@digimart.com</div>
          <div>üïê <strong>Jam Operasional:</strong> 08.00 ‚Äì 22.00 WIB</div>
          <div>‚ö° <strong>Respon:</strong> &lt; 1 jam</div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom:10px;">FAQ</h3>
        ${[
          ['Bagaimana cara membeli produk?', 'Cari produk, klik detail, lalu klik "Beli Sekarang". Ikuti instruksi pembayaran.'],
          ['Berapa lama proses pengiriman?', 'Produk digital dikirim instan setelah pembayaran dikonfirmasi.'],
          ['Bagaimana jika produk tidak sesuai?', 'Hubungi support kami dalam 24 jam setelah pembelian.'],
          ['Bagaimana cara jadi seller?', 'Daftar akun, pilih "Seller", tunggu approval dari admin.'],
        ].map(([q,a]) => `
          <div style="margin-bottom:12px;">
            <div style="font-weight:600;font-size:13px;margin-bottom:4px;">‚ùì ${q}</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.6;">${a}</div>
          </div>`).join('')}
      </div>
    `;
  }

  else if (page === 'peraturan') {
    el.innerHTML = `
      <h3 style="margin-bottom:16px;">üìã Peraturan DigiMart</h3>
      ${[
        ['Umum', [
          'Dilarang melakukan penipuan dalam bentuk apapun',
          'Dilarang menggunakan akun orang lain tanpa izin',
          'Dilarang menjual produk ilegal atau bajakan',
          'Semua transaksi harus melalui platform DigiMart',
        ]],
        ['Seller', [
          'Deskripsi produk harus sesuai dengan produk yang dijual',
          'Stok harus selalu diperbarui dan akurat',
          'Respon pesan customer maksimal 2 jam',
          'Pelanggaran 3x akan mengakibatkan suspend akun',
        ]],
        ['Buyer', [
          'Konfirmasi pembayaran dalam 24 jam setelah order',
          'Review harus jujur dan tidak menyinggung',
          'Dilarang melakukan chargeback tanpa alasan jelas',
        ]],
      ].map(([title, rules]) => `
        <div class="card" style="margin-bottom:10px;">
          <h3 style="margin-bottom:10px;">${title.toUpperCase()}</h3>
          ${rules.map((r,i) => `<div style="display:flex;gap:8px;font-size:13px;line-height:1.6;margin-bottom:6px;">
            <span style="color:var(--accent);font-weight:700;flex-shrink:0;">${i+1}.</span>
            <span style="color:rgba(240,240,255,0.85);">${r}</span>
          </div>`).join('')}
        </div>`).join('')}
    `;
  }

  else if (page === 'kelola-user') {
    if (!u || !['owner','coowner'].includes(u.role)) { showToast('‚õî Akses ditolak!'); return; }
    const users = getUsers().filter(x => x.id !== u.id && x.status === 'active');
    const roleOptions = (currentRole) => {
      const roles = u.role === 'owner'
        ? ['customer','preadmin','admin','coowner']
        : ['customer','preadmin','admin'];
      return roles.map(r => `<option value="${r}" ${currentRole===r?'selected':''}>${roleLabel(r)}</option>`).join('');
    };
    el.innerHTML = `
      <h3 style="margin-bottom:4px;">üë• Kelola User & Role</h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:16px;">${users.length} pengguna aktif</p>
      ${users.length === 0 ? '<div class="empty"><div class="eicon">üë•</div><p>Belum ada pengguna</p></div>' :
        users.map(usr => `
          <div class="card" style="margin-bottom:8px;">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
              <div class="user-av">${usr.avatar}</div>
              <div style="flex:1;">
                <div style="font-weight:700;font-size:13px;">${usr.username}</div>
                <div style="font-size:11px;color:var(--muted);">${usr.email}</div>
                ${usr.customTitle ? `<span class="drawer-title-badge" style="font-size:10px;">${usr.customTitle}</span>` : ''}
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <select class="form-select" style="flex:1;padding:7px 10px;font-size:12px;"
                onchange="setUserRole(${usr.id}, this.value, true)">
                ${roleOptions(usr.role)}
              </select>
              ${u.role === 'owner' ? `<button class="action-btn btn-delete" onclick="deleteUserDrawer(${usr.id})">üóëÔ∏è</button>` : ''}
            </div>
          </div>`).join('')}
      <div class="card" style="margin-top:12px;background:rgba(255,200,0,0.05);border-color:rgba(255,200,0,0.2);">
        <h3 style="margin-bottom:10px;color:#ffc800;">‚è≥ MENUNGGU APPROVAL</h3>
        ${(() => {
          const pending = getUsers().filter(x => x.status === 'pending');
          return pending.length === 0 ? '<p style="font-size:12px;color:var(--muted);">Tidak ada yang menunggu</p>' :
            pending.map(usr => `
              <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);">
                <div class="user-av" style="width:32px;height:32px;font-size:14px;">${usr.avatar}</div>
                <div style="flex:1;">
                  <div style="font-weight:600;font-size:13px;">${usr.username}</div>
                  <div style="font-size:11px;color:var(--muted);">${usr.email}</div>
                </div>
                <button class="action-btn btn-approve" onclick="approveUserDrawer(${usr.id})">‚úÖ</button>
                <button class="action-btn btn-reject" onclick="rejectUserDrawer(${usr.id})">‚ùå</button>
              </div>`).join('');
        })()}
      </div>
    `;
  }

  else if (page === 'gift-title') {
    if (!u || !['owner','coowner'].includes(u.role)) { showToast('‚õî Akses ditolak!'); return; }
    const presetTitles = ['‚≠ê VIP', 'üî• Hot Seller', 'üíé Diamond', 'üèÜ Top Seller', '‚ú® Premium', 'üéñÔ∏è Verified', 'üëë Legend', 'üöÄ Rising Star', 'üí´ Trusted', 'üéØ Pro Seller'];
    const activeUsers = getUsers().filter(x => ['preadmin','admin','coowner'].includes(x.role) && x.status === 'active');
    el.innerHTML = `
      <h3 style="margin-bottom:4px;">üéÅ Gift Title</h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:16px;">Berikan title dekoratif atau ubah role user</p>
      <div class="form-group">
        <label class="form-label">Pilih User</label>
        <select class="form-select" id="gt-user">
          <option value="">-- Pilih User --</option>
          ${activeUsers.map(usr => `<option value="${usr.id}">${usr.username} (${roleLabel(usr.role)})</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Title Preset</label>
        <div class="title-presets" id="title-presets">
          ${presetTitles.map(t => `<div class="title-preset" onclick="selectTitle(this,'${t}')">${t}</div>`).join('')}
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">atau Tulis Custom Title</label>
        <input class="form-input" id="gt-custom" placeholder="Contoh: üåü Elite Member" oninput="clearPresets()">
      </div>
      <button class="btn-full btn-accent" onclick="giftTitle()" style="margin-bottom:8px;">üéÅ Berikan Title</button>
      <button class="btn-full btn-outline" style="margin-top:0;" onclick="removeTitle()">üóëÔ∏è Hapus Title User Ini</button>
      <div style="height:16px;"></div>
      <div class="card">
        <h3 style="margin-bottom:10px;">USER DENGAN TITLE</h3>
        ${(() => {
          const titled = getUsers().filter(x => x.customTitle);
          return titled.length === 0 ? '<p style="font-size:12px;color:var(--muted);">Belum ada</p>' :
            titled.map(usr => `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);">
              <span style="font-size:16px;">${usr.avatar}</span>
              <span style="font-size:13px;font-weight:600;">${usr.username}</span>
              <span class="drawer-title-badge" style="font-size:10px;">${usr.customTitle}</span>
            </div>`).join('');
        })()}
      </div>
    `;
  }

  else if (page === 'statistik') {
    if (!u || !['owner','coowner'].includes(u.role)) { showToast('‚õî Akses ditolak!'); return; }
    const users = getUsers();
    const pesanan = getPesanan();
    const produk = getProduk();

    // Count by role
    const roleCounts = {preadmin:0, admin:0, coowner:0, owner:0, customer:0};
    users.filter(x => x.status==='active').forEach(x => { if(roleCounts[x.role]!==undefined) roleCounts[x.role]++; });

    // Sales by seller role
    const salesByRole = {preadmin:0, admin:0, coowner:0, owner:0};
    pesanan.forEach(o => {
      const seller = users.find(x => x.id === o.seller_id);
      if (seller && salesByRole[seller.role] !== undefined) salesByRole[seller.role] += o.harga;
    });

    // Orders by buyer role
    const ordersByRole = {preadmin:0, admin:0, coowner:0, owner:0, customer:0};
    pesanan.forEach(o => {
      const buyer = users.find(x => x.id === o.buyer_id);
      if (buyer && ordersByRole[buyer.role] !== undefined) ordersByRole[buyer.role]++;
    });

    const roleColors = {owner:'#ffd700', coowner:'#c0c0c0', admin:'#6c63ff', preadmin:'#00d4aa', customer:'#ff6584'};
    const roleNames = {owner:'Owner', coowner:'Co-Owner', admin:'Admin', preadmin:'Pre-Admin', customer:'Customer'};
    const maxSales = Math.max(...Object.values(salesByRole), 1);
    const maxOrders = Math.max(...Object.values(ordersByRole), 1);
    const totalUsers = Object.values(roleCounts).reduce((s,v)=>s+v,0);

    el.innerHTML = `
      <h3 style="margin-bottom:16px;">üìà Statistik Lengkap</h3>

      <!-- Summary stats -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
        <div class="stat-card accent"><div class="slbl">üë• Total User</div><div class="sval">${users.length}</div></div>
        <div class="stat-card"><div class="slbl">üì¶ Total Transaksi</div><div class="sval">${pesanan.length}</div></div>
        <div class="stat-card"><div class="slbl">üõçÔ∏è Total Produk</div><div class="sval">${produk.length}</div></div>
        <div class="stat-card"><div class="slbl">üí∞ Total Revenue</div><div class="sval" style="font-size:14px;">${formatRp(pesanan.reduce((s,o)=>s+o.harga,0))}</div></div>
      </div>

      <!-- User distribution donut-style -->
      <div class="chart-wrap">
        <div class="chart-title">üë• Distribusi User per Role</div>
        <div class="donut-wrap">
          <svg width="100" height="100" viewBox="0 0 36 36" style="flex-shrink:0;">
            ${(() => {
              let offset = 25;
              return Object.entries(roleCounts).map(([role, count]) => {
                if (!count) return '';
                const pct = (count / (totalUsers||1)) * 100;
                const dash = `${pct} ${100-pct}`;
                const el2 = `<circle cx="18" cy="18" r="15.9" fill="none" stroke="${roleColors[role]}" stroke-width="3.5"
                  stroke-dasharray="${dash}" stroke-dashoffset="${-offset}" style="transition:all 0.5s;"/>`;
                offset -= pct;
                return el2;
              }).join('');
            })()}
            <text x="18" y="20" text-anchor="middle" fill="white" font-size="5" font-weight="bold">${totalUsers}</text>
          </svg>
          <div class="donut-legend">
            ${Object.entries(roleCounts).filter(([,v])=>v>0).map(([role, count]) => `
              <div class="donut-legend-item">
                <div class="donut-dot" style="background:${roleColors[role]};"></div>
                <span class="donut-lbl">${roleNames[role]}</span>
                <span class="donut-val">${count}</span>
              </div>`).join('')}
          </div>
        </div>
      </div>

      <!-- Sales by seller role bar chart -->
      <div class="chart-wrap">
        <div class="chart-title">üí∞ Penjualan per Role Seller</div>
        <div class="bar-chart">
          ${Object.entries(salesByRole).map(([role, val]) => `
            <div class="bar-col">
              <div class="bar-val">${val>0?formatNum(val/1000)+'rb':'-'}</div>
              <div class="bar-fill" style="height:${Math.round((val/maxSales)*90)+4}px;background:${roleColors[role]};"></div>
              <div class="bar-label">${roleNames[role]}</div>
            </div>`).join('')}
        </div>
      </div>

      <!-- Orders by buyer role bar chart -->
      <div class="chart-wrap">
        <div class="chart-title">üõí Pembelian per Role Buyer</div>
        <div class="bar-chart">
          ${Object.entries(ordersByRole).map(([role, val]) => `
            <div class="bar-col">
              <div class="bar-val">${val||'-'}</div>
              <div class="bar-fill" style="height:${Math.round((val/maxOrders)*90)+4}px;background:${roleColors[role]};"></div>
              <div class="bar-label">${roleNames[role]}</div>
            </div>`).join('')}
        </div>
      </div>

      <!-- Top sellers table -->
      <div class="card">
        <h3 style="margin-bottom:10px;">üèÜ TOP SELLER</h3>
        ${(() => {
          const sellerStats = {};
          pesanan.forEach(o => {
            if (!sellerStats[o.seller_id]) sellerStats[o.seller_id] = {total:0, count:0};
            sellerStats[o.seller_id].total += o.harga;
            sellerStats[o.seller_id].count++;
          });
          const sorted = Object.entries(sellerStats).sort((a,b)=>b[1].total-a[1].total).slice(0,5);
          if (!sorted.length) return '<p style="font-size:12px;color:var(--muted);">Belum ada data</p>';
          return sorted.map(([sid, data], i) => {
            const seller = users.find(x => x.id == sid);
            return `<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);">
              <span style="font-size:16px;">${['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£'][i]}</span>
              <span style="font-size:16px;">${seller?.avatar||'üë§'}</span>
              <div style="flex:1;">
                <div style="font-weight:600;font-size:13px;">${seller?.username||'Unknown'}</div>
                <div><span class="role-badge ${roleBadgeClass(seller?.role)}" style="font-size:9px;">${roleLabel(seller?.role)}</span></div>
              </div>
              <div style="text-align:right;">
                <div style="font-weight:700;font-size:13px;color:var(--accent);">${formatRp(data.total)}</div>
                <div style="font-size:10px;color:var(--muted);">${data.count} transaksi</div>
              </div>
            </div>`;
          }).join('');
        })()}
      </div>
    `;
  }

  openModal('modal-drawer-page');
}

// =================== GIFT TITLE ACTIONS ===================
let selectedPresetTitle = '';
function selectTitle(el2, title) {
  document.querySelectorAll('.title-preset').forEach(x => x.classList.remove('selected'));
  el2.classList.add('selected');
  selectedPresetTitle = title;
  document.getElementById('gt-custom').value = '';
}
function clearPresets() {
  document.querySelectorAll('.title-preset').forEach(x => x.classList.remove('selected'));
  selectedPresetTitle = '';
}
async function giftTitle() {
  const userId = parseInt(document.getElementById('gt-user').value);
  const customInput = document.getElementById('gt-custom').value.trim();
  const title = customInput || selectedPresetTitle;
  if (!userId) { showToast('‚ö†Ô∏è Pilih user dulu!'); return; }
  if (!title) { showToast('‚ö†Ô∏è Pilih atau tulis title dulu!'); return; }
  showLoading(true);
  await db.from('dm_users').update({custom_title: title}).eq('id', userId);
  await fetchUsers();
  showLoading(false);
  showToast('üéÅ Title berhasil diberikan!');
  openDrawerPage('gift-title');
}
async function removeTitle() {
  const userId = parseInt(document.getElementById('gt-user').value);
  if (!userId) { showToast('‚ö†Ô∏è Pilih user dulu!'); return; }
  showLoading(true);
  await db.from('dm_users').update({custom_title: null}).eq('id', userId);
  await fetchUsers();
  showLoading(false);
  showToast('üóëÔ∏è Title dihapus!');
  openDrawerPage('gift-title');
}

// =================== USER ROLE / APPROVAL ===================
async function setUserRole(id, role, fromDrawer=false) {
  const newAvatar = {owner:'üëë',coowner:'üíé',admin:'üõ°Ô∏è',preadmin:'üî∞',customer:'üë§'}[role];
  showLoading(true);
  await db.from('dm_users').update({role, avatar: newAvatar}).eq('id', id);
  await fetchUsers();
  showLoading(false);
  if (fromDrawer) { showToast('‚úÖ Role berhasil diubah!'); openDrawerPage('kelola-user'); }
  else { showToast('‚úÖ Role diubah!'); renderDashSection('users'); }
}
async function deleteUserDrawer(id) {
  if (!confirm('Hapus user ini secara permanen?')) return;
  showLoading(true);
  await db.from('dm_users').delete().eq('id', id);
  await fetchUsers();
  showLoading(false);
  showToast('üóëÔ∏è User dihapus');
  openDrawerPage('kelola-user');
}
async function approveUserDrawer(id) {
  showLoading(true);
  await db.from('dm_users').update({status:'active'}).eq('id', id);
  await fetchUsers();
  showLoading(false);
  showToast('‚úÖ Seller disetujui!');
  openDrawerPage('kelola-user');
}
async function rejectUserDrawer(id) {
  showLoading(true);
  await db.from('dm_users').update({status:'rejected'}).eq('id', id);
  await fetchUsers();
  showLoading(false);
  showToast('‚ùå Seller ditolak');
  openDrawerPage('kelola-user');
}

// =================== INIT ===================
// =================== CHAT SYSTEM ===================
let currentChatPartnerId = null;
let currentChatProdukId = null;
let currentChatId = null;

function getChatKey(uid1, uid2) { return [Math.min(uid1,uid2), Math.max(uid1,uid2)].join('_'); }

function openChatPage() {
  if (!currentUser) { showPage('page-login'); return; }
  renderChatList();
  showPage('page-chat');
}

function renderChatList() {
  const chats = getChats();
  // Owner & coowner lihat semua chat, admin/preadmin lihat chat mereka sendiri
  const myChats = ['owner','coowner'].includes(currentUser.role)
    ? chats
    : chats.filter(c => c.uid1 == currentUser.id || c.uid2 == currentUser.id);
  const el = document.getElementById('chat-list-content');
  document.getElementById('chat-list-count').textContent = myChats.length + ' percakapan';

  if (myChats.length === 0) {
    el.innerHTML = '<div class="empty"><div class="eicon">üí¨</div><p>Belum ada percakapan.<br>Mulai chat dari halaman produk.</p></div>';
    return;
  }

  el.innerHTML = myChats.sort((a,b) => (b.lastAt||0) - (a.lastAt||0)).map(chat => {
    const partnerId = chat.uid1 == currentUser.id ? chat.uid2 : chat.uid1;
    const partner = getUser(partnerId);
    const lastMsg = chat.messages && chat.messages.length ? chat.messages[chat.messages.length-1] : null;
    const unread = chat.messages ? chat.messages.filter(m => m.from !== currentUser.id && !m.read).length : 0;
    const produk = chat.produk_id ? getProdukById(chat.produk_id) : null;
    return `
      <div class="chat-list-item" onclick="openChatRoom(${partnerId}, ${chat.produk_id || 'null'})">
        <div class="chat-av">
          ${partner?.avatar || partner?.username[0].toUpperCase() || '?'}
          ${unread > 0 ? '<div class="chat-unread-dot"></div>' : ''}
        </div>
        <div class="chat-list-info">
          <div class="chat-list-name">${partner?.username || 'Unknown'} <span class="role-badge ${roleBadgeClass(partner?.role)}" style="font-size:9px;">${roleLabel(partner?.role)}</span></div>
          ${produk ? `<div style="font-size:10px;color:var(--accent);margin-bottom:2px;">re: ${produk.emoji} ${produk.nama}</div>` : ''}
          <div class="chat-list-preview">${lastMsg ? (lastMsg.from === currentUser.id ? 'Kamu: ' : '') + lastMsg.text : 'Belum ada pesan'}</div>
        </div>
        <div class="chat-list-time">${lastMsg ? formatChatTime(lastMsg.at) : ''}</div>
      </div>`;
  }).join('');
}

function formatChatTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  const now = new Date();
  if (d.toDateString() === now.toDateString()) return d.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
  return d.toLocaleDateString('id-ID',{day:'numeric',month:'short'});
}

async function openChatRoom(partnerId, produkId) {
  if (!currentUser) { showPage('page-login'); return; }
  currentChatPartnerId = partnerId;
  currentChatProdukId = produkId || null;

  const partner = getUser(partnerId);
  document.getElementById('chatroom-av').textContent = partner?.avatar || (partner?.username || '?')[0].toUpperCase();
  document.getElementById('chatroom-name').textContent = partner?.username || 'Unknown';

  const produk = produkId ? getProdukById(produkId) : null;
  document.getElementById('chatroom-product-badge').textContent = produk ? `${produk.emoji} ${produk.nama}` : '';

  // Get or create chat in Supabase
  const uid1 = Math.min(currentUser.id, partnerId);
  const uid2 = Math.max(currentUser.id, partnerId);
  let { data: chat } = await db.from('dm_chats').select('*')
    .eq('uid1', uid1).eq('uid2', uid2).maybeSingle();

  if (!chat) {
    const { data: newChat } = await db.from('dm_chats').insert({
      uid1, uid2, produk_id: produkId || null, messages: [], last_at: Date.now()
    }).select().single();
    chat = newChat;
  } else {
    // Mark messages as read
    const msgs = (chat.messages || []).map(m => ({...m, read: true}));
    await db.from('dm_chats').update({messages: msgs}).eq('id', chat.id);
    chat.messages = msgs;
  }
  currentChatId = chat?.id || null;
  await fetchChats();

  renderChatMessages();
  document.querySelector('.chat-input-bar').style.display = 'flex';
  document.getElementById('chat-msg-input').value = '';
  showPage('page-chatroom');
  setTimeout(() => {
    const body = document.getElementById('chat-messages');
    if (body) body.scrollTop = body.scrollHeight;
  }, 100);
}

function renderChatMessages() {
  const chats = getChats();
  const chat = currentChatId ? chats.find(c => c.id === currentChatId) : chats.find(c => {
    const uid1 = Math.min(currentUser.id, currentChatPartnerId);
    const uid2 = Math.max(currentUser.id, currentChatPartnerId);
    return c.uid1 === uid1 && c.uid2 === uid2;
  });
  const messages = chat?.messages || [];

  const produk = currentChatProdukId ? getProdukById(currentChatProdukId) : null;
  let html = '';

  if (produk) {
    html += `<div class="chat-product-ref" onclick="showDetail(${produk.id})">
      <div style="font-size:28px;">${produk.emoji}</div>
      <div>
        <div style="font-weight:600;font-size:13px;">${produk.nama}</div>
        <div style="font-size:12px;color:var(--accent);font-weight:700;">${formatRp(produk.harga)}</div>
      </div>
      <span style="margin-left:auto;font-size:11px;color:var(--muted);">‚Üí</span>
    </div>`;
  }

  if (messages.length === 0) {
    html += '<div style="text-align:center;padding:30px 20px;"><div style="font-size:40px;margin-bottom:10px;">üëã</div><div style="font-size:13px;color:var(--muted);">Mulai percakapan!</div></div>';
  } else {
    let lastDate = '';
    messages.forEach(m => {
      const d = new Date(m.at);
      const dateStr = d.toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long'});
      if (dateStr !== lastDate) {
        html += `<div class="chat-date-divider">${dateStr}</div>`;
        lastDate = dateStr;
      }
      const isMine = m.from === currentUser.id;
      const sender = getUser(m.from);
      const roleLabels = {owner:'üëë Owner', coowner:'üíé Co-Owner', admin:'üõ°Ô∏è Admin', preadmin:'üî∞ Pre-Admin', customer:'üë§ Buyer'};
      const roleColors = {owner:'#ffd700', coowner:'#c0c0c0', admin:'#6c63ff', preadmin:'#00d4aa', customer:'#ff6584'};
      const senderRole = sender?.role || 'customer';
      const roleTag = `<span style="font-size:9px;padding:1px 5px;border-radius:6px;background:${roleColors[senderRole]}22;color:${roleColors[senderRole]};border:1px solid ${roleColors[senderRole]}44;font-weight:700;">${roleLabels[senderRole]||senderRole}</span>`;
      html += `<div style="display:flex;flex-direction:column;align-items:${isMine?'flex-end':'flex-start'};">
        <div class="chat-bubble ${isMine?'sent':'recv'}">
          <div style="font-size:10px;opacity:0.85;margin-bottom:3px;display:flex;align-items:center;gap:4px;">${sender?.username||'?'} ${roleTag}</div>
          ${m.text}
          <div class="cb-time">${d.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'})} ${isMine ? (m.read?'‚úì‚úì':'‚úì') : ''}</div>
        </div>
      </div>`;
    });
  }



  document.getElementById('chat-messages').innerHTML = html;
  document.querySelector('.chat-input-bar').style.display = 'flex';
}

async function sendChatMsg() {
  const input = document.getElementById('chat-msg-input');
  const text = input.value.trim();
  if (!text || !currentChatId) return;

  const chats = getChats();
  const chat = chats.find(c => c.id === currentChatId);
  const messages = [...(chat?.messages || []), {
    id: Date.now(), from: currentUser.id, text, at: Date.now(), read: false
  }];

  input.value = '';
  await db.from('dm_chats').update({messages, last_at: Date.now()}).eq('id', currentChatId);
  await fetchChats();
  renderChatMessages();
  setTimeout(() => {
    const body = document.getElementById('chat-messages');
    if (body) body.scrollTop = body.scrollHeight;
  }, 50);
}

// Dashboard chat section for owner to monitor all chats
function renderDashChat() {
  const chats = getChats();
  if (chats.length === 0) return '<div class="empty"><div class="eicon">üí¨</div><p>Belum ada chat</p></div>';
  return chats.sort((a,b)=>(b.last_at||0)-(a.last_at||0)).map(chat => {
    const u1 = getUser(chat.uid1), u2 = getUser(chat.uid2);
    const lastMsg = chat.messages && chat.messages.length ? chat.messages[chat.messages.length-1] : null;
    const produk = chat.produk_id ? getProdukById(chat.produk_id) : null;
    return `<div class="card" style="cursor:pointer;margin-bottom:8px;" onclick="monitorChat(${chat.uid1},${chat.uid2},${chat.produk_id||'null'})">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-size:24px;">üí¨</div>
        <div style="flex:1;">
          <div style="font-weight:600;font-size:13px;">${u1?.username||'?'} ‚Üî ${u2?.username||'?'}</div>
          ${produk ? `<div style="font-size:11px;color:var(--accent);">${produk.emoji} ${produk.nama}</div>` : ''}
          <div style="font-size:12px;color:var(--muted);">${lastMsg ? lastMsg.text.substring(0,50) : 'Kosong'}</div>
        </div>
        <div style="font-size:11px;color:var(--muted);">${chat.messages?.length||0} pesan</div>
      </div>
    </div>`;
  }).join('');
}

// monitor chat removed


// =================== PROFILE & ORDER PAGE ===================
function openProfileOrder() {
  if (!currentUser) { showPage('page-login'); return; }
  setBottomNavActive('profile');
  const u = currentUser;
  const myOrders = getPesanan().filter(o => o.buyer_id == u.id);
  const myProduk = getProduk().filter(p => p.seller_id == u.id);
  const totalSales = getPesanan().filter(o => o.seller_id == u.id).reduce((s,o)=>s+o.harga,0);

  const isSeller = ['owner','coowner','admin','preadmin'].includes(u.role);
  const orderTabs = [
    {key:'menunggu-bayar', label:'Menunggu Bayar'},
    {key:'menunggu-kirim', label:'Menunggu Kirim'},
    {key:'dikirim', label:'Dikirim'},
    {key:'selesai', label:'Selesai'},
    {key:'dibatalkan', label:'Dibatalkan'},
  ];

  const el = document.getElementById('drawer-page-content');
  el.innerHTML = `
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;">
      <div style="font-size:44px;">${u.avatar || 'üë§'}</div>
      <div>
        <div style="font-family:var(--font-head);font-size:18px;font-weight:700;">${u.username}</div>
        ${u.customTitle ? `<div class="drawer-title-badge" style="display:inline-block;margin:4px 0;">${u.customTitle}</div>` : ''}
        <div><span class="role-badge ${roleBadgeClass(u.role)}">${roleLabel(u.role)}</span></div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;">
      <div class="stat-card"><div class="slbl">üì¶ Produk Saya</div><div class="sval">${myProduk.length}</div></div>
      <div class="stat-card accent"><div class="slbl">üí∞ Total Jual</div><div class="sval" style="font-size:13px;">${formatRp(totalSales)}</div></div>
    </div>
    <div style="font-family:var(--font-head);font-size:15px;font-weight:700;margin-bottom:12px;">üìã Pesanan Saya</div>
    <div class="order-tabs" id="profile-order-tabs">
      ${orderTabs.map((t,i) => {
        const allOrders = getPesanan();
        const isSell = ['owner','coowner','admin','preadmin'].includes(u.role);
        const isOwn = ['owner','coowner'].includes(u.role);
        const cnt = isOwn 
          ? allOrders.filter(o=>o.status===t.key).length
          : isSell
            ? allOrders.filter(o=>o.seller_id===u.id && o.status===t.key).length
            : allOrders.filter(o=>o.buyer_id===u.id && o.status===t.key).length;
        return `<div class="order-tab ${i===0?'active':''}" onclick="switchOrderTab('${t.key}',this)">${t.label}${cnt>0?` <span style="background:var(--accent2);color:#fff;padding:1px 6px;border-radius:10px;font-size:10px;">${cnt}</span>`:''}</div>`;
      }).join('')}
    </div>
    <div id="profile-order-content"></div>
    <button class="btn-full btn-outline" style="margin-top:16px;" onclick="doLogout();closeModal('modal-drawer-page')">üö™ Keluar</button>
  `;
  renderOrderTab('menunggu-bayar');
  openModal('modal-drawer-page');
}

function switchOrderTab(status, btn) {
  document.querySelectorAll('.order-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderOrderTab(status);
}

function renderOrderTab(status) {
  const u = currentUser;
  const isSeller = ['owner','coowner','admin','preadmin'].includes(u.role);
  const isOwner = ['owner','coowner'].includes(u.role);

  // Buyer lihat pesanan sendiri, seller lihat pesanan ke dia, owner lihat semua
  let orders;
  if (isOwner) {
    orders = getPesanan().filter(o => o.status === status);
  } else if (isSeller) {
    orders = getPesanan().filter(o => o.seller_id == u.id && o.status === status);
  } else {
    orders = getPesanan().filter(o => o.buyer_id == u.id && o.status === status);
  }

  const el = document.getElementById('profile-order-content');
  if (!el) return;

  const statusLabel = {
    'menunggu-bayar':'‚è≥ Menunggu Pembayaran',
    'menunggu-kirim':'üì¶ Menunggu Dikirim',
    'dikirim':'üöö Sedang Dikirim',
    'selesai':'‚úÖ Selesai',
    'dibatalkan':'‚ùå Dibatalkan'
  };

  if (orders.length === 0) {
    el.innerHTML = '<div class="empty" style="padding:30px 0;"><div class="eicon">üì≠</div><p>Tidak ada pesanan</p></div>';
    return;
  }

  el.innerHTML = orders.map(o => {
    const p = getProdukById(o.produk_id);
    const buyer = getUser(o.buyer_id);
    const seller = getUser(o.seller_id);
    const reviews = getReviews();
    const alreadyReviewed = reviews.some(r => r.produk_id === o.produk_id && r.user_id === o.buyer_id && r.order_id === o.id);
    const isMine = o.buyer_id == u.id;

    return `
    <div class="card" style="margin-bottom:10px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <div style="font-size:32px;">${p?.emoji || 'üì¶'}</div>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p?.nama || 'Produk dihapus'}</div>
          ${isSeller || isOwner ? `<div style="font-size:11px;color:var(--muted);">Pembeli: ${buyer?.username||'?'}</div>` : `<div style="font-size:11px;color:var(--muted);">Seller: ${seller?.username||'?'}</div>`}
          <div style="font-size:11px;color:var(--muted);">${new Date(o.created_at).toLocaleDateString('id-ID')} ¬∑ ${o.qty||1}x</div>
          <div style="font-size:13px;font-weight:700;color:var(--accent);">${formatRp(o.harga)}</div>
        </div>
        <span class="order-status-badge status-${o.status}" style="flex-shrink:0;">${statusLabel[o.status]||o.status}</span>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:10px;">Kode: <strong style="color:var(--text);letter-spacing:1px;">${o.kode}</strong></div>

      ${/* BUYER: di menunggu-bayar bisa bayar atau batal */''}
      ${isMine && status === 'menunggu-bayar' ? `
        <div style="display:flex;gap:8px;">
          <button class="btn-full btn-accent" style="margin-top:0;padding:10px;font-size:13px;" onclick="buyerKonfirmasiBayar(${o.id})">üí≥ Bayar Sekarang</button>
          <button class="btn-full btn-outline" style="margin-top:0;padding:10px;font-size:13px;" onclick="updateOrderStatus(${o.id},'dibatalkan')">‚ùå Batal</button>
        </div>` : ''}

      ${/* SELLER/ADMIN/OWNER: di menunggu-kirim bisa tandai kirim */''}
      ${(isSeller || isOwner) && status === 'menunggu-kirim' ? `
        <button style="width:100%;padding:10px;border-radius:10px;background:rgba(0,212,170,0.15);border:1px solid rgba(0,212,170,0.3);color:var(--green);font-size:13px;font-weight:600;cursor:pointer;" onclick="updateOrderStatus(${o.id},'dikirim')">üöö Tandai Sudah Dikirim</button>` : ''}

      ${/* SELLER/ADMIN/OWNER: di dikirim bisa tandai selesai */''}
      ${(isSeller || isOwner) && status === 'dikirim' ? `
        <button style="width:100%;padding:10px;border-radius:10px;background:rgba(108,99,255,0.15);border:1px solid rgba(108,99,255,0.3);color:var(--accent);font-size:13px;font-weight:600;cursor:pointer;" onclick="updateOrderStatus(${o.id},'selesai')">‚úÖ Tandai Selesai</button>` : ''}

      ${/* BUYER: di dikirim bisa konfirmasi terima */''}
      ${isMine && status === 'dikirim' ? `
        <button class="btn-full btn-accent" style="margin-top:0;padding:10px;font-size:13px;" onclick="updateOrderStatus(${o.id},'selesai')">‚úÖ Pesanan Diterima</button>` : ''}

      ${/* BUYER: di selesai bisa rating */''}
      ${isMine && status === 'selesai' && !alreadyReviewed && p ? `
        <button style="width:100%;padding:10px;border-radius:10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);color:var(--gold);font-size:13px;font-weight:600;cursor:pointer;" onclick="closeModal('modal-drawer-page');openReviewModalFromOrder(${p.id},${o.id})">‚≠ê Beri Rating & Ulasan</button>` : ''}
      ${isMine && status === 'selesai' && alreadyReviewed ? `
        <div style="text-align:center;font-size:12px;color:var(--green);padding:6px;">‚úÖ Sudah memberikan ulasan</div>` : ''}
    </div>`;
  }).join('');
}

async function buyerKonfirmasiBayar(orderId) {
  showLoading(true);
  await db.from('dm_pesanan').update({status:'menunggu-kirim', paid_at: Date.now()}).eq('id', orderId);
  await fetchPesanan();
  showLoading(false);
  showToast('‚úÖ Pembayaran dikonfirmasi! Menunggu seller mengirim.');
  openProfileOrder();
}

async function updateOrderStatus(orderId, newStatus) {
  showLoading(true);
  await db.from('dm_pesanan').update({status: newStatus}).eq('id', orderId);
  await fetchPesanan();
  showLoading(false);
  const statusMsg = {
    'menunggu-kirim':'‚úÖ Pembayaran dikonfirmasi!',
    'dikirim':'üì¶ Pesanan ditandai dikirim!',
    'selesai':'üéâ Pesanan selesai!',
    'dibatalkan':'‚ùå Pesanan dibatalkan'
  };
  showToast(statusMsg[newStatus] || 'Status diperbarui');
  openProfileOrder();
}

function openReviewModalFromOrder(produkId, orderId) {
  currentProdukId = produkId;
  currentOrderId = orderId;
  currentRating = 0;
  document.getElementById('review-text').value = '';
  setRating(0);
  openModal('modal-review');
}


function handleDrawerOverlayClick(e) {
  if (e.target === e.currentTarget) closeModal('modal-drawer-page');
}

// =================== CHECKOUT ===================
let selectedPayment = 'transfer';
let checkoutQty = 1;

function openCheckout() {
  checkoutQty = 1;
  selectedPayment = 'transfer';
  renderCheckoutStep1();
  goCheckoutStep(1);
  showPage('page-checkout');
}

function checkoutChangeQty(delta) {
  const p = getProdukById(currentProdukId);
  if (!p) return;
  checkoutQty = Math.max(1, Math.min(checkoutQty + delta, p.stok));
  document.getElementById('co-qty').textContent = checkoutQty;
  renderCheckoutInvoice();
}

function renderCheckoutStep1() {
  const p = getProdukById(currentProdukId);
  const seller = getUser(p.seller_id);
  document.getElementById('checkout-summary').innerHTML = `
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px;display:flex;align-items:center;gap:12px;">
      <div style="font-size:40px;">${p.emoji}</div>
      <div style="flex:1;">
        <div style="font-weight:700;font-size:15px;">${p.nama}</div>
        <div style="font-size:12px;color:var(--muted);">Seller: ${seller?.username || 'Unknown'}</div>
        <div style="font-size:12px;color:var(--muted);">Stok: ${p.stok}</div>
      </div>
      <div style="font-family:var(--font-head);font-weight:700;color:var(--accent);">${formatRp(p.harga)}</div>
    </div>`;
  document.getElementById('co-qty').textContent = checkoutQty;
  renderCheckoutInvoice();
}

function renderCheckoutInvoice() {
  const p = getProdukById(currentProdukId);
  if (!p) return;
  const subtotal = p.harga * checkoutQty;
  const biayaLayanan = Math.round(subtotal * 0.02);
  const total = subtotal + biayaLayanan;
  document.getElementById('checkout-invoice').innerHTML = `
    <div class="invoice-row"><span>Harga satuan</span><span>${formatRp(p.harga)}</span></div>
    <div class="invoice-row"><span>Jumlah</span><span>√ó ${checkoutQty}</span></div>
    <div class="invoice-row"><span>Subtotal</span><span>${formatRp(subtotal)}</span></div>
    <div class="invoice-row"><span style="color:var(--muted);">Biaya layanan (2%)</span><span style="color:var(--muted);">${formatRp(biayaLayanan)}</span></div>
    <div class="invoice-row total"><span>Total Pembayaran</span><span style="color:var(--accent);">${formatRp(total)}</span></div>`;
  return {subtotal, biayaLayanan, total};
}

function goCheckoutStep(step) {
  [1,2,3].forEach(s => {
    const el = document.getElementById('checkout-step-' + s);
    if (el) el.classList.toggle('active', s === step);
    const dot = document.getElementById('step-dot-' + s);
    if (dot) {
      dot.classList.remove('active','done');
      if (s < step) dot.classList.add('done');
      else if (s === step) dot.classList.add('active');
    }
    if (s < 3) {
      const line = document.getElementById('step-line-' + s);
      if (line) line.classList.toggle('done', s < step);
    }
  });

  if (step === 2) renderPaymentDetail();
  if (step === 3) renderCheckoutConfirm();
}

function selectPayment(method) {
  selectedPayment = method;
  ['transfer','qris','voucher'].forEach(m => {
    const el = document.getElementById('pm-' + m);
    if (el) {
      el.classList.toggle('selected', m === method);
      el.querySelector('.pm-check').textContent = m === method ? '‚úì' : '';
    }
  });
  renderPaymentDetail();
}

function renderPaymentDetail() {
  const p = getProdukById(currentProdukId);
  const subtotal = p.harga * checkoutQty;
  const total = subtotal + Math.round(subtotal * 0.02);
  const el = document.getElementById('payment-detail-wrap');
  if (selectedPayment === 'transfer') {
    el.innerHTML = `
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;">
        <div style="font-weight:700;font-size:14px;margin-bottom:12px;">üè¶ Info Transfer Bank</div>
        <div style="font-size:13px;line-height:2.2;color:rgba(240,240,255,0.85);">
          <div>Bank: <strong>BCA</strong></div>
          <div>No. Rek: <strong>1234567890</strong></div>
          <div>Atas Nama: <strong>DigiMart Indonesia</strong></div>
          <div>Jumlah Transfer: <strong style="color:var(--accent);">${formatRp(total)}</strong></div>
        </div>
        <div style="margin-top:10px;padding:10px;background:rgba(255,200,0,0.1);border-radius:8px;font-size:12px;color:#ffc800;">
          ‚ö†Ô∏è Transfer tepat sesuai nominal, lalu upload bukti di bawah
        </div>
        <div style="margin-top:14px;">
          <div style="font-weight:700;font-size:13px;margin-bottom:8px;">üìé Upload Bukti Transfer</div>
          <div id="bukti-preview" style="width:100%;height:120px;border:2px dashed var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--surface);overflow:hidden;" onclick="document.getElementById('bukti-input').click()">
            <div id="bukti-placeholder" style="text-align:center;color:var(--muted);font-size:12px;">
              <div style="font-size:28px;margin-bottom:4px;">üì∑</div>
              Tap untuk upload foto bukti
            </div>
            <img id="bukti-img" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:8px;">
          </div>
          <input type="file" id="bukti-input" accept="image/*" style="display:none;" onchange="previewBukti(this)">
          <input type="hidden" id="bukti-base64">
        </div>
      </div>`;
  } else if (selectedPayment === 'qris') {
    el.innerHTML = `
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;">
        <div style="font-weight:700;font-size:14px;margin-bottom:12px;">üì± Scan QRIS</div>
        <div style="background:white;border-radius:12px;padding:20px;margin:0 auto;width:160px;height:160px;display:flex;align-items:center;justify-content:center;">
          <div style="font-size:60px;">üì≤</div>
        </div>
        <div style="margin-top:12px;font-size:13px;color:var(--muted);">Scan dengan GoPay, OVO, Dana, atau ShopeePay</div>
        <div style="margin-top:6px;font-family:var(--font-head);font-size:18px;font-weight:700;color:var(--accent);">${formatRp(total)}</div>
        <div style="margin-top:14px;text-align:left;">
          <div style="font-weight:700;font-size:13px;margin-bottom:8px;">üìé Upload Bukti Pembayaran</div>
          <div id="bukti-preview" style="width:100%;height:120px;border:2px dashed var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--surface);overflow:hidden;" onclick="document.getElementById('bukti-input').click()">
            <div id="bukti-placeholder" style="text-align:center;color:var(--muted);font-size:12px;">
              <div style="font-size:28px;margin-bottom:4px;">üì∑</div>
              Tap untuk upload foto bukti
            </div>
            <img id="bukti-img" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:8px;">
          </div>
          <input type="file" id="bukti-input" accept="image/*" style="display:none;" onchange="previewBukti(this)">
          <input type="hidden" id="bukti-base64">
        </div>
      </div>`;
  } else if (selectedPayment === 'voucher') {
    el.innerHTML = `
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;">
        <div style="font-weight:700;font-size:14px;margin-bottom:10px;">üé´ Masukkan Kode Voucher</div>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <input class="form-input" id="voucher-input" placeholder="Contoh: DIGI-XXXX-XXXX" style="flex:1;text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()">
          <button onclick="validasiVoucher()" style="background:var(--accent);border:none;color:#fff;padding:0 14px;border-radius:10px;font-weight:700;cursor:pointer;white-space:nowrap;">Cek</button>
        </div>
        <div id="voucher-status" style="font-size:12px;min-height:18px;"></div>
        <div style="font-size:11px;color:var(--muted);margin-top:6px;">Voucher akan otomatis divalidasi ke database</div>
      </div>`;
  }
}

function previewBukti(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 3 * 1024 * 1024) { showToast('‚ö†Ô∏è Foto maksimal 3MB!'); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('bukti-base64').value = e.target.result;
    document.getElementById('bukti-img').src = e.target.result;
    document.getElementById('bukti-img').style.display = 'block';
    document.getElementById('bukti-placeholder').style.display = 'none';
  };
  reader.readAsDataURL(file);
}

async function validasiVoucher() {
  const kode = document.getElementById('voucher-input').value.trim().toUpperCase();
  const statusEl = document.getElementById('voucher-status');
  if (!kode) { statusEl.innerHTML = '<span style="color:#ff6584;">‚ö†Ô∏è Masukkan kode voucher dulu</span>'; return; }
  statusEl.innerHTML = '<span style="color:var(--muted);">‚è≥ Mengecek...</span>';
  const { data, error } = await db.from('dm_vouchers').select('*').eq('kode', kode).eq('status', 'aktif').single();
  if (error || !data) {
    statusEl.innerHTML = '<span style="color:#ff6584;">‚ùå Voucher tidak valid atau sudah digunakan</span>';
    return;
  }
  const p = getProdukById(currentProdukId);
  const total = p.harga * checkoutQty + Math.round(p.harga * checkoutQty * 0.02);
  if (data.min_belanja && total < data.min_belanja) {
    statusEl.innerHTML = `<span style="color:#ff6584;">‚ùå Minimum belanja ${formatRp(data.min_belanja)}</span>`;
    return;
  }
  const diskon = data.tipe === 'persen' ? Math.round(total * data.nilai / 100) : data.nilai;
  statusEl.innerHTML = `<span style="color:#00d4aa;">‚úÖ Voucher valid! Diskon ${formatRp(diskon)}</span>`;
  window._voucherValid = {kode, diskon, id: data.id};
}

function renderCheckoutConfirm() {
  const p = getProdukById(currentProdukId);
  const seller = getUser(p.seller_id);
  const subtotal = p.harga * checkoutQty;
  const biayaLayanan = Math.round(subtotal * 0.02);
  const total = subtotal + biayaLayanan;
  const kode = genKode();
  const paymentLabels = {transfer:'Transfer Bank', qris:'QRIS', cod:'Voucher'};

  document.getElementById('checkout-step3-content').innerHTML = `
    <div class="order-success-wrap">
      <div class="order-success-icon">‚úÖ</div>
      <div style="font-family:var(--font-head);font-size:22px;font-weight:800;margin-bottom:6px;">Pesanan Dikonfirmasi!</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:16px;">Terima kasih sudah berbelanja di DigiMart</div>
      <div class="order-code">${kode}</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:20px;">Kode Transaksi ‚Äî Simpan untuk referensi</div>
      
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:left;margin-bottom:20px;">
        <div style="font-weight:700;margin-bottom:12px;">üßæ Detail Pesanan</div>
        <div class="invoice-row"><span>Produk</span><span>${p.emoji} ${p.nama}</span></div>
        <div class="invoice-row"><span>Seller</span><span>${seller?.username}</span></div>
        <div class="invoice-row"><span>Jumlah</span><span>${checkoutQty}x</span></div>
        <div class="invoice-row"><span>Metode Bayar</span><span>${paymentLabels[selectedPayment]}</span></div>
        <div class="invoice-row"><span>Subtotal</span><span>${formatRp(subtotal)}</span></div>
        <div class="invoice-row"><span style="color:var(--muted);">Biaya Layanan</span><span style="color:var(--muted);">${formatRp(biayaLayanan)}</span></div>
        <div class="invoice-row total"><span>Total</span><span style="color:var(--accent);">${formatRp(total)}</span></div>
      </div>

      <button class="btn-full btn-accent" style="margin-top:0;margin-bottom:10px;" onclick="finalizeOrder('${kode}',${total})">‚úÖ Selesaikan Pembayaran</button>
      <button class="btn-full btn-outline" style="margin-top:0;" onclick="showPage('page-home')">üè† Kembali ke Beranda</button>
    </div>`;
}

async function finalizeOrder(kode, total) {
  const p = getProdukById(currentProdukId);
  if (!p) return;
  const qty = checkoutQty;
  if (qty > p.stok) { showToast('‚ùå Stok tidak mencukupi!'); return; }

  // Validasi bukti transfer
  const buktiEl = document.getElementById('bukti-base64');
  const bukti = buktiEl ? buktiEl.value : null;
  if ((selectedPayment === 'transfer' || selectedPayment === 'qris') && !bukti) {
    showToast('‚ö†Ô∏è Upload bukti pembayaran dulu!'); return;
  }
  // Validasi voucher
  if (selectedPayment === 'voucher' && !window._voucherValid) {
    showToast('‚ö†Ô∏è Validasi voucher dulu!'); return;
  }

  let finalTotal = total;
  if (selectedPayment === 'voucher' && window._voucherValid) {
    finalTotal = Math.max(0, total - window._voucherValid.diskon);
    // Tandai voucher sudah dipakai
    await db.from('dm_vouchers').update({status:'used', used_by: currentUser.id}).eq('id', window._voucherValid.id);
    window._voucherValid = null;
  }

  showLoading(true);
  await db.from('dm_pesanan').insert({
    produk_id: p.id, buyer_id: currentUser.id,
    seller_id: p.seller_id, harga: finalTotal, qty, status: 'menunggu-konfirmasi',
    created_at: Date.now(), kode, payment: selectedPayment, bukti_transfer: bukti || null
  });
  await db.from('dm_produk').update({
    terjual: p.terjual + qty, stok: Math.max(0, p.stok - qty)
  }).eq('id', p.id);
  await Promise.all([fetchPesanan(), fetchProduk()]);
  showLoading(false);
  showToast('üéâ Pembelian berhasil! Cek Profil > Pesanan');
  checkoutQty = 1;
}

function showBuktiModal(src) {
  if (!src) return;
  document.getElementById('bukti-modal-img').src = src;
  document.getElementById('bukti-modal').classList.add('open');
}

// Event delegation untuk bukti transfer images
document.addEventListener('click', function(e) {
  if (e.target && e.target.id && e.target.id.startsWith('bukti-img-')) {
    showBuktiModal(e.target.src);
  }
});
function closeBuktiModal() {
  document.getElementById('bukti-modal').classList.remove('open');
}

// =================== STARTUP ===================
async function startup() {
  showLoading(true);
  await initData();
  renderNavbar();
  renderProdukGrid();
  renderHeroStats();
}

startup();
</script>
</body>
</html>
